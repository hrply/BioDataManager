# BioData Manager 综合修订计划 v8

## 修订日期: 2026-01-23

## 核心测试方法

### 文件夹生成验证方法

**原始数据目录** `/bio/rawdata/` **统计命令**：
```bash
docker exec biodata-manager bash -c '
echo "=== /bio/rawdata 目录结构统计 ==="
echo ""
echo "一级目录（数据类型缩写）:"
ls -la /bio/rawdata/ | grep "^d" | awk "{print \$9, \$5}"

echo ""
echo "二级目录（物种缩写）:"
find /bio/rawdata -mindepth 2 -maxdepth 2 -type d | sort

echo ""
echo "三级目录（组织来源缩写）:"
find /bio/rawdata -mindepth 3 -maxdepth 3 -type d | sort

echo ""
echo "四级目录（项目ID）:"
find /bio/rawdata -mindepth 4 -maxdepth 4 -type d | sort

echo ""
echo "文件位置验证:"
find /bio/rawdata -name "*.fastq" -o -name "*.fq" | head -20
'
```

**结果数据目录** `/bio/results/` **统计命令**：
```bash
docker exec biodata-manager bash -c '
echo "=== /bio/results 目录结构统计 ==="
echo ""
echo "一级目录（分析类型缩写）:"
ls -la /bio/results/ | grep "^d" | awk "{print \$9, \$5}"

echo ""
echo "二级目录（项目ID）:"
find /bio/results -mindepth 2 -maxdepth 2 -type d | sort

echo ""
echo "文件位置验证:"
find /bio/results -type f | head -20
'
```

---

## 测试计划

### 第一阶段：环境准备

#### 1.1 清理测试环境
```bash
# 停止容器
cd /home/hrply/software/bioscience/research/biodata_manager && docker compose down

# 删除 MySQL volume（重置数据）
docker volume rm biodata_manager-mysql-data

# 重新启动
docker compose up -d

# 等待服务就绪
sleep 10
```

#### 1.2 创建测试文件
```bash
# 创建测试用文件
cd /home/hrply/software/bioscience/research/biodata_manager/data/downloads/test_import
echo "测试数据1" > test_raw_001.fastq
echo "测试数据2" > test_raw_002.fastq
echo "测试结果1" > test_res_001.txt
echo "测试结果2" > test_res_002.txt
```

---

### 第二阶段：问题诊断测试

#### 2.1 检查导入模态框可编辑字段
```bash
# 获取 raw 字段配置
curl -s 'http://localhost:20425/api/metadata/fields?table=raw' > /tmp/raw_fields.json

# 获取 result 字段配置
curl -s 'http://localhost:20425/api/metadata/fields?table=result' > /tmp/result_fields.json

# 检查显示字段配置
echo "=== raw 显示字段 ==="
docker exec biodata-manager env | grep METADATA_FIELDS
```

**检查点**：
- [ ] 确认 `METADATA_FIELDS_NEW_RAW` 包含的字段
- [ ] 确认 `METADATA_FIELDS_EXIST_RAW` 包含的字段
- [ ] 确认字段的 `field_readonly` 属性

#### 2.2 检查 abbr_mapping 完整性
```bash
docker exec biodata-manager python3 -c "
from database_mysql import DatabaseManager
db = DatabaseManager()

print('=== abbr_mapping 表统计 ===')
results = db.query('SELECT field_id, COUNT(*) FROM abbr_mapping GROUP BY field_id')
for row in results:
    print(f'{row[0]}: {row[1]} 条映射')

print()
print('=== field_config 可选项字段 ===')
results = db.query('SELECT field_id, field_name FROM field_config WHERE field_type IN (\"select\", \"multiselect\")')
for row in results:
    print(f'{row[0]}: {row[1]}')
"
```

**检查点**：
- [ ] `raw_type` 有完整映射
- [ ] `raw_species` 有完整映射
- [ ] `raw_tissue` 有完整映射
- [ ] `results_type` 有完整映射

---

### 第三阶段：导入功能测试

#### 3.1 新建项目导入原始数据

**请求**：
```bash
curl -s -X POST 'http://localhost:20425/api/import-download' \
  -H 'Content-Type: application/json' \
  -d '{
    "project_id": "TEST_RAW_001",
    "project_info": {
      "raw_title": "测试原始数据-新建项目",
      "raw_type": "mRNAseq",
      "raw_species": "Mus musculus",
      "raw_tissue": "Liver,Heart muscle"
    },
    "files": ["test_raw_001.fastq", "test_raw_002.fastq"],
    "folder_name": "test_import",
    "data_type": "raw"
  }'
```

**验证**：
```bash
# 统计原始数据目录
docker exec biodata-manager bash -c '
echo "=== 导入后 /bio/rawdata 统计 ==="
find /bio/rawdata -type d | wc -l

echo ""
echo "项目文件夹位置:"
find /bio/rawdata -name "TEST_RAW_001" -type d

echo ""
echo "文件位置:"
find /bio/rawdata -name "*.fastq" | grep TEST_RAW_001
'
```

**检查清单**：
| 检查项 | 预期 | 判定 |
|-------|------|------|
| 文件夹数量 | 4 (mRseq/Ms/Liv/TEST_RAW_001) | ✅/❌ |
| 文件数量 | 2 | ✅/❌ |
| 路径正确 | rawdata/mRseq/Ms/Liv/TEST_RAW_001 | ✅/❌ |
| 无 UNK 文件夹 | 是 | ✅/❌ |
| 无空文件夹 | 是 | ✅/❌ |

#### 3.2 新建项目导入结果数据

**请求**：
```bash
curl -s -X POST 'http://localhost:20425/api/import-download' \
  -H 'Content-Type: application/json' \
  -d '{
    "project_id": "TEST_RES_001",
    "project_info": {
      "results_title": "测试结果数据-新建项目",
      "results_type": "Marker",
      "results_raw": "TEST_RAW_001"
    },
    "files": ["test_res_001.txt"],
    "folder_name": "test_import",
    "data_type": "result"
  }'
```

**验证**：
```bash
# 统计结果数据目录
docker exec biodata-manager bash -c '
echo "=== 导入后 /bio/results 统计 ==="
find /bio/results -type d | wc -l

echo ""
echo "项目文件夹位置:"
find /bio/results -name "TEST_RES_001" -type d

echo ""
echo "文件位置:"
find /bio/results -type f | grep TEST_RES_001
'
```

**检查清单**：
| 检查项 | 预期 | 判定 |
|-------|------|------|
| 文件夹数量 | 2 (Mar/TEST_RES_001) | ✅/❌ |
| 文件数量 | 1 | ✅/❌ |
| 路径正确 | results/Mar/TEST_RES_001 | ✅/❌ |
| 无 UNK 文件夹 | 是 | ✅/❌ |
| 无空文件夹 | 是 | ✅/❌ |

#### 3.3 导入至已有原始数据项目

**请求**：
```bash
curl -s -X POST 'http://localhost:20425/api/import-download' \
  -H 'Content-Type: application/json' \
  -d '{
    "project_id": "TEST_RAW_001",
    "metadata_override": {
      "raw_tissue": "Pancreas,Stomach"
    },
    "files": ["test_raw_001.fastq"],
    "folder_name": "test_import",
    "data_type": "raw"
  }'
```

**验证**：
```bash
# 检查是否有重复文件夹
docker exec biodata-manager bash -c '
echo "=== 导入后 /bio/rawdata 统计 ==="
echo "总文件夹数:"
find /bio/rawdata -type d | wc -l

echo ""
echo "TEST_RAW_001 文件夹位置:"
find /bio/rawdata -name "TEST_RAW_001" -type d

echo ""
echo "验证文件位置:"
find /bio/rawdata -name "test_raw_001.fastq"
'
```

**检查清单**：
| 检查项 | 预期 | 判定 |
|-------|------|------|
| 文件夹总数 | 不变（4个） | ✅/❌ |
| 重复文件夹 | 无 | ✅/❌ |
| 新增空文件夹 | 无 | ✅/❌ |
| raw_tissue 字段 | Liver,Heart muscle,Pancreas,Stomach | ✅/❌ |

#### 3.4 导入至已有结果数据项目

**请求**：
```bash
curl -s -X POST 'http://localhost:20425/api/import-download' \
  -H 'Content-Type: application/json' \
  -d '{
    "project_id": "TEST_RES_001",
    "metadata_override": {
      "results_raw": "TEST_RAW_001"
    },
    "files": ["test_res_002.txt"],
    "folder_name": "test_import",
    "data_type": "result"
  }'
```

**验证**：
```bash
docker exec biodata-manager bash -c '
echo "=== 导入后 /bio/results 统计 ==="
echo "总文件夹数:"
find /bio/results -type d | wc -l

echo ""
echo "TEST_RES_001 文件夹位置:"
find /bio/results -name "TEST_RES_001" -type d
'
```

**检查清单**：
| 检查项 | 预期 | 判定 |
|-------|------|------|
| 文件夹总数 | 不变（2个） | ✅/❌ |
| 重复文件夹 | 无 | ✅/❌ |
| results_raw 字段 | TEST_RAW_001 | ✅/❌ |

---

### 第四阶段：file_property 验证

#### 4.1 检查 file_record 数据
```bash
docker exec biodata-manager python3 -c "
from database_mysql import DatabaseManager
db = DatabaseManager()

print('=== file_record 数据验证 ===')
results = db.query('SELECT file_project_id, file_name, file_path, file_property FROM file_record ORDER BY file_project_id')
for row in results:
    print(f'项目: {row[0]}')
    print(f'  文件: {row[1]}')
    print(f'  file_path: {row[2]}')
    print(f'  file_property: {row[3]}')
    print()
"
```

**检查清单**：
| 检查项 | 预期 | 判定 |
|-------|------|------|
| file_path 使用缩写 | rawdata/mRseq/Ms/Liv/... | ✅/❌ |
| file_property 使用 label | 转录组-小鼠-Liver,Heart muscle | ✅/❌ |
| 无 UNK 路径 | 是 | ✅/❌ |

#### 4.2 关联项目排序测试
```bash
# 创建测试项目
curl -s -X POST 'http://localhost:20425/api/import-download' \
  -H 'Content-Type: application/json' \
  -d '{
    "project_id": "TEST_SORT_001",
    "project_info": {
      "results_title": "排序测试",
      "results_type": "Marker",
      "results_raw": "RAW_a8,RAW_A1,RAW_2B"
    },
    "files": ["test_res_001.txt"],
    "folder_name": "test_import",
    "data_type": "result"
  }'

# 验证 file_property
docker exec biodata-manager python3 -c "
from database_mysql import DatabaseManager
db = DatabaseManager()
result = db.query('SELECT file_property FROM file_record WHERE file_project_id = %s', ('TEST_SORT_001',))
print('file_property:', result[0][0] if result else 'Not found')
"
```

**预期结果**：
- file_property = `Marker-RAW_2BRAW_a8RAW_A1`

**判定**：✅/❌

---

### 第五阶段：全目录统计验证

#### 5.1 最终原始数据目录统计
```bash
docker exec biodata-manager bash -c '
echo "=========================================="
echo "  /bio/rawdata 全目录统计"
echo "=========================================="

echo ""
echo "【一级目录（数据类型缩写）】"
ls -la /bio/rawdata/ | grep "^d" | grep -v "^\." | awk "{printf \"  %-20s %s\n\", \$9, \$5}"

echo ""
echo "【二级目录（物种缩写）】"
find /bio/rawdata -mindepth 2 -maxdepth 2 -type d | sed "s|/bio/rawdata/||" | sort

echo ""
echo "【三级目录（组织来源缩写）】"
find /bio/rawdata -mindepth 3 -maxdepth 3 -type d | sed "s|/bio/rawdata/||" | sort

echo ""
echo "【四级目录（项目ID）】"
find /bio/rawdata -mindepth 4 -maxdepth 4 -type d | sed "s|/bio/rawdata/||" | sort

echo ""
echo "【空文件夹检查】"
find /bio/rawdata -empty -type d | sed "s|/bio/rawdata/||" | grep -v "^$" || echo "  无空文件夹"

echo ""
echo "【UNK 文件夹检查】"
find /bio/rawdata -type d -name "*UNK*" | sed "s|/bio/rawdata/||" || echo "  无 UNK 文件夹"

echo ""
echo "【重复项目ID检查】"
find /bio/rawdata -mindepth 4 -maxdepth 4 -type d -exec basename {} \; | sort | uniq -c | awk "\$1 > 1 {print \"  重复: \" \$2}"
'
```

**检查清单**：
| 检查项 | 结果 |
|-------|------|
| 一级目录数量 | ___ |
| 二级目录数量 | ___ |
| 三级目录数量 | ___ |
| 四级目录数量 | ___ |
| 空文件夹 | 有/无 |
| UNK 文件夹 | 有/无 |
| 重复项目ID | 有/无 |

#### 5.2 最终结果数据目录统计
```bash
docker exec biodata-manager bash -c '
echo "=========================================="
echo "  /bio/results 全目录统计"
echo "=========================================="

echo ""
echo "【一级目录（分析类型缩写）】"
ls -la /bio/results/ | grep "^d" | grep -v "^\." | awk "{printf \"  %-20s %s\n\", \$9, \$5}"

echo ""
echo "【二级目录（项目ID）】"
find /bio/results -mindepth 2 -maxdepth 2 -type d | sed "s|/bio/results/||" | sort

echo ""
echo "【空文件夹检查】"
find /bio/results -empty -type d | sed "s|/bio/results/||" | grep -v "^$" || echo "  无空文件夹"

echo ""
echo "【UNK 文件夹检查】"
find /bio/results -type d -name "*UNK*" | sed "s|/bio/results/||" || echo "  无 UNK 文件夹"
'
```

**检查清单**：
| 检查项 | 结果 |
|-------|------|
| 一级目录数量 | ___ |
| 二级目录数量 | ___ |
| 空文件夹 | 有/无 |
| UNK 文件夹 | 有/无 |

---

## 执行顺序

| 顺序 | 阶段 | 任务 | 状态 |
|-----|------|------|------|
| 1 | 准备 | 清理环境、重置数据库 | 待执行 |
| 2 | 准备 | 创建测试文件 | 待执行 |
| 3 | 诊断 | 检查可编辑字段 | 待执行 |
| 4 | 诊断 | 检查 abbr_mapping | 待执行 |
| 5 | 测试 | 新建原始数据导入 | 待执行 |
| 6 | 测试 | 新建结果数据导入 | 待执行 |
| 7 | 测试 | 导入至已有原始数据 | 待执行 |
| 8 | 测试 | 导入至已有结果数据 | 待执行 |
| 9 | 验证 | file_property 格式 | 待执行 |
| 10 | 验证 | 全目录统计 | 待执行 |

---

## 判定标准

### 合格标准
1. **无 UNK 文件夹**：任何路径中不包含 "UNK"
2. **无重复文件夹**：同一项目ID只在一个路径出现
3. **无空文件夹**：所有文件夹都包含文件
4. **路径正确**：使用缩写（mRseq, Hs, Liv）
5. **属性正确**：file_property 使用 label 格式

### 不合格标准
- [ ] 存在 UNK 文件夹
- [ ] 存在重复文件夹
- [ ] 存在空文件夹
- [ ] file_path 未使用缩写
- [ ] file_property 未使用 label

---

## 修订历史

| 版本 | 日期 | 内容 |
|-----|------|------|
| v7 | 2026-01-23 | 初始计划 |
| v8 | 2026-01-23 | 强化全目录统计验证，强调无空文件夹、无UNK、无重复 |
