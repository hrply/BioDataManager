# BioData Manager 动态渲染修改计划

## 一、概述

### 1.1 目标
将前后端代码从硬编码改为动态数据驱动，根据 `field_config` 表的配置动态渲染所有表单、列表和筛选器。

### 1.2 数据库规范版本
基于 `docs/数据库设计规范.md` v2.0

---

## 二、数据库层修改

### 2.1 新表结构

| 表名 | 中文名 | 说明 |
|------|--------|------|
| `field_config` | 元数据字段配置表 | 定义所有元数据字段 |
| `raw_project` | 原始数据项目表 | 存储原始数据项目信息 |
| `result_project` | 结果数据项目表 | 存储结果数据项目信息 |
| `file_record` | 文件记录表 | 存储文件导入记录 |
| `select_options` | 下拉选项表 | 存储单选/多选字段的选项 |
| `abbr_mapping` | 缩写映射表 | 存储字段值的全称与缩写对应关系 |

### 2.2 待删除旧表
- `projects` (旧项目表)
- `files` (旧文件表)
- `bioresult_projects` (旧结果项目表)
- `processed_files` (旧处理文件表)
- `metadata_config` (旧字段配置表)
- `tags` (旧标签表)

### 2.3 初始化数据
按照数据库设计规范初始化：
- field_config 字段配置
- select_options 下拉选项
- abbr_mapping 缩写映射

---

## 三、各页面动态渲染规则

### 3.1 原始数据管理页面 (/raw-data)

#### 3.1.1 筛选条件区域
**规则**：展示 raw 表中 `field_seq = 1, 2, 3` 的字段

**字段来源**：
```sql
SELECT * FROM field_config
WHERE field_table = 'raw' AND field_seq BETWEEN 1 AND 3
ORDER BY field_seq ASC
```

**渲染顺序**：按 field_seq 从小到大

**示例字段**（默认值）：
- field_seq=1: 数据类型 (select)
- field_seq=2: 物种 (select)
- field_seq=3: 组织来源 (multi_select)

#### 3.1.2 项目列表表格
**规则**：列标题从左到右为 raw 表中 `field_seq = 0, 1, 2, 3` 的字段，加上"创建时间"和"操作"列

**列顺序**：
| 序号 | 列名 | 来源 | 说明 |
|------|------|------|------|
| 1 | 原始数据字段0 | field_seq=0 | raw_title |
| 2 | 原始数据字段1 | field_seq=1 | raw_type |
| 3 | 原始数据字段2 | field_seq=2 | raw_species |
| 4 | 原始数据字段3 | field_seq=3 | raw_tissue |
| 5 | 创建时间 | 硬编码 | created_at |
| 6 | 操作 | 硬编码 | 查看/编辑按钮 |

**SQL 查询**：
```sql
SELECT raw_id, raw_title, raw_type, raw_species, raw_tissue, created_at
FROM raw_project
ORDER BY created_at DESC
```

---

### 3.2 结果管理页面 (/results)

#### 3.2.1 筛选条件区域
**规则**：展示 result 表中 `field_seq = 1, 2` 的字段

**字段来源**：
```sql
SELECT * FROM field_config
WHERE field_table = 'result' AND field_seq BETWEEN 1 AND 2
ORDER BY field_seq ASC
```

**示例字段**（默认值）：
- field_seq=1: 结果类型 (select)
- field_seq=2: 关联原始项目 (select)

#### 3.2.2 结果列表表格
**规则**：列标题为 result 表中 `field_seq = 0, 1, 2, 3` 的字段，加上"创建时间"和"操作"列

**列顺序**：
| 序号 | 列名 | 来源 | 说明 |
|------|------|------|------|
| 1 | 结果字段0 | field_seq=0 | results_title |
| 2 | 结果字段1 | field_seq=1 | results_type |
| 3 | 结果字段2 | field_seq=2 | results_raw |
| 4 | 结果字段3 | field_seq=3 | (预留) |
| 5 | 创建时间 | 硬编码 | created_at |
| 6 | 操作 | 硬编码 | 查看/编辑按钮 |

---

### 3.3 项目表单页面（新建/编辑/查看详情弹窗）

#### 3.3.1 通用规则

**1. 排列顺序**：
- 首先按 `field_placeholder` 分组：
  - `field_placeholder = 2` 的字段排在前（两列布局）
  - `field_placeholder = 1` 的字段排在后（单列布局）
- 同组内按 `field_seq` 从小到大排列

**2. 布局规则**：
| placeholder 值 | 布局 | 说明 |
|---------------|------|------|
| 2 | 两列排列 | 每行显示两个字段 |
| 1 | 单列排列 | 每行显示一个字段 |

**3. 项目编号字段**：
- `raw_id` / `results_id` 固定为第一个字段
- 单列布局，最上方显示

#### 3.3.2 原始数据项目表单（raw）

**字段来源**：
```sql
SELECT * FROM field_config
WHERE field_table = 'raw'
ORDER BY field_placeholder DESC, field_seq ASC
```

**布局示例**：
```
[项目编号] [生成按钮]        ← 单列

[数据类型] [物种]            ← 两列 (placeholder=2, seq=1,2)
[DOI] [数据库编号]           ← 两列 (placeholder=2, seq=4,5)
[作者] [文章标题]            ← 两列 (placeholder=2, seq=7,8)

[组织来源]                   ← 单列 (placeholder=1, seq=3)
[描述]                       ← 单列 (placeholder=1, seq=9)
[关键词]                     ← 单列 (placeholder=1, seq=10)
```

#### 3.3.3 结果数据项目表单（result）

**字段来源**：
```sql
SELECT * FROM field_config
WHERE field_table = 'result'
ORDER BY field_placeholder DESC, field_seq ASC
```

**布局示例**：
```
[项目编号] [生成按钮]        ← 单列

[结果类型] [关联原始项目]     ← 两列 (placeholder=2, seq=1,2)

[描述]                       ← 单列 (placeholder=1, seq=3)
[关键词]                     ← 单列 (placeholder=1, seq=4)
```

---

### 3.4 文件管理页面 (/files)

#### 3.4.1 管理标签页

**规则**：根据筛选条件（原始数据/结果数据），展示对应表的 field_seq 0~3 字段

**动态列规则**：
| 筛选类型 | 展示字段 | 说明 |
|---------|---------|------|
| 原始数据 | raw_seq 0~3 | raw_title, raw_type, raw_species, raw_tissue |
| 结果数据 | result_seq 0~3 | results_title, results_type, results_raw, results_seq3 |

**完整列标题**：
| 序号 | 列名 | 说明 |
|------|------|------|
| 1 | 字段0 | 动态 (项目名称) |
| 2 | 字段1 | 动态 (类型) |
| 3 | 字段2 | 动态 (物种/关联) |
| 4 | 字段3 | 动态 (组织/预留) |
| 5 | 文件数 | 硬编码 |
| 6 | 操作 | 硬编码 |

#### 3.4.2 导入标签页

**规则**：根据数据类型（原始数据/结果数据），动态展示对应表的字段

**原始数据导入**：
- 字段范围：`field_seq = 0 ~ 5`
- 布局：全部两列排列 (`field_placeholder = 2`)

**字段列表**：
| 序号 | 字段名 | 类型 |
|------|--------|------|
| 0 | raw_title | text |
| 1 | raw_type | select |
| 2 | raw_species | select |
| 3 | raw_tissue | multi_select |
| 4 | raw_DOI | text |
| 5 | raw_db_id | text |

**结果数据导入**：
- 字段范围：`field_seq = 0 ~ 3`
- 布局：全部两列排列 (`field_placeholder = 2`)

**字段列表**：
| 序号 | 字段名 | 类型 |
|------|--------|------|
| 0 | results_title | text |
| 1 | results_type | select |
| 2 | results_raw | select |
| 3 | results_description | textarea |

**注意**：无论是"新建项目导入"还是"选择已有项目导入"，字段配置相同。

---

## 四、API 设计

### 4.1 字段配置相关

#### 4.1.1 获取字段配置
```
GET /api/fields
GET /api/fields?table=raw
GET /api/fields?table=result
GET /api/fields?table=raw&seq_min=0&seq_max=3
```

**响应**：
```json
{
  "success": true,
  "fields": [
    {
      "id": 1,
      "field_id": "raw_title",
      "field_name": "项目名称",
      "field_type": "text",
      "field_table": "raw",
      "field_necessary": true,
      "field_options": null,
      "field_seq": 0,
      "field_placeholder": 1,
      "field_default": null,
      "field_placeholder_text": null
    },
    {
      "id": 2,
      "field_id": "raw_type",
      "field_name": "数据类型",
      "field_type": "select",
      "field_table": "raw",
      "field_necessary": true,
      "field_options": {"options": [...]},
      "field_seq": 1,
      "field_placeholder": 2,
      "field_default": null,
      "field_placeholder_text": null
    }
  ]
}
```

### 4.2 选项相关

#### 4.2.1 获取下拉选项
```
GET /api/options?type=raw_type
GET /api/options?type=raw_species
```

**响应**：
```json
{
  "success": true,
  "options": [
    {"value": "rnaseq", "label": "转录组 (RNA-Seq)"},
    {"value": "singlecell", "label": "单细胞转录组 (Single-cell)"}
  ]
}
```

### 4.3 项目相关

#### 4.3.1 动态查询项目
```
GET /api/projects
GET /api/projects?table=raw
GET /api/projects?table=result
GET /api/projects?table=raw&filters={"raw_type":"rnaseq","raw_species":"Hs"}&page=1&limit=20
```

**响应**：
```json
{
  "success": true,
  "data": [
    {
      "raw_id": "RAW-A1B2C3D4",
      "raw_title": "示例项目",
      "raw_type": "rnaseq",
      "raw_species": "Hs",
      "file_count": 5,
      "created_at": "2026-01-17 10:00:00"
    }
  ],
  "total": 100,
  "page": 1,
  "limit": 20
}
```

#### 4.3.2 获取选项（关联项目）
```
GET /api/projects/options?table=raw
```

**响应**：
```json
{
  "success": true,
  "options": [
    {"value": "RAW-A1B2C3D4", "label": "示例项目"}
  ]
}
```

---

## 五、修改文件清单

### 5.1 数据库层
| 文件 | 操作 | 说明 |
|------|------|------|
| `app/database_mysql.py` | 重写 | create_tables 方法按新规范创建表 |
| `app/init_db.py` | 重写 | 初始化 field_config、select_options、abbr_mapping |
| `app/metadata_config_manager_mysql.py` | 删除 | 旧版元数据管理器，已不适用 |
| `app/field_config_manager_mysql.py` | 新建 | 新的字段配置管理器 |

### 5.2 后端 API
| 文件 | 操作 | 说明 |
|------|------|------|
| `app/server.py` | 修改 | 重写项目相关 API，添加动态查询 |

### 5.3 前端页面
| 文件 | 操作 | 说明 |
|------|------|------|
| `app/templates/raw_data.html` | 修改 | 筛选器和列表改为动态渲染 |
| `app/templates/results.html` | 修改 | 筛选器和列表改为动态渲染 |
| `app/templates/files.html` | 修改 | 管理和导入页面改为动态渲染 |
| `app/templates/metadata.html` | 修改 | 字段配置管理页面 |

---

## 六、实施步骤

### Step 1: 数据库层重写
- [ ] 重写 `database_mysql.py` 的 `create_tables` 方法
- [ ] 删除旧表，创建新表（6张表）
- [ ] 重写 `init_db.py` 初始化数据
- [ ] 创建 `field_config_manager_mysql.py`

### Step 2: 后端 API 改造
- [ ] 重写 `/api/projects` 添加动态查询参数
- [ ] 新增 `/api/fields` 端点
- [ ] 新增 `/api/options` 端点
- [ ] 新增 `/api/projects/options` 端点
- [ ] 更新项目 CRUD API

### Step 3: 前端改造
- [ ] 改造 `raw_data.html`：筛选器动态渲染
- [ ] 改造 `raw_data.html`：项目列表动态列
- [ ] 改造 `results.html`：筛选器动态渲染
- [ ] 改造 `results.html`：结果列表动态列
- [ ] 改造 `files.html`：管理页面动态列
- [ ] 改造 `files.html`：导入页面动态字段
- [ ] 改造 `metadata.html`：字段配置管理

### Step 4: 测试验证
- [ ] 数据库初始化测试
- [ ] API 接口测试
- [ ] 前端渲染测试
- [ ] 功能完整性测试

---

## 七、注意事项

### 7.1 字段命名规范
- 前端字段 ID：`metadata-{field_id}` 格式
- 后端数据键：`field_id` 直接作为键名

### 7.2 兼容性
- 重建数据库会清除所有现有数据
- 需要在生产环境使用前充分测试

### 7.3 扩展性
- 新增字段只需在 `field_config` 表添加记录
- 无需修改前后端代码

---

**文档版本**: 1.0  
**创建时间**: 2026-01-17  
**状态**: 待确认执行
