# BioData Manager 数据库设计规范

## 一、数据库概览

BioData Manager 使用 MySQL 8.x 数据库，包含以下核心数据表：

| 表名 | 中文名 | 说明 |
|------|--------|------|
| `field_config` | 元数据字段配置表 | 定义所有元数据字段 |
| `raw_project` | 原始数据项目表 | 存储原始数据项目信息 |
| `result_project` | 结果数据项目表 | 存储结果数据项目信息 |
| `file_record` | 文件记录表 | 存储文件导入记录 |
| `select_options` | 下拉选项表 | 存储单选/多选字段的选项 |
| `abbr_mapping` | 缩写映射表 | 存储字段值的全称与缩写对应关系 |

---

## 二、表结构详细设计

### 2.1 元数据字段配置表 (field_config)

**用途**: 定义所有元数据字段的配置，供前端动态生成表单和筛选器

```sql
CREATE TABLE field_config (
    id              INT PRIMARY KEY AUTO_INCREMENT COMMENT '字段配置ID',
    field_id        VARCHAR(50) NOT NULL UNIQUE COMMENT '字段标识符(英文)',
    field_name      VARCHAR(100) NOT NULL COMMENT '字段中文名称',
    field_type      ENUM('text', 'textarea', 'select', 'multi_select') NOT NULL COMMENT '字段类型',
    field_table     ENUM('raw', 'result', 'file') NOT NULL COMMENT '所属项目类型',
    field_necessary TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否必填(0:否, 1:是)',
    field_options   JSON COMMENT '选项配置(JSON数组，select/multi_select类型使用)',
    field_seq       INT NOT NULL DEFAULT 0 COMMENT '排序序号',
    field_default   VARCHAR(255) DEFAULT NULL COMMENT '默认值',
    field_placeholder VARCHAR(255) DEFAULT NULL COMMENT '占位提示文字',
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at      DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_field_table (field_table),
    INDEX idx_field_seq (field_seq)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='元数据字段配置表';
```

#### field_type 枚举值说明

| 值 | 说明 | 前端组件 |
|---|------|----------|
| `text` | 单行文本 | `<input type="text">` |
| `textarea` | 多行文本 | `<textarea>` |
| `select` | 单选下拉 | `<select>` |
| `multi_select` | 多选下拉 | `<select multiple>` |

#### field_options JSON 结构示例

```json
// select 类型
{
  "options": [
    {"value": "rnaseq", "label": "转录组 (RNA-Seq)"},
    {"value": "singlecell", "label": "单细胞转录组"},
    {"value": "proteomics", "label": "蛋白组学"}
  ]
}

// multi_select 类型
{
  "options": [
    {"value": "public", "label": "公开数据"},
    {"value": "controlled", "label": "受控访问"},
    {"value": "raw", "label": "原始数据"}
  ]
}
```

---

### 2.2 原始数据项目表 (raw_project)

**用途**: 存储原始数据项目的基本信息和元数据

```sql
CREATE TABLE raw_project (
    id                  INT PRIMARY KEY AUTO_INCREMENT COMMENT '自增ID',
    raw_id              VARCHAR(50) NOT NULL UNIQUE COMMENT '项目编号(格式: RAW-{UUID})',
    raw_title           VARCHAR(255) NOT NULL COMMENT '项目名称',
    raw_type            VARCHAR(50) NOT NULL COMMENT '数据类型(存储选项value值)',
    raw_species         VARCHAR(50) NOT NULL COMMENT '物种',
    raw_tissue          VARCHAR(255) DEFAULT NULL COMMENT '组织来源(多选逗号分隔)',
    raw_DOI             VARCHAR(100) DEFAULT NULL COMMENT 'DOI号',
    raw_db_id           VARCHAR(100) DEFAULT NULL COMMENT '数据库编号',
    raw_db_link         VARCHAR(500) DEFAULT NULL COMMENT '数据库链接',
    raw_author          VARCHAR(500) DEFAULT NULL COMMENT '作者(多人逗号分隔)',
    raw_article         VARCHAR(500) DEFAULT NULL COMMENT '文章标题',
    raw_description     TEXT DEFAULT NULL COMMENT '项目描述',
    raw_keywords        VARCHAR(500) DEFAULT NULL COMMENT '关键词(逗号分隔)',
    file_count          INT DEFAULT 0 COMMENT '关联文件数量',
    total_size          BIGINT DEFAULT 0 COMMENT '文件总大小(字节)',
    created_by          VARCHAR(50) DEFAULT 'system' COMMENT '创建者',
    created_at          DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at          DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_raw_id (raw_id),
    INDEX idx_raw_type (raw_type),
    INDEX idx_raw_species (raw_species),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='原始数据项目表';
```

#### raw_id 生成规则

```
格式: RAW-{8位UUID}
示例: RAW-A1b2C3d4

UUID规则:
- 8位字符
- 数字 0-9
- 大写字母 A-Z
- 小写字母 a-z
```

#### 字段存储值说明

| 字段 | 存储值类型 | 示例 |
|------|-----------|------|
| raw_type | 选项 value | "rnaseq" |
| raw_species | 选项 value | "Homo sapiens" |
| raw_tissue | 多选逗号分隔 | "tumor,primary" |
| raw_keywords | 逗号分隔 | "RNA-Seq,肿瘤,转录组" |

---

### 2.3 结果数据项目表 (result_project)

**用途**: 存储结果数据项目的信息

```sql
CREATE TABLE result_project (
    id                  INT PRIMARY KEY AUTO_INCREMENT COMMENT '自增ID',
    results_id          VARCHAR(50) NOT NULL UNIQUE COMMENT '项目编号(格式: RES-{UUID})',
    results_title       VARCHAR(255) NOT NULL COMMENT '项目名称',
    results_type        VARCHAR(50) NOT NULL COMMENT '结果类型',
    results_raw         VARCHAR(50) DEFAULT NULL COMMENT '关联原始数据项目编号',
    results_description TEXT DEFAULT NULL COMMENT '项目描述',
    results_keywords    VARCHAR(500) DEFAULT NULL COMMENT '关键词',
    file_count          INT DEFAULT 0 COMMENT '关联文件数量',
    total_size          BIGINT DEFAULT 0 COMMENT '文件总大小(字节)',
    created_by          VARCHAR(50) DEFAULT 'system' COMMENT '创建者',
    created_at          DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at          DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_results_id (results_id),
    INDEX idx_results_type (results_type),
    INDEX idx_results_raw (results_raw),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='结果数据项目表';
```

---

### 2.4 文件记录表 (file_record)

**用途**: 存储导入文件的信息和归属关系

```sql
CREATE TABLE file_record (
    id              INT PRIMARY KEY AUTO_INCREMENT COMMENT '自增ID',
    file_name       VARCHAR(255) NOT NULL COMMENT '文件名',
    file_path       VARCHAR(500) NOT NULL COMMENT '文件相对路径(相对于/bioraw)',
    file_size       BIGINT NOT NULL COMMENT '文件大小(字节)',
    file_type       VARCHAR(50) DEFAULT NULL COMMENT '文件类型扩展名',
    project_type    ENUM('raw', 'result') NOT NULL COMMENT '所属项目类型',
    project_id      VARCHAR(50) NOT NULL COMMENT '所属项目编号',
    imported_at     DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '导入时间',
    imported_by     VARCHAR(50) DEFAULT 'system' COMMENT '导入者',
    INDEX idx_project (project_type, project_id),
    INDEX idx_file_path (file_path),
    INDEX idx_imported_at (imported_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文件记录表';
```

#### file_path 存储规则

```
相对于 /bioraw 目录存储

示例:
实际路径: /bioraw/rawdata/rnaseq/Homo sapiens/RAW-A1B2C3D4/sample1.fastq.gz
存储值: rawdata/rnaseq/Homo sapiens/RAW-A1B2C3D4/sample1.fastq.gz
```

---

### 2.5 下拉选项表 (select_options)

**用途**: 存储单选/多选字段的选项列表

```sql
CREATE TABLE select_options (
    id              INT PRIMARY KEY AUTO_INCREMENT COMMENT '自增ID',
    option_type     VARCHAR(50) NOT NULL COMMENT '选项类型(对应field_id)',
    option_value    VARCHAR(100) NOT NULL COMMENT '选项值(value)',
    option_label    VARCHAR(255) NOT NULL COMMENT '选项标签(label)',
    option_group    VARCHAR(50) DEFAULT NULL COMMENT '选项分组(可选)',
    option_seq      INT DEFAULT 0 COMMENT '排序序号',
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    UNIQUE KEY uk_type_value (option_type, option_value),
    INDEX idx_option_type (option_type),
    INDEX idx_option_seq (option_seq)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='下拉选项表';
```

#### 数据关系

```
field_config.field_id → select_options.option_type
```

#### 示例数据

```sql
-- 数据类型选项
INSERT INTO select_options (option_type, option_value, option_label, option_seq) VALUES
('raw_type', 'rnaseq', '转录组 (RNA-Seq)', 1),
('raw_type', 'singlecell', '单细胞转录组 (Single-cell)', 2),
('raw_type', 'proteomics', '蛋白组 (Proteomics)', 3);

-- 物种选项
INSERT INTO select_options (option_type, option_value, option_label, option_seq) VALUES
('raw_species', 'Homo sapiens', '人类 (Homo sapiens)', 1),
('raw_species', 'Mus musculus', '小鼠 (Mus musculus)', 2);
```

---

### 2.6 缩写映射表 (abbr_mapping)

**用途**: 存储字段值的全称与缩写对应关系，用于文件导入时生成目录结构。通过 `field_id` 字段区分不同字段类型的缩写，所有缩写在同一张表管理。

```sql
CREATE TABLE abbr_mapping (
    id              INT PRIMARY KEY AUTO_INCREMENT COMMENT '自增ID',
    field_id        VARCHAR(50) NOT NULL COMMENT '字段标识符(对应field_config.field_id)',
    full_name       VARCHAR(100) NOT NULL COMMENT '全称(选项的完整名称)',
    abbr_name       VARCHAR(20) NOT NULL COMMENT '缩写(用于文件路径)',
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    UNIQUE KEY uk_field_full (field_id, full_name),
    INDEX idx_field_id (field_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='缩写映射表';
```

#### 数据关系

```
field_config.field_id → abbr_mapping.field_id
select_options.option_value → abbr_mapping.full_name
```

#### 数据示例

| field_id | full_name | abbr_name | 说明 |
|----------|-----------|-----------|------|
| raw_type | mRNAseq | mRseq | 数据类型 → 转录组 |
| raw_type | Long-Read RNAseq | LRseq | 数据类型 → 长读长RNA |
| raw_type | 蛋白组 | pro | 数据类型 → 蛋白组 |
| raw_species | Homo sapiens | Hs | 物种 → 人类 |
| raw_species | Mus musculus | Mu | 物种 → 小鼠 |
| raw_tissue | 肿瘤组织 | tumor | 组织来源 → 肿瘤 |

#### 初始化数据

```sql
-- 数据类型缩写 (raw_type)
INSERT INTO abbr_mapping (field_id, full_name, abbr_name) VALUES
('raw_type', 'mRNAseq', 'mRseq'),
('raw_type', 'Long-Read RNAseq', 'LRseq'),
('raw_type', 'lncRNAseq', 'lncseq'),
('raw_type', 'miRNAseq', 'miseq'),
('raw_type', 'siRNAseq', 'siseq'),
('raw_type', 'scRNAseq', 'scseq'),
('raw_type', 'LR-scRNAseq', 'LR_sc'),
('raw_type', '蛋白组', 'pro'),
('raw_type', '磷酸化组', 'pho'),
('raw_type', '泛素化组', 'ubi'),
('raw_type', '乙酰化组', 'acety'),
('raw_type', 'SUMO PTMome', 'sumo'),
('raw_type', '甲基化组', 'meth'),
('raw_type', '糖基化组', 'glyco'),
('raw_type', '棕榈酰化组', 'pal'),
('raw_type', '代谢组', 'metab'),
('raw_type', '脂质组学', 'lipo'),
('raw_type', '免疫组学', 'immuno'),
('raw_type', '空间多组学', 'spatial');

-- 物种缩写 (raw_species)
INSERT INTO abbr_mapping (field_id, full_name, abbr_name) VALUES
('raw_species', 'Homo sapiens', 'Hs'),
('raw_species', 'Mus musculus', 'Mu'),
('raw_species', 'Rattus norvegicus', 'Ra'),
('raw_species', 'Danio rerio', 'Dr'),
('raw_species', 'Drosophila melanogaster', 'Dm'),
('raw_species', 'Others', 'Ot');

-- 组织来源缩写 (raw_tissue)
INSERT INTO abbr_mapping (field_id, full_name, abbr_name) VALUES
('raw_tissue', 'Adipose tissue', 'At'),
('raw_tissue', 'Adrenal gland', 'Ag'),
('raw_tissue', 'Appendix', 'Ap'),
('raw_tissue', 'Bone marrow', 'Bm'),
('raw_tissue', 'Breast', 'Br'),
('raw_tissue', 'Tumor', 'Tu'),
('raw_tissue', 'Normal tissue', 'Nt'),
('raw_tissue', 'Cell line', 'Cl'),
('raw_tissue', 'Primary cells', 'Pc');
```

---

## 三、字段关联关系

```
┌─────────────────┐
│  field_config   │ ← 定义所有字段
└────────┬────────┘
         │
         ├──────────────────────────────────────────┐
         │                                          │
         ▼                                          ▼
┌─────────────────┐                         ┌─────────────────┐
│  raw_project    │                         │ select_options  │
│  (原始数据表)   │ ───────────────────────▶ │ (选项表)        │
└─────────────────┘   field_id = option_type └─────────────────┘

┌─────────────────┐
│  abbr_mapping   │ ◀── 存储缩写映射
│  (缩写表)       │ ─── raw_type/raw_species/raw_tissue
└─────────────────┘
```

---

## 四、初始化数据

### 4.1 field_config 初始配置

```sql
-- 原始数据字段配置
INSERT INTO field_config (field_id, field_name, field_type, field_table, field_necessary, field_seq) VALUES
('raw_type', '数据类型', 'select', 'raw', 1, 1),
('raw_species', '物种', 'select', 'raw', 1, 2),
('raw_tissue', '组织来源', 'multi_select', 'raw', 0, 3),
('raw_DOI', 'DOI', 'text', 'raw', 0, 4),
('raw_db_id', '数据库编号', 'text', 'raw', 0, 5),
('raw_db_link', '数据库链接', 'text', 'raw', 0, 6),
('raw_author', '作者', 'text', 'raw', 0, 7),
('raw_article', '文章标题', 'text', 'raw', 0, 8),
('raw_description', '描述', 'textarea', 'raw', 0, 9),
('raw_keywords', '关键词', 'text', 'raw', 0, 10);

-- 结果数据字段配置
INSERT INTO field_config (field_id, field_name, field_type, field_table, field_necessary, field_seq) VALUES
('results_type', '结果类型', 'select', 'result', 1, 1),
('results_description', '描述', 'textarea', 'result', 0, 2),
('results_keywords', '关键词', 'text', 'result', 0, 3);
```

### 4.2 select_options 初始数据

```sql
-- 数据类型选项
INSERT INTO select_options (option_type, option_value, option_label, option_seq) VALUES
('raw_type', 'rnaseq', '转录组 (RNA-Seq)', 1),
('raw_type', 'singlecell', '单细胞转录组 (Single-cell)', 2),
('raw_type', 'spatial', '空间转录组 (Spatial)', 3),
('raw_type', 'proteomics', '蛋白组 (Proteomics)', 4),
('raw_type', 'phosphoproteomics', '磷酸化组 (Phosphoproteomics)', 5),
('raw_type', 'multiomics', '多组学 (Multi-omics)', 6);

-- 物种选项
INSERT INTO select_options (option_type, option_value, option_label, option_seq) VALUES
('raw_species', 'Homo sapiens', '人类 (Homo sapiens)', 1),
('raw_species', 'Mus musculus', '小鼠 (Mus musculus)', 2),
('raw_species', 'Rattus norvegicus', '大鼠 (Rattus norvegicus)', 3);

-- 组织来源选项
INSERT INTO select_options (option_type, option_value, option_label, option_seq) VALUES
('raw_tissue', 'tumor', '肿瘤组织', 1),
('raw_tissue', 'normal', '正常组织', 2),
('raw_tissue', 'cell_line', '细胞系', 3);
```

### 4.3 abbr_mapping 初始数据

```sql
-- 数据类型缩写
INSERT INTO abbr_mapping (field_id, full_name, abbr_name) VALUES
('raw_type', 'mRNAseq', 'mRseq'),
('raw_type', 'Long-Read RNAseq', 'LRseq'),
('raw_type', 'lncRNAseq', 'lncseq'),
('raw_type', 'miRNAseq', 'miseq'),
('raw_type', 'scRNAseq', 'scseq'),
('raw_type', '蛋白组', 'pro'),
('raw_type', '磷酸化组', 'pho');

-- 物种缩写
INSERT INTO abbr_mapping (field_id, full_name, abbr_name) VALUES
('raw_species', 'Homo sapiens', 'Hs'),
('raw_species', 'Mus musculus', 'Mu'),
('raw_species', 'Rattus norvegicus', 'Ra');
```

---

## 五、UUID 生成规则

项目编号 (raw_id / results_id) 使用以下格式：

```
格式: {TYPE}-{8位UUID}

TYPE:
- 原始数据: RAW
- 结果数据: RES

UUID规则:
- 字符集: 0-9, A-Z, a-z (共62个字符)
- 长度: 8位
- 示例: RAW-A1b2C3d4, RES-X9y8Z7w6
```

**Python 生成示例:**

```python
import random
import string

def generate_project_id(project_type: str) -> str:
    """生成项目编号"""
    chars = string.ascii_letters + string.digits
    uuid_8 = ''.join(random.choice(chars) for _ in range(8))
    return f"{project_type}-{uuid_8}"

# 示例
raw_id = generate_project_id('RAW')  # RAW-A1b2C3d4
res_id = generate_project_id('RES')  # RES-X9y8Z7w6
```

---

## 六、文件存储路径规则

### 6.1 原始数据文件路径

```
/bioraw/rawdata/{数据类型缩写}/{物种缩写}/{项目编号}/{文件名}

示例:
/bioraw/rawdata/mRseq/Hs/RAW-A1B2C3D4/sample1.fastq.gz
```

### 6.2 结果数据文件路径

```
/bioraw/results/{结果类型缩写}/{关联原始数据编号}/{项目编号}/{文件名}

示例:
/bioraw/results/dea/Hs-RAW-X9Y8Z7/RES-C3D4E5F6/heatmap.png
```

---

## 七、ER 图

```
┌──────────────────────┐
│    field_config      │
│  (元数据字段配置)    │
├──────────────────────┤
│ id                   │
│ field_id (PK)        │
│ field_name           │
│ field_type           │
│ field_table          │
│ field_necessary      │
│ field_options (JSON) │
│ field_seq            │
└──────────┬───────────┘
           │
           │ 1:N
           ▼
┌──────────────────────┐     ┌──────────────────────┐
│   raw_project        │     │   select_options     │
│   (原始数据项目)     │     │   (下拉选项)         │
├──────────────────────┤     ├──────────────────────┤
│ id                   │     │ id                   │
│ raw_id (AK)          │     │ option_type (FK)     │
│ raw_title            │     │ option_value         │
│ raw_type ────────────┼─────┼── option_label       │
│ raw_species          │     │ option_seq           │
│ raw_tissue           │     └──────────────────────┘
│ raw_DOI              │
│ ...                  │
│ created_at           │
└──────────────────────┘

┌──────────────────────┐
│   result_project     │
│   (结果数据项目)     │
├──────────────────────┤
│ id                   │
│ results_id (AK)      │
│ results_title        │
│ results_type         │
│ results_raw (FK)     │
│ ...                  │
└──────────────────────┘

┌──────────────────────┐
│   file_record        │
│   (文件记录)         │
├──────────────────────┤
│ id                   │
│ file_path            │
│ project_type         │
│ project_id (FK)      │
│ file_size            │
│ imported_at          │
└──────────────────────┘

┌──────────────────────┐
│   abbr_mapping       │
│   (缩写映射)         │
├──────────────────────┤
│ id                   │
│ field_id (FK)        │
│ full_name            │
│ abbr_name            │
└──────────────────────┘
```

---

**文档版本**: 2.0  
**创建时间**: 2026-01-16  
**数据库版本**: MySQL 8.x
