# BioData Manager 数据库设计规范

## 一、数据库概览

BioData Manager 使用 MySQL 8.x 数据库，包含以下核心数据表：

| 表名 | 中文名 | 说明 |
|------|--------|------|
| `field_config` | 元数据字段配置表 | 定义所有元数据字段 |
| `raw_project` | 原始数据项目表 | 存储原始数据项目信息 |
| `result_project` | 结果数据项目表 | 存储结果数据项目信息 |
| `file_record` | 文件记录表 | 存储文件导入记录 |
| `select_options` | 下拉选项表 | 存储单选/多选字段的选项 |
| `abbr_mapping` | 缩写映射表 | 存储字段值的全称与缩写对应关系 |

---

## 二、表结构详细设计

### 2.1 元数据字段配置表 (field_config)

**用途**: 定义所有元数据字段的配置，供前端动态生成表单和筛选器

```sql
CREATE TABLE field_config (
    id              INT PRIMARY KEY AUTO_INCREMENT COMMENT '字段配置ID',
    field_seq       INT NOT NULL DEFAULT 0 COMMENT '序号',
    field_id        VARCHAR(50) NOT NULL UNIQUE COMMENT '字段标识',
    field_name      VARCHAR(100) NOT NULL COMMENT '字段名称',
    field_type      ENUM('text', 'textarea', 'select') NOT NULL COMMENT '字段类型',
    field_necessary TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否必填',
    field_placeholder VARCHAR(10) DEFAULT '2' COMMENT '排列方式',
    field_readonly  TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否只读',
    field_table     ENUM('raw', 'result', 'file') NOT NULL COMMENT '所属项目类型',
    field_options   JSON COMMENT '选项配置',
    field_default   VARCHAR(255) DEFAULT NULL COMMENT '默认值',
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at      DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_field_table (field_table),
    INDEX idx_field_seq (field_seq)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='元数据字段配置表';
```

#### field_type 枚举值说明

| 值 | 说明 | 前端组件 |
|---|------|----------|
| `text` | 单行文本 | `<input type="text">` |
| `textarea` | 多行文本 | `<textarea>` |
| `select` | 选择下拉 | `<select>` |

**下拉框行为模式**：
- **新建项目/编辑项目**：使用 `multi_select` 模式（可多选，用逗号分隔存储）
- **文件导入**：使用 `single_select` 模式（仅单选）

#### field_placeholder 排列方式说明

| 值 | 说明 | 前端布局 |
|---|------|----------|
| `1` | 单列显示 | 字段占满整行，通常用于项目编号、项目名称、描述等重要字段 |
| `2` | 两列显示 | 字段与相邻字段成对排列显示（默认） |

**使用建议**:
- `raw_id`（项目编号）、`raw_title`（项目名称）建议设为单列 (`1`)
- `raw_description`（描述）建议设为单列 (`1`) 以便显示更多内容
- 普通元数据字段（如 `raw_type`、`raw_species`）使用默认的两列 (`2`)

#### field_readonly 只读控制说明

| 值 | 说明 | 前端行为 |
|---|------|----------|
| `0` | 可编辑 | 用户可以输入/选择字段值 |
| `1` | 系统自动管理 | 字段值由系统自动生成和维护（如文件数量、总大小），用户不可编辑 |

**各页面显示规则**：

| 页面类型 | field_readonly=1 的字段 | field_readonly=0 的字段 |
|---------|------------------------|------------------------|
| 新建/修改 原始数据项目 | ✅ 显示（只读文本框） | ✅ 显示（可编辑，multi_select） |
| 新建/修改 结果项目 | ✅ 显示（只读文本框） | ✅ 显示（可编辑，multi_select） |
| 文件导入 原始数据 | ❌ 不显示 | ✅ 显示可编辑字段（按环境变量配置），可编辑（single_select） |
| 文件导入 结果项目 | ❌ 不显示 | ✅ 显示可编辑字段（按环境变量配置），可编辑（single_select） |

**说明**：
- `field_readonly=1` 的字段在项目详情页面以只读方式显示，在文件导入页面不显示
- `field_readonly=0` 的字段在项目新建/修改页面全部显示
- **文件导入页面**：取 `field_readonly=0` 的字段，根据环境变量配置选择特定 `field_seq` 的字段
  - `METADATA_FIELDS_NEW_RAW`：新建原始数据项目时显示的字段编号（默认: `3,4,5,6,7`）
  - `METADATA_FIELDS_EXIST_RAW`：导入到已有原始数据项目时显示的字段编号（默认: `3,4,5,6,7`）
  - `METADATA_FIELDS_NEW_RESULT`：新建结果项目时显示的字段编号（默认: `3,4,5`）
  - `METADATA_FIELDS_EXIST_RESULT`：导入到已有结果项目时显示的字段编号（默认: `3,4,5`）

**选择已有项目导入时的元数据值追加规则**：
- 同一个原始数据项目可以包含不同种属、不同数据类型、不同样本来源的原始数据
- 同一个结果项目也可以包含不同的分析类型
- **字段值追加**：用户选择的新值会追加到项目当前字段值中（用逗号分隔），**去重**（如果新值已存在则不追加）
- **示例**：
  - 当前项目 raw_tissue = "Lung"
  - 导入时选择 raw_tissue = "Liver"
  - 结果：raw_tissue 变为 "Lung,Liver"
  - 如果选择的是 "Lung"，则 raw_tissue 保持 "Lung"（不重复）
- **存储路径计算**：根据用户选择的新字段值动态确定存储目录（追加模式下可能有多个子目录）

#### field_options JSON 结构示例

```json
// select 类型
{
  "options": [
    {"value": "rnaseq", "label": "转录组 (RNA-Seq)"},
    {"value": "singlecell", "label": "单细胞转录组"},
    {"value": "proteomics", "label": "蛋白组学"}
  ]
}
```

---

### 2.2 原始数据项目表 (raw_project)

**用途**: 存储原始数据项目的基本信息和元数据

```sql
CREATE TABLE raw_project (
    id                  INT PRIMARY KEY AUTO_INCREMENT COMMENT '自增ID',
    raw_id              VARCHAR(50) NOT NULL UNIQUE COMMENT '项目编号(格式: RAW-_UUID)',
    raw_title           VARCHAR(255) NOT NULL COMMENT '项目名称',
    raw_type            VARCHAR(50) NOT NULL COMMENT '数据类型(存储选项value值)',
    raw_species         VARCHAR(50) NOT NULL COMMENT '物种',
    raw_tissue          VARCHAR(255) DEFAULT NULL COMMENT '组织来源(多选逗号分隔)',
    raw_DOI             VARCHAR(100) DEFAULT NULL COMMENT 'DOI号',
    raw_db_id           VARCHAR(100) DEFAULT NULL COMMENT '数据库编号',
    raw_db_link         VARCHAR(500) DEFAULT NULL COMMENT '数据库链接',
    raw_author          VARCHAR(500) DEFAULT NULL COMMENT '作者(多人逗号分隔)',
    raw_article         VARCHAR(500) DEFAULT NULL COMMENT '文章标题',
    raw_description     TEXT DEFAULT NULL COMMENT '项目描述',
    raw_keywords        VARCHAR(500) DEFAULT NULL COMMENT '关键词(逗号分隔)',
    raw_file_count      INT DEFAULT 0 COMMENT '关联文件数量',
    raw_total_size      BIGINT DEFAULT 0 COMMENT '文件总大小(字节)',
    created_at          DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at          DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_raw_id (raw_id),
    INDEX idx_raw_type (raw_type),
    INDEX idx_raw_species (raw_species),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='原始数据项目表';
```

#### raw_id 生成规则

```
格式: RAW_{8位UUID}
示例: RAW_A1b2C3d4

UUID规则:
- 8位字符
- 数字 0-9
- 大写字母 A-Z
- 小写字母 a-z
```

#### 字段存储值说明

下表说明各字段的存储格式和取值规则。**实际取值以 select_options 表的配置为准**，下表仅为示例：

| 字段 | 存储值类型 | 存储规则 | 示例 |
|------|-----------|----------|------|
| raw_id | 字符串 | 格式: RAW_8位UUID | "RAW_A1b2C3d4" |
| raw_title | 字符串 | 项目名称，无特殊格式 | "肺癌转录组数据分析" |
| raw_type | 字符串 | 对应 select_options.option_value | "mRNAseq", "蛋白组" |
| raw_species | 字符串 | 对应 select_options.option_value | "Homo sapiens", "Mus musculus" |
| raw_tissue | 字符串 | 多选用逗号分隔，对应 option_value | "Lung,Tumor" |
| raw_DOI | 字符串 | DOI号格式 | "10.1038/s41586-020-2649-2" |
| raw_db_id | 字符串 | 数据库唯一标识 | "GSE123456" |
| raw_db_link | 字符串 | 完整URL | "https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE123456" |
| raw_author | 字符串 | 多位作者用逗号分隔 | "张三,李四,王五" |
| raw_article | 字符串 | 文章标题 | "Single-cell transcriptomics of human lung cancer" |
| raw_description | 文本 | 项目详细描述，可换行 | "本项目收集了..." |
| raw_keywords | 字符串 | 关键词用逗号分隔 | "肺癌,转录组,单细胞" |
| raw_file_count | 整数 | 关联文件数量 | 15 |
| raw_total_size | 整数 | 字节单位 | 5242880000 |

**注意事项**:
- select 类型字段存储的是 `option_value`（非显示的 `option_label`）
- 所有文本字段最大长度以表结构定义为准

---

### 2.3 结果数据项目表 (result_project)

**用途**: 存储结果数据项目的信息

```sql
CREATE TABLE result_project (
    id                  INT PRIMARY KEY AUTO_INCREMENT COMMENT '自增ID',
    results_id          VARCHAR(50) NOT NULL UNIQUE COMMENT '项目编号(格式: RES_UUID)',
    results_title       VARCHAR(255) NOT NULL COMMENT '项目名称',
    results_type        VARCHAR(50) NOT NULL COMMENT '结果类型',
    results_raw         VARCHAR(50) DEFAULT NULL COMMENT '关联原始数据项目编号',
    results_description TEXT DEFAULT NULL COMMENT '项目描述',
    results_keywords    VARCHAR(500) DEFAULT NULL COMMENT '关键词',
    results_file_count  INT DEFAULT 0 COMMENT '关联文件数量',
    results_total_size  BIGINT DEFAULT 0 COMMENT '文件总大小(字节)',
    created_at          DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at          DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_results_id (results_id),
    INDEX idx_results_type (results_type),
    INDEX idx_results_raw (results_raw),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='结果数据项目表';
```

#### 字段存储值说明

| 字段 | 存储值类型 | 存储规则 | 示例 |
|------|-----------|----------|------|
| results_id | 字符串 | 格式: RES_8位UUID | "RES_X9y8Z7w6" |
| results_title | 字符串 | 项目名称，无特殊格式 | "差异表达分析结果" |
| results_type | 字符串 | 结果类型标识 | "dea", "clustering" |
| results_raw | 字符串 | 关联的原始项目编号 | "RAW-A1b2C3d4" |
| results_description | 文本 | 项目详细描述，可换行 | "基于DESeq2的差异分析..." |
| results_keywords | 字符串 | 关键词用逗号分隔 | "差异表达,DESeq2,火山图" |
| results_file_count | 整数 | 关联文件数量 | 8 |
| results_total_size | 整数 | 字节单位 | 1048576000 |

---

### 2.4 文件记录表 (file_record)

**用途**: 存储导入文件的信息和归属关系

```sql
CREATE TABLE file_record (
    id              INT PRIMARY KEY AUTO_INCREMENT COMMENT '自增ID',
    file_name       VARCHAR(255) NOT NULL COMMENT '文件名（包含扩展名）',
    file_path       VARCHAR(500) NOT NULL COMMENT '相对于 /bio 的路径（不包含文件名）',
    file_property   VARCHAR(500) DEFAULT NULL COMMENT '文件属性（用于显示和筛选）',
    file_size       BIGINT NOT NULL COMMENT '文件大小（字节）',
    file_type       VARCHAR(50) DEFAULT NULL COMMENT '文件扩展名（小写）',
    file_project_type    ENUM('raw', 'result') NOT NULL COMMENT '所属项目类型',
    file_project_id      VARCHAR(50) NOT NULL COMMENT '所属项目编号',
    imported_at     DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '导入时间',
    INDEX idx_project (file_project_type, file_project_id),
    INDEX idx_file_path (file_path),
    INDEX idx_file_property (file_property),
    INDEX idx_imported_at (imported_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文件记录表';
```

#### 字段存储值说明

| 字段 | 存储值类型 | 存储规则 | 示例 |
|------|-----------|----------|------|
| file_name | 字符串 | 完整文件名，包含扩展名 | "sample1.fastq.gz" |
| file_path | 字符串 | 相对于 /bio 的路径，不包含文件名 | "rawdata/mRseq/Hs/Li" |
| file_property | 字符串 | 文件属性，用于显示和筛选 | "转录组-人类-食管" |
| file_size | 整数 | 字节单位 | 5242880000 |
| file_type | 字符串 | 文件扩展名（小写） | "gz", "fastq", "csv" |
| file_project_type | 枚举 | 'raw' 或 'result' | "raw", "result" |
| file_project_id | 字符串 | 所属项目编号 | "RAW-A1B2C3D4" |
| imported_at | 日期时间 | 导入时间，格式: YYYY-MM-DD HH:MM:SS | "2026-01-17 10:30:00" |

#### file_property 字段说明

file_property 字段存储文件的属性信息，用于前端显示和筛选。该值根据项目类型和用户选择的元数据动态生成。

**生成规则：**

| 项目类型 | 生成规则 | 示例 |
|---------|----------|------|
| 原始数据 (raw) | `数据类型-物种-[组织来源]` | "转录组-人类-食管" |
| 结果数据 (result) | `分析类型-[关联项目编号]` | "差异表达分析-RAW_A1B2C3D4" |

**详细规则：**

1. **原始数据文件**：
   - 使用 select_options 表的 `option_label`（非 `option_value`）
   - 格式：`{raw_type_label}-{raw_species_label}-[{raw_tissue_label}]`
   - 组织来源为可选，如果为空则不包含
   - 各部分用 `-` 连接
   - 示例：
     - "转录组-人类-食管"（有组织来源）
     - "转录组-人类"（无组织来源）

2. **结果数据文件**：
   - 格式：`{results_type_label}-[{results_raw}]`
   - 关联项目编号为可选，如果为空则不包含
   - 如果有关联项目，使用 results_raw 字段存储的项目编号
   - 多个项目编号按文本ASCII码从小到大排序后直接组合（不加逗号）
   - 示例：
     - "差异表达分析-RAW_A1B2C3D4"（有关联项目）
     - "差异表达分析"（无关联项目）
     - "聚类分析-RAW_2BRAW_A1RAW_a8"（多个关联项目，排序后组合）

#### file_path 字段说明

file_path 字段存储的是相对于 /bio 根目录的路径，不包含文件名。该值由 abbr_mapping 表的字段缩写组合生成：

| abbr_mapping 字段 | 示例值 | 说明 |
|------------------|-------|------|
| d_a (数据类型缩写) | mRseq | 来自 raw_type |
| o_a (物种缩写) | Hs | 来自 raw_species |
| s_a (组织来源缩写) | Li | 来自 raw_tissue |

**完整 file_path 计算逻辑：**
```
file_path = {d_a}/{o_a}/{s_a}
           = mRseq/Hs/Li

完整文件路径 = /bio/{file_path}/{file_name}
             = /bio/mRseq/Hs/Li/sample1.fastq.gz
```

#### file_name 字段说明

file_name 字段存储文件的完整名称，包含所有扩展名：

| 完整路径 | file_path | file_name |
|---------|-----------|-----------|
| /bio/mRseq/Hs/Li/sample1.fastq.gz | mRseq/Hs/Li | sample1.fastq.gz |
| /bio/results/dea/RES_YYY/heatmap.png | results/dea/RES_YYY | heatmap.png |

#### file_type 字段说明

file_type 字段存储文件的扩展名（小写），用于文件类型筛选和显示：

| 文件名 | file_type |
|--------|-----------|
| sample1.fastq.gz | gz |
| GSE33048_tumor.fastq.tar.gz | tar.gz |
| result.csv | csv |
| heatmap.png | png |

#### 存储路径示例

| 完整路径 | file_path | file_name | file_type | file_property |
|---------|-----------|-----------|-----------|---------------|
| /bio/mRseq/Hs/Li/sample1.fastq.gz | mRseq/Hs/Li | sample1.fastq.gz | gz | 转录组-人类-食管 |
| /bio/rawdata/mRseq/Hs/Li/RAW_XXX/sample.fastq | rawdata/mRseq/Hs/Li | sample.fastq | fastq | 转录组-人类-肺 |
| /bio/results/dea/RES_YYY/heatmap.png | results/dea/RES_YYY | heatmap.png | png | 差异表达分析-RAW_A1B2C3D4 |
| /bio/results/clustering/RES_ZZZ/plots | results/clustering/RES_ZZZ | plots | - | 聚类分析 |

---

### 2.5 下拉选项表 (select_options)

**用途**: 存储单选/多选字段的选项列表

```sql
CREATE TABLE select_options (
    id              INT PRIMARY KEY AUTO_INCREMENT COMMENT '自增ID',
    option_type     VARCHAR(50) NOT NULL COMMENT '选项类型(对应field_id)',
    option_value    VARCHAR(100) NOT NULL COMMENT '选项值(value)',
    option_label    VARCHAR(255) NOT NULL COMMENT '选项标签(label)',
    option_seq      INT DEFAULT 0 COMMENT '排序序号',
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    UNIQUE KEY uk_type_value (option_type, option_value),
    INDEX idx_option_type (option_type),
    INDEX idx_option_seq (option_seq)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='下拉选项表';
```

#### 数据关系

```
field_config.field_id → select_options.option_type
```

---

### 2.6 缩写映射表 (abbr_mapping)

**用途**: 存储字段值的全称与缩写对应关系，用于文件导入时生成目录结构。通过 `field_id` 字段区分不同字段类型的缩写，所有缩写在同一张表管理。

```sql
CREATE TABLE abbr_mapping (
    id              INT PRIMARY KEY AUTO_INCREMENT COMMENT '自增ID',
    field_id        VARCHAR(50) NOT NULL COMMENT '字段标识符(对应field_config.field_id)',
    full_name       VARCHAR(100) NOT NULL COMMENT '全称(选项的完整名称)',
    abbr_name       VARCHAR(20) NOT NULL COMMENT '缩写(用于文件路径)',
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    UNIQUE KEY uk_field_full (field_id, full_name),
    INDEX idx_field_id (field_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='缩写映射表';
```

#### 数据关系

```
field_config.field_id → abbr_mapping.field_id
select_options.option_value → abbr_mapping.full_name
```

#### 数据示例

| field_id | full_name | abbr_name | 说明 |
|----------|-----------|-----------|------|
| raw_type | mRNAseq | mRseq | 数据类型 → 转录组 |
| raw_type | 蛋白组 | pro | 数据类型 → 蛋白组 |
| raw_species | Homo sapiens | Hs | 物种 → 人类 |
| raw_species | Mus musculus | Mu | 物种 → 小鼠 |
| raw_tissue | Tumor | Tu | 组织来源 → 肿瘤 |
| raw_tissue | Normal tissue | Nt | 组织来源 → 正常组织 |

---

## 三、字段关联关系

```
┌─────────────────┐
│  field_config   │ ← 定义所有字段
└────────┬────────┘
         │
         ├──────────────────────────────────────────┐
         │                                          │
         ▼                                          ▼
┌─────────────────┐                         ┌─────────────────┐
│  raw_project    │                         │ select_options  │
│  (原始数据表)   │ ───────────────────────▶ │ (下拉选项表)    │
└─────────────────┘   field_id = option_type └─────────────────┘

┌─────────────────┐
│  abbr_mapping   │ ◀── 存储缩写映射
│  (缩写表)       │ ─── raw_type/raw_species/raw_tissue
└─────────────────┘
```

---

## 四、初始化数据
初始化数据请完全按照下方描述进行init_db.py，不允许自作主张的修改，和下方内容一模一样即可。

### 4.1 field_config 初始配置

```sql
-- 原始数据字段配置 (对应 raw_project 表)
-- field_placeholder: 1=单列显示, 2=两列显示(默认)
-- field_readonly: 0=可编辑, 1=系统自动管理(不显示编辑框)
INSERT INTO field_config (field_id, field_name, field_type, field_table, field_necessary, field_seq, field_placeholder, field_readonly) VALUES
('raw_id', '项目编号', 'text', 'raw', 1, 0, '2', 0),
('raw_title', '项目名称', 'text', 'raw', 1, 1, '2', 0),
('raw_type', '数据类型', 'select', 'raw', 1, 2, '2', 0),
('raw_species', '物种', 'select', 'raw', 1, 3, '2', 0),
('raw_tissue', '组织来源', 'select', 'raw', 0, 4, '2', 0),
('raw_DOI', 'DOI', 'text', 'raw', 0, 5, '2', 0),
('raw_db_id', '数据库编号', 'text', 'raw', 0, 6, '2', 0),
('raw_db_link', '数据库链接', 'text', 'raw', 0, 7, '2', 0),
('raw_author', '作者', 'text', 'raw', 0, 8, '2', 0),
('raw_article', '文章标题', 'text', 'raw', 0, 9, '2', 0),
('raw_description', '描述', 'textarea', 'raw', 0, 10, '1', 0),
('raw_keywords', '关键词', 'text', 'raw', 0, 11, '1', 0),
('raw_file_count', '文件数量', 'text', 'raw', 0, 12, '2', 1),
('raw_total_size', '文件总大小', 'text', 'raw', 0, 13, '2', 1);

-- 结果数据字段配置 (对应 result_project 表)
INSERT INTO field_config (field_id, field_name, field_type, field_table, field_necessary, field_seq, field_placeholder, field_readonly) VALUES
('results_id', '项目编号', 'text', 'result', 1, 0, '2', 0),
('results_title', '项目名称', 'text', 'result', 1, 1, '2', 0),
('results_type', '结果类型', 'select', 'result', 1, 2, '2', 0),
('results_raw', '关联原始项目', 'text', 'result', 0, 3, '2', 0),
('results_description', '描述', 'textarea', 'result', 0, 4, '1', 0),
('results_keywords', '关键词', 'text', 'result', 0, 5, '1', 0),
('results_file_count', '文件数量', 'text', 'result', 0, 6, '2', 1),
('results_total_size', '文件总大小', 'text', 'result', 0, 7, '2', 1);

-- 文件管理字段配置 (对应 file_record 表)
INSERT INTO field_config (field_id, field_name, field_type, field_table, field_necessary, field_seq, field_placeholder, field_readonly) VALUES
('file_name', '文件名', 'text', 'file', 1, 0, '2', 0),
('file_path', '文件路径', 'text', 'file', 1, 1, '2', 0),
('file_property', '文件属性', 'text', 'file', 0, 2, '2', 0),
('file_size', '文件大小', 'text', 'file', 0, 3, '2', 0),
('file_type', '文件类型', 'text', 'file', 0, 4, '2', 0),
('file_project_type', '项目类型', 'text', 'file', 1, 5, '2', 0),
('file_project_id', '项目编号', 'text', 'file', 1, 6, '2', 0),
('imported_at', '导入时间', 'text', 'file', 0, 7, '2', 0);
```

### 4.2 select_options 初始数据

```sql
-- 数据类型选项 (raw_type)
INSERT INTO select_options (option_type, option_value, option_label, option_seq) VALUES
('raw_type', 'mRNAseq', '转录组', 1),
('raw_type', 'Long-Read RNAseq', '长读转录组', 2),
('raw_type', 'lncRNAseq', 'lncRNAseq', 3),
('raw_type', 'miRNAseq', 'miRNAseq', 4),
('raw_type', 'sRNAseq', '小RNA转录组', 5),
('raw_type', 'epitRNAseq', '表观转录组', 6),
('raw_type', 'scRNAseq', '单细胞转录组', 7),
('raw_type', 'LR-scRNAseq', '长读单细胞转录组', 8),
('raw_type', '蛋白组', '蛋白组', 9),
('raw_type', '磷酸化组', '磷酸化组', 10),
('raw_type', '泛素化组', '泛素化组', 11),
('raw_type', '乙酰化组', '乙酰化组', 12),
('raw_type', 'SUMO PTMome', 'SUMO PTMome', 13),
('raw_type', '甲基化组', '甲基化组', 14),
('raw_type', '糖基化组', '糖基化组', 15),
('raw_type', '棕榈酰化组', '棕榈酰化组', 16),
('raw_type', '代谢组', '代谢组', 17),
('raw_type', '脂质组学', '脂质组学', 18),
('raw_type', '免疫组学', '免疫组学', 19),
('raw_type', '空间多组学', '空间多组学', 20);

-- 物种选项 (raw_species)
INSERT INTO select_options (option_type, option_value, option_label, option_seq) VALUES
('raw_species', 'Homo sapiens', '人', 1),
('raw_species', 'Mus musculus', '小鼠', 2),
('raw_species', 'Rattus norvegicus', '大鼠', 3),
('raw_species', 'Others', '其他', 4);

-- 组织来源选项 (raw_tissue)
INSERT INTO select_options (option_type, option_value, option_label, option_seq) VALUES
('raw_tissue', 'Not Specific', 'Not Specific (非单一组织)', 0),
('raw_tissue', 'Adipose tissue', 'Adipose tissue (脂肪组织)', 1),
('raw_tissue', 'Adrenal gland', 'Adrenal gland (肾上腺)', 2),
('raw_tissue', 'Amygdala', 'Amygdala (杏仁核)', 3),
('raw_tissue', 'Basal ganglia', 'Basal ganglia (基底神经节)', 4),
('raw_tissue', 'Blood vessel', 'Blood vessel (血管)', 5),
('raw_tissue', 'Bone marrow', 'Bone marrow (骨髓)', 6),
('raw_tissue', 'Breast', 'Breast (乳房)', 7),
('raw_tissue', 'Cerebellum', 'Cerebellum (小脑)', 8),
('raw_tissue', 'Cerebral cortex', 'Cerebral cortex (大脑皮层)', 9),
('raw_tissue', 'Cervix', 'Cervix (子宫颈)', 10),
('raw_tissue', 'Choroid plexus', 'Choroid plexus (脉络丛)', 11),
('raw_tissue', 'Colon', 'Colon (结肠)', 12),
('raw_tissue', 'Duodenum', 'Duodenum (十二指肠)', 13),
('raw_tissue', 'Endometrium', 'Endometrium (子宫内膜)', 14),
('raw_tissue', 'Epididymis', 'Epididymis (附睾)', 15),
('raw_tissue', 'Esophagus', 'Esophagus (食管)', 16),
('raw_tissue', 'Fallopian tube', 'Fallopian tube (输卵管)', 17),
('raw_tissue', 'Gallbladder', 'Gallbladder (胆囊)', 18),
('raw_tissue', 'Heart muscle', 'Heart muscle (心肌)', 19),
('raw_tissue', 'Hippocampal formation', 'Hippocampal formation (海马结构)', 20),
('raw_tissue', 'Hypothalamus', 'Hypothalamus (下丘脑)', 21),
('raw_tissue', 'Kidney', 'Kidney (肾脏)', 22),
('raw_tissue', 'Liver', 'Liver (肝脏)', 23),
('raw_tissue', 'Lung', 'Lung (肺)', 24),
('raw_tissue', 'Lymph node', 'Lymph node (淋巴结)', 25),
('raw_tissue', 'Midbrain', 'Midbrain (中脑)', 26),
('raw_tissue', 'Ovary', 'Ovary (卵巢)', 27),
('raw_tissue', 'Pancreas', 'Pancreas (胰腺)', 28),
('raw_tissue', 'Parathyroid gland', 'Parathyroid gland (甲状旁腺)', 29),
('raw_tissue', 'Pituitary gland', 'Pituitary gland (垂体)', 30),
('raw_tissue', 'Placenta', 'Placenta (胎盘)', 31),
('raw_tissue', 'Prostate', 'Prostate (前列腺)', 32),
('raw_tissue', 'Rectum', 'Rectum (直肠)', 33),
('raw_tissue', 'Retina', 'Retina (视网膜)', 34),
('raw_tissue', 'Salivary gland', 'Salivary gland (唾液腺)', 35),
('raw_tissue', 'Seminal vesicle', 'Seminal vesicle (精囊)', 36),
('raw_tissue', 'Skeletal muscle', 'Skeletal muscle (骨骼肌)', 37),
('raw_tissue', 'Skin', 'Skin (皮肤)', 38),
('raw_tissue', 'Small intestine', 'Small intestine (小肠)', 39),
('raw_tissue', 'Smooth muscle', 'Smooth muscle (平滑肌)', 40),
('raw_tissue', 'Spinal cord', 'Spinal cord (脊髓)', 41),
('raw_tissue', 'Spleen', 'Spleen (脾脏)', 42),
('raw_tissue', 'Stomach', 'Stomach (胃)', 43),
('raw_tissue', 'Testis', 'Testis (睾丸)', 44),
('raw_tissue', 'Thymus', 'Thymus (胸腺)', 45),
('raw_tissue', 'Thyroid gland', 'Thyroid gland (甲状腺)', 46),
('raw_tissue', 'Tongue', 'Tongue (舌头)', 47),
('raw_tissue', 'Tonsil', 'Tonsil (扁桃体)', 48),
('raw_tissue', 'Urinary bladder', 'Urinary bladder (膀胱)', 49),
('raw_tissue', 'Vagina', 'Vagina (阴道)', 50);
```

### 4.3 abbr_mapping 初始数据

```sql
-- 数据类型缩写 (raw_type)
INSERT INTO abbr_mapping (field_id, full_name, abbr_name) VALUES
('raw_type', 'mRNAseq', 'mRseq'),
('raw_type', 'Long-Read RNAseq', 'LRseq'),
('raw_type', 'lncRNAseq', 'lncseq'),
('raw_type', 'miRNAseq', 'miseq'),
('raw_type', 'sRNAseq', 'srseq'),
('raw_type', 'epitRNAseq', 'epitseq'),
('raw_type', 'scRNAseq', 'scseq'),
('raw_type', 'LR-scRNAseq', 'LR_sc'),
('raw_type', '蛋白组', 'pro'),
('raw_type', '磷酸化组', 'pho'),
('raw_type', '泛素化组', 'ubi'),
('raw_type', '乙酰化组', 'acety'),
('raw_type', 'SUMO PTMome', 'sumo'),
('raw_type', '甲基化组', 'meth'),
('raw_type', '糖基化组', 'glyco'),
('raw_type', '棕榈酰化组', 'pal'),
('raw_type', '代谢组', 'metab'),
('raw_type', '脂质组学', 'lipo'),
('raw_type', '免疫组学', 'immuno'),
('raw_type', '空间多组学', 'spatial');

-- 物种缩写 (raw_species)
INSERT INTO abbr_mapping (field_id, full_name, abbr_name) VALUES
('raw_species', 'Homo sapiens', 'Hs'),
('raw_species', 'Mus musculus', 'Mu'),
('raw_species', 'Rattus norvegicus', 'Ra'),
('raw_species', 'Others', 'Ot');

-- 组织来源缩写 (raw_tissue)
INSERT INTO abbr_mapping (field_id, full_name, abbr_name) VALUES
('raw_tissue', 'Not specific', 'Ns'),
('raw_tissue', 'Adipose tissue', 'At'),
('raw_tissue', 'Adrenal gland', 'Ag'),
('raw_tissue', 'Amygdala', 'Am'),
('raw_tissue', 'Basal ganglia', 'Bg'),
('raw_tissue', 'Blood vessel', 'Bv'),
('raw_tissue', 'Bone marrow', 'Bm'),
('raw_tissue', 'Breast', 'Br'),
('raw_tissue', 'Cerebellum', 'Ce'),
('raw_tissue', 'Cerebral cortex', 'Cc'),
('raw_tissue', 'Cervix', 'Cer'),
('raw_tissue', 'Choroid plexus', 'Cp'),
('raw_tissue', 'Colon', 'Co'),
('raw_tissue', 'Duodenum', 'Du'),
('raw_tissue', 'Endometrium', 'En'),
('raw_tissue', 'Epididymis', 'Ep'),
('raw_tissue', 'Esophagus', 'Es'),
('raw_tissue', 'Fallopian tube', 'Fa'),
('raw_tissue', 'Gallbladder', 'Ga'),
('raw_tissue', 'Heart muscle', 'Hm'),
('raw_tissue', 'Hippocampal formation', 'Hf'),
('raw_tissue', 'Hypothalamus', 'Hy'),
('raw_tissue', 'Kidney', 'Ki'),
('raw_tissue', 'Liver', 'Li'),
('raw_tissue', 'Lung', 'Lu'),
('raw_tissue', 'Lymph node', 'Ln'),
('raw_tissue', 'Midbrain', 'Mi'),
('raw_tissue', 'Ovary', 'Ov'),
('raw_tissue', 'Pancreas', 'Pa'),
('raw_tissue', 'Parathyroid gland', 'Pg'),
('raw_tissue', 'Pituitary gland', 'Pig'),
('raw_tissue', 'Placenta', 'Pl'),
('raw_tissue', 'Prostate', 'Pr'),
('raw_tissue', 'Rectum', 'Re'),
('raw_tissue', 'Retina', 'Ret'),
('raw_tissue', 'Salivary gland', 'Sg'),
('raw_tissue', 'Seminal vesicle', 'Sv'),
('raw_tissue', 'Skeletal muscle', 'Sm'),
('raw_tissue', 'Skin', 'Sk'),
('raw_tissue', 'Small intestine', 'Si'),
('raw_tissue', 'Smooth muscle', 'Sm'),
('raw_tissue', 'Spinal cord', 'Sc'),
('raw_tissue', 'Spleen', 'Sp'),
('raw_tissue', 'Stomach', 'St'),
('raw_tissue', 'Testis', 'Te'),
('raw_tissue', 'Thymus', 'Th'),
('raw_tissue', 'Thyroid gland', 'Tg'),
('raw_tissue', 'Tongue', 'To'),
('raw_tissue', 'Tonsil', 'Ton'),
('raw_tissue', 'Urinary bladder', 'Ub'),
('raw_tissue', 'Vagina', 'Va');
```

---

## 五、UUID 生成规则

项目编号 (raw_id / results_id) 使用以下格式：

```
格式: {TYPE}_{8位UUID}

TYPE:
- 原始数据: RAW
- 结果数据: RES

UUID规则:
- 字符集: 0-9, A-Z, a-z (共62个字符)
- 长度: 8位
- 示例: RAW_A1b2C3d4, RES_X9y8Z7w6
```

**Python 生成示例:**

```python
import random
import string

def generate_project_id(project_type: str) -> str:
    """生成项目编号"""
    chars = string.ascii_letters + string.digits
    uuid_8 = ''.join(random.choice(chars) for _ in range(8))
    return f"{project_type}_{uuid_8}"

# 示例
raw_id = generate_project_id('RAW')  # RAW_A1b2C3d4
res_id = generate_project_id('RES')  # RES_X9y8Z7w6
```

---

## 六、文件存储路径规则

### 6.1 原始数据文件路径

原始数据文件存储在 `/bio/rawdata` 目录下，路径结构为：

```
/bio/rawdata/{数据类型缩写}/{物种缩写}/{组织来源缩写}/{项目编号}/{文件名}

示例:
/bio/rawdata/mRseq/Hs/Li/RAW_A1B2C3D4/sample1.fastq.gz
```

**路径组成说明**：
- `数据类型缩写`: 来自 raw_type 字段的缩写（如 mRseq, ATACseq 等）
- `物种缩写`: 来自 raw_species 字段的缩写（如 Hs, Mm 等）
- `组织来源缩写`: 来自 raw_tissue 字段的缩写（如 Li, Lu 等）
- `项目编号`: 原始数据项目的唯一编号（如 RAW_A1B2C3D4）

### 6.2 结果数据文件路径

结果数据文件存储在 `/bio/results` 目录下，路径结构为：

```
/bio/results/{项目编号}/{分析类型}[/{关联项目编号}]/{文件名}

示例:
/bio/results/RES_X1Y2Z3/DEA/heatmap.png
/bio/results/RES_X1Y2Z3/DEA/RAW_A1RAW_B2RAW_C3/heatmap.png
```

**路径组成说明**：
- `项目编号`: 结果数据项目的唯一编号（如 RES_X1Y2Z3）
- `分析类型`: 来自 results_type 字段的值（如 DEA, Marker, Enrichment 等）
- `关联项目编号`: 可选，来自 results_raw 字段，支持逗号分隔（中英文逗号都识别）
  - 多个项目编号按 ASCII 字母顺序排序后直接组合（无分隔符）
  - 示例: `RAW_A1，RAW_2A, RAW_sa` → 排序组合为 `RAW_2ARAW_A1RAW_sa`

**关联项目编号处理规则**：
- 支持中英文逗号分隔: `RAW_XXX，RAW_YYY, RAW_ZZZ`
- 多个项目编号按字母排序（ASCII 顺序：数字 < 大写字母 < 小写字母）
- 排序后直接组合，不添加分隔符
- 无关联项目时路径为: `/bio/results/{项目编号}/{分析类型}/`

---

## 七、ER 图

```
┌──────────────────────┐
│    field_config      │
│  (元数据字段配置)    │
├──────────────────────┤
│ id                   │
│ field_id (PK)        │
│ field_name           │
│ field_type           │
│ field_table          │
│ field_necessary      │
│ field_options (JSON) │
│ field_seq            │
└──────────┬───────────┘
           │
           │ 1:N
           ▼
┌──────────────────────┐     ┌──────────────────────┐
│   raw_project        │     │   select_options     │
│   (原始数据项目)     │     │   (下拉选项)         │
├──────────────────────┤     ├──────────────────────┤
│ id                   │     │ id                   │
│ raw_id (AK)          │     │ option_type (FK)     │
│ raw_title            │     │ option_value         │
│ raw_type ────────────┼─────┼── option_label       │
│ raw_species          │     │ option_seq           │
│ raw_tissue           │     └──────────────────────┘
│ raw_DOI              │
│ ...                  │
│ created_at           │
└──────────────────────┘

┌──────────────────────┐
│   result_project     │
│   (结果数据项目)     │
├──────────────────────┤
│ id                   │
│ results_id (AK)      │
│ results_title        │
│ results_type         │
│ results_raw (FK)     │
│ results_file_count   │
│ results_total_size   │
│ ...                  │
└──────────────────────┘

┌──────────────────────┐
│   file_record        │
│   (文件记录)         │
├──────────────────────┤
│ id                   │
│ file_name            │
│ file_path            │
│ file_size            │
│ file_type            │
│ file_project_type    │
│ file_project_id (FK) │
│ imported_at          │
└──────────────────────┘

┌──────────────────────┐
│   abbr_mapping       │
│   (缩写映射)         │
├──────────────────────┤
│ id                   │
│ field_id (FK)        │
│ full_name            │
│ abbr_name            │
└──────────────────────┘
```

---

**文档版本**: 2.4  
**创建时间**: 2026-01-16  
**最后更新**: 2026-01-22  
**数据库版本**: MySQL 8.x  
**主要更新**:
- 新增 file_property 字段，存储文件属性信息
- file_property 生成规则：
  - 原始数据：`数据类型-物种-[组织来源]`（使用 label 非 value）
  - 结果数据：`分析类型-[关联项目编号]`（多编号按ASCII排序后组合）
- 选择已有项目导入时字段可编辑，支持元数据值追加（去重）