# 前端实现差异报告与修改计划

> 生成时间: 2026-01-16
> 状态: 轮询中

---

## 一、概述

本报告记录 BioData Manager 项目前端实现与设计文档（`应用功能设计.md` 和 `数据库设计规范.md`）之间的差异，用于追踪修改进度和确保代码符合设计要求。

---

## 二、设计文档与代码对比

### 2.1 文件管理页面布局

| 设计文档要求 | 当前实现 | 差异描述 | 严重程度 |
|-------------|----------|----------|----------|
| 左右分栏布局：左侧导入模块，右侧查看模块 | 单一页面纵向排列三个表格卡片 | 布局结构完全不同 | 🔴 高 |
| 导入模块：目录扫描按钮 + 文件夹列表 | 只有卡片头部显示状态，无独立导入区域 | 功能区域缺失 | 🔴 高 |
| 查看模块：筛选下拉框 + 项目列表 | 只有三个静态表格 | 功能区域缺失 | 🔴 高 |

**设计文档要求布局** (`应用功能设计.md` 第70-90行):
```
┌─────────────────────────────────────────────────────────────────────┐
│  文件管理                                                            │
├────────────────────────┬────────────────────────────────────────────┤
│  导入模块              │  查看模块                                   │
│                        │                                             │
│  目录扫描:             │  筛选:                                     │
│  [扫描下载目录]        │  ┌─────────┐ [查询]                       │
│                        │  │ 项目编号 ▼│                             │
│  文件夹列表:           │  └─────────┘                               │
│  ┌─────────────────┐  │                                             │
│  │ 📁 sample1      │  │  ┌─────────────────────────────────────┐   │
│  │   [导入] [查看] │  │  │ 项目列表                            │   │
│  └─────────────────┘  │  └─────────────────────────────────────┘   │
└────────────────────────┴────────────────────────────────────────────┘
```

**当前实现布局** (`app/templates/files.html`):
```
┌─────────────────────────────────────────────────────────────────────┐
│  文件管理                                                            │
├─────────────────────────────────────────────────────────────────────┤
│  [文件导入卡片 - 仅状态显示]                                         │
├─────────────────────────────────────────────────────────────────────┤
│  [下载目录文件卡片 - 表格列表]                                      │
├─────────────────────────────────────────────────────────────────────┤
│  [处理数据文件卡片 - 表格列表]                                      │
├─────────────────────────────────────────────────────────────────────┤
│  [分析结果卡片 - 表格列表]                                          │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 2.2 文件类型分类

| 设计文档要求 | 当前实现 | 差异描述 | 严重程度 |
|-------------|----------|----------|----------|
| 两种数据类型：原始数据 (Raw)、结果数据 (Result) | 三种类型：下载目录文件、处理数据文件、分析结果 | 分类体系完全不同 | 🔴 高 |
| 数据类型决定存储路径 | 物理目录分类（download/processed/analysis） | 逻辑结构不一致 | 🔴 高 |
| 导入时选择数据类型 | 无数据类型选择，仅选择项目 | 功能缺失 | 🟡 中 |

**设计文档要求分类** (`应用功能设计.md` 第15-35行):
```sql
-- 原始数据类型
raw_type IN ('rnaseq', 'singlecell', 'spatial', 'proteomics', 'phosphoproteomics', 'multiomics')

-- 结果数据类型
results_type IN ('alignment', 'counts', 'peak_calling', 'variants', 'enrichment', 'visualization', 'other')
```

**当前实现分类** (`app/templates/files.html`):
```javascript
let downloadFiles = [];      // 下载目录文件
let processedFiles = [];     // 处理数据文件
let analysisFolders = [];    // 分析结果文件夹
```

---

### 2.3 文件选择方式

| 设计文档要求 | 当前实现 | 差异描述 | 严重程度 |
|-------------|----------|----------|----------|
| 弹窗 + 复选框树形结构 | 表格行操作，仅单文件处理 | 功能完全缺失 | 🔴 高 |
| 支持批量选择、全选/取消全选 | 只能逐个文件操作 | 功能完全缺失 | 🔴 高 |
| 文件夹可展开收起 | 平面列表，无层级结构 | 交互模式缺失 | 🟡 中 |

**设计文档要求** (`应用功能设计.md` 第105-120行):
```
选择文件:
┌─────────────────────────────────────────────────────────────┐
│  ☑ ☑ subfolder1/                                           │
│      ☑ file1.fastq.gz (2.3 GB)                             │
│      ☑ file2.fastq.gz (2.1 GB)                             │
│  ☑ ☑ subfolder2/                                           │
│      ☑ alignment.bam (1.8 GB)                              │
│  [全选] [取消全选]                                          │
└─────────────────────────────────────────────────────────────┘
```

**当前实现** (`app/templates/files.html` 第261-295行):
```html
<!-- 只能单行操作 -->
<td>
    <button onclick="showSelectProject('${f.name}')">归属项目</button>
    <button onclick="deleteFile('${f.path}')">删除</button>
</td>
```

---

### 2.4 导入弹窗设计

| 设计文档要求 | 当前实现 | 差异描述 | 严重程度 |
|-------------|----------|----------|----------|
| 两列布局：目标选择+数据类型 / 文件选择 | 仅显示项目归属选择弹窗 | 功能严重缺失 | 🔴 高 |
| 支持新建项目/选择已有项目 | 仅有选择已有项目 | 功能缺失 | 🟡 中 |
| 引用文件解析功能 (.bib/.ris/.enw) | 无此功能 | 功能缺失 | 🟡 中 |
| 项目信息表单（两列布局） | 无项目信息表单 | 功能缺失 | 🟡 中 |

**设计文档要求** (`应用功能设计.md` 第95-145行):
```
┌─────────────────────────────────────────────────────────────────────┐
│  导入文件 - sample1                                            [X]  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  目标项目:                                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ ○ 新建项目                                                     │   │
│  │ ○ 选择已有项目                                                 │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  数据类型:                                                          │
│  ┌─────────────────────────┐                                      │ │
│  │ ○ 原始数据  ○ 结果数据 │                                      │ │
│  └─────────────────────────┘                                      │ │
│                                                                     │
│  项目信息 (新建项目时显示，两列布局)                                 │
│  ...                                                               │
│                                                                     │
│  选择文件:                                                          │
│  ...                                                               │
└─────────────────────────────────────────────────────────────────────┘
```

**当前实现** (`app/templates/files.html` 第125-148):
```html
<div class="modal fade" id="select-project-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">选择归属项目</h5>
            </div>
            <div class="modal-body">
                <select class="form-select" id="target-project">
                    <option value="">请选择项目...</option>
                </select>
            </div>
        </div>
    </div>
</div>
```

---

### 2.5 查看详情功能

| 设计文档要求 | 当前实现 | 差异描述 | 严重程度 |
|-------------|----------|----------|----------|
| 右侧面板筛选 + 项目列表 + 详情弹窗 | 只有三个表格，无筛选功能 | 功能完全缺失 | 🔴 高 |
| 详情弹窗显示文件列表，支持勾选下载 | 无此功能 | 功能缺失 | 🟡 中 |
| 项目编号筛选下拉框 | 无筛选下拉框 | 功能缺失 | 🟡 中 |

---

## 三、其他不一致项

### 3.1 JavaScript 代码结构

| 设计文档要求 | 当前实现 | 差异描述 |
|-------------|----------|----------|
| 独立 `static/js/app.js` 文件 | 所有 JS 代码内嵌在 HTML 模板中 | 代码组织不符合规范 |
| 统一的 API 客户端封装 | 内联 `apiGet`/`apiPost` 函数 | 可维护性差 |

**当前问题** (`app/templates/files.html` 第166-420行):
- 所有 JavaScript 代码直接写在 `<script>` 标签内
- 约 260 行内联代码，难以维护
- 与设计文档要求的 `static/js/app.js` 结构不符

### 3.2 页面路径设计

| 设计文档要求 | 当前实现 | 差异描述 |
|-------------|----------|----------|
| `/raw-data/new` 新建页面 | 无独立新建页面，表单在同一页面 | 路由设计不一致 |
| `/results/new` 新建页面 | 无独立新建页面 | 路由设计不一致 |
| `/raw-data/<raw_id>` 详情页 | 无独立详情页，详情弹窗 | 路由设计不一致 |

**设计文档要求路由** (`应用功能设计.md` 第170-190行):
```python
GET  /raw-data/new    # 新建原始数据项目
GET  /results/new     # 新建结果项目
GET  /raw-data/<raw_id>  # 查看原始数据详情
```

---

## 四、完整差异清单

### 4.1 高优先级差异（必须修改）

| 序号 | 模块 | 差异项 | 设计位置 | 当前位置 |
|------|------|--------|----------|----------|
| 1 | 文件管理 | 页面布局应为左右分栏 | 应用功能设计.md:70-90 | files.html |
| 2 | 文件管理 | 文件类型应为2种（原始数据/结果数据） | 应用功能设计.md:15-35 | files.html:168-171 |
| 3 | 文件管理 | 导入弹窗应为两列布局 | 应用功能设计.md:95-145 | files.html:125-148 |
| 4 | 文件管理 | 应支持复选框批量选择文件 | 应用功能设计.md:105-120 | files.html:261-295 |
| 5 | 文件管理 | 查看模块应有筛选功能 | 应用功能设计.md:85-90 | files.html |
| 6 | 文件管理 | 应支持新建项目/选择已有项目 | 应用功能设计.md:98-102 | files.html:125-148 |

### 4.2 中优先级差异（建议修改）

| 序号 | 模块 | 差异项 | 设计位置 | 当前位置 |
|------|------|--------|----------|----------|
| 7 | 文件管理 | 应支持引用文件解析 | 应用功能设计.md:125-140 | 无此功能 |
| 8 | 代码结构 | JS代码应在独立文件 | 应用功能设计.md:15 | 内嵌在HTML中 |
| 9 | 原始数据 | 新建页面应为独立路由 | 应用功能设计.md:170 | raw_data.html |
| 10 | 结果管理 | 新建页面应为独立路由 | 应用功能设计.md:170 | results.html |

---

## 五、修改计划

### 第一阶段：文件管理页面重构（基础）

#### 任务 5.1：重构页面布局
**目标**: 将文件管理页面改为左右分栏布局

**具体步骤**:
1. 读取 `app/templates/files.html` 完整内容
2. 重构 HTML 结构为左右两栏（`col-md-4` / `col-md-8`）
3. 左侧：导入模块（扫描按钮 + 文件夹列表卡片）
4. 右侧：查看模块（筛选下拉框 + 项目列表卡片）

**验收标准**:
- [ ] 页面分为左右两栏
- [ ] 左侧包含扫描按钮和文件夹列表
- [ ] 右侧包含筛选下拉框和项目列表

#### 任务 5.2：统一文件类型分类
**目标**: 将三种文件类型改为两种数据类型

**具体步骤**:
1. 修改 `app/templates/files.html` 中的 JavaScript 数据结构
2. 移除 `processedFiles` 数组，改为文件列表
3. 合并逻辑：所有文件按数据类型（原始数据/结果数据）分类
4. 更新后端 API 返回格式（如需要）

**验收标准**:
- [ ] 只有两种文件类型：原始数据、结果数据
- [ ] 导入时选择数据类型
- [ ] 文件存储路径符合设计要求

#### 任务 5.3：新建导入弹窗
**目标**: 实现符合设计要求的导入弹窗

**具体步骤**:
1. 替换现有的 `select-project-modal` 为新的导入弹窗
2. 实现两列布局
3. 实现新建项目/选择已有项目切换
4. 实现数据类型选择（原始数据/结果数据）
5. 添加项目信息表单（新建项目时显示）
6. 添加文件选择区域（复选框树形结构）

**验收标准**:
- [ ] 弹窗为两列布局
- [ ] 支持新建项目/选择已有项目
- [ ] 支持选择数据类型
- [ ] 支持批量选择文件

#### 任务 5.4：实现查看模块筛选功能
**目标**: 实现右侧查看模块的筛选功能

**具体步骤**:
1. 添加项目编号筛选下拉框
2. 添加查询按钮
3. 实现筛选逻辑
4. 实现详情弹窗

**验收标准**:
- [ ] 有项目编号筛选下拉框
- [ ] 点击查询可筛选项目
- [ ] 点击项目可显示详情弹窗

### 第二阶段：功能增强

#### 任务 5.5：实现引用文件解析功能
**目标**: 实现 .bib/.ris/.enw 文件解析

**具体步骤**:
1. 在导入弹窗添加"引用文件"按钮
2. 实现文件上传逻辑
3. 添加后端 API `/api/parse-reference`
4. 自动填充项目信息表单

**验收标准**:
- [ ] 可上传引用文件
- [ ] 自动解析并填充字段
- [ ] 解析失败显示错误提示

#### 任务 5.6：重构 JavaScript 代码
**目标**: 将内联 JS 移到独立文件

**具体步骤**:
1. 创建 `app/static/js/app.js`
2. 迁移所有 JavaScript 代码
3. 更新 HTML 模板引用

**验收标准**:
- [ ] 有独立的 `app/static/js/app.js`
- [ ] HTML 模板只包含必要的内联脚本

### 第三阶段：其他页面检查

#### 任务 5.7：检查原始数据页面
**目标**: 检查 raw_data.html 与设计一致性

**具体步骤**:
1. 对比 raw_data.html 与设计文档
2. 修正不一致之处
3. 验证功能正常

**验收标准**:
- [ ] 布局符合设计要求
- [ ] 筛选功能正常
- [ ] 新建/查看/删除功能正常

#### 任务 5.8：检查结果管理页面
**目标**: 检查 results.html 与设计一致性

**具体步骤**:
1. 对比 results.html 与设计文档
2. 修正不一致之处
3. 验证功能正常

**验收标准**:
- [ ] 布局符合设计要求
- [ ] 筛选功能正常
- [ ] 新建/查看/删除功能正常

---

## 六、进度追踪

### 任务完成状态

| 任务 | 任务描述 | 状态 | 完成时间 | 备注 |
|------|----------|------|----------|------|
| T1 | 生成差异报告文档 | ✅ 完成 | 2026-01-16 | 本文档 |
| T2 | 重构files.html为左右分栏布局 | ✅ 完成 | 2026-01-16 | 已重构 |
| T3 | 统一文件类型为原始数据/结果数据两种 | ✅ 完成 | 2026-01-16 | UI已调整 |
| T4 | 新建导入弹窗：两列布局+复选框树形结构 | ✅ 完成 | 2026-01-16 | 已实现 |
| T5 | 实现查看模块筛选功能 | ✅ 完成 | 2026-01-16 | 已实现 |
| T6 | 修复模板语法错误 (endblock) | ✅ 完成 | 2026-01-16 | 已修复 |
| T7 | 检查raw_data.html与设计一致性 | ✅ 完成 | 2026-01-16 | 已修正编号格式 |
| T8 | 检查results.html与设计一致性 | ✅ 完成 | 2026-01-16 | 已修正编号格式 |
| T9 | 容器内测试通过 | ✅ 完成 | 2026-01-16 | 所有页面正常 |

### 第二轮发现的新任务

| 任务 | 任务描述 | 状态 | 优先级 | 备注 |
|------|----------|------|--------|------|
| T10 | 修正字段命名：raw_type vs data_type | ⏳ 待修复 | 高 | 数据模型层面 |
| T11 | 添加 field_table 字段 | ⏳ 待修复 | 高 | 区分 raw/result/file |
| T12 | 创建 abbr_mapping 表 | ⏳ 待修复 | 中 | 存储缩写映射 |
| T13 | 创建 components/ 和 macros/ 文件夹 | ⏳ 待修复 | 低 | 可复用组件 |

### 第三轮发现的新任务

| 任务 | 任务描述 | 状态 | 优先级 | 备注 |
|------|----------|------|--------|------|
| T14 | 修正API端点命名 | ⏳ 待修复 | 中 | DELETE /api/projects/<id> |
| T15 | 实现 PUT /api/metadata/sort 端点 | ⏳ 待修复 | 中 | 更新排序 |
| T16 | 实现 POST /api/parse-reference 端点 | ⏳ 待修复 | 中 | 引用文件解析 |

### 第四、五轮发现的低优先级差异

| 任务 | 任务描述 | 状态 | 优先级 | 备注 |
|------|----------|------|--------|------|
| T17 | 创建 templates/components/ 文件夹 | ⏳ 待创建 | 低 | 可复用弹窗组件 |
| T18 | 创建 templates/macros/ 文件夹 | ⏳ 待创建 | 低 | 可复用表单宏 |
| T19 | 重构JS代码到 static/js/app.js | ⏳ 待重构 | 低 | 代码分离 |
| T20 | 创建 abbr_mapping 表 | ⏳ 待创建 | 低 | 存储缩写映射 |

### 详细进度记录

#### 2026-01-16 第一轮 - 基础修复
- [x] 完成设计文档分析
- [x] 完成前端代码分析
- [x] 生成差异报告文档
- [x] 修复模板语法错误 (endblock)
- [x] 重构 files.html 为左右分栏布局
- [x] 修正 raw_data.html 项目编号格式
- [x] 修正 results.html 项目编号格式
- [x] 容器内测试通过

#### 2026-01-16 第二轮 - 字段命名检查
- [x] 发现字段命名不一致：设计要求 `raw_type`，实现是 `data_type`
- [x] 发现缺少 `field_table` 字段用于区分 raw/result/file 配置
- [x] 发现缺少 `abbr_mapping` 表用于存储缩写映射
- [x] 发现缺少 `templates/components/` 和 `templates/macros/` 文件夹

#### 2026-01-16 第三轮 - API端点检查
- [x] 发现API端点命名不一致
- [x] 发现缺少 /api/parse-reference 端点

#### 2026-01-16 第四、五轮 - 基础设施检查
- [x] 检查模板组件文件夹
- [x] 检查数据库表结构
- [x] 容器内综合测试全部通过
- [x] 重构files.html为左右分栏布局
- [x] 统一文件类型为原始数据/结果数据
- [x] 新建导入弹窗（两列布局+复选框）
- [x] 实现查看模块筛选功能
- [x] 检查raw_data.html，修正项目编号格式
- [x] 检查results.html，修正项目编号格式

### 已修改文件清单

| 文件 | 修改内容 | 修改时间 |
|------|----------|----------|
| docs/前端实现差异报告.md | 新建差异报告文档 | 2026-01-16 |
| app/templates/files.html | 重构为左右分栏布局，新建导入弹窗 | 2026-01-16 |
| app/templates/raw_data.html | 修正项目编号格式 RAW-{UUID} | 2026-01-16 |
| app/templates/results.html | 修正项目编号格式 RES-{UUID} | 2026-01-16 |

---

## 七、验证方法

### 7.1 手工测试清单

1. **文件管理页面布局**
   - [ ] 页面分为左右两栏
   - [ ] 左侧有导入模块
   - [ ] 右侧有查看模块

2. **导入功能**
   - [ ] 点击导入按钮显示弹窗
   - [ ] 可选择新建项目或选择已有项目
   - [ ] 可选择数据类型
   - [ ] 可批量选择文件
   - [ ] 可上传引用文件

3. **查看功能**
   - [ ] 可通过项目编号筛选
   - [ ] 可查看项目详情
   - [ ] 详情弹窗显示文件列表

### 7.2 自动化测试建议

后续可添加：
- 页面布局验证测试
- 导入流程 E2E 测试
- API 响应格式验证

---

## 八、附录

### A. 相关文件路径

| 文件 | 路径 | 说明 |
|------|------|------|
| 设计文档 | `/home/hrply/software/bioscience/research/biodata_manager/docs/应用功能设计.md` | 前端功能设计 |
| 设计文档 | `/home/hrply/software/bioscience/research/biodata_manager/docs/数据库设计规范.md` | 数据库设计 |
| 文件管理页面 | `/home/hrply/software/bioscience/research/biodata_manager/app/templates/files.html` | 当前实现 |
| 原始数据页面 | `/home/hrply/software/bioscience/research/biodata_manager/app/templates/raw_data.html` | 待检查 |
| 结果管理页面 | `/home/hrply/software/bioscience/research/biodata_manager/app/templates/results.html` | 待检查 |
| 基础模板 | `/home/hrply/software/bioscience/research/biodata_manager/app/templates/base.html` | 导航结构 |
| 后端服务 | `/home/hrply/software/bioscience/research/biodata_manager/app/server.py` | API路由 |

### B. 设计文档关键章节

| 章节 | 位置 | 关键内容 |
|------|------|----------|
| 文件管理页面布局 | 应用功能设计.md:70-90 | 左右分栏结构 |
| 文件导入功能 | 应用功能设计.md:95-145 | 导入弹窗设计 |
| 文件查看功能 | 应用功能设计.md:145-150 | 筛选和详情 |
| 数据库字段映射 | 应用功能设计.md:35-65 | 数据类型定义 |

---

> 文档版本: 1.0  
> 最后更新: 2026-01-16  
> 维护者: iFlow CLI
