# BioData Manager 前端应用功能设计文档

## 一、系统概述

BioData Manager 是一个生物信息学数据管理系统，采用 **Python Flask + Jinja2 + Bootstrap 5** 技术栈实现。所有代码统一使用 Python 语言，前后端一体化开发。

## 二、技术选型

- **后端框架**: Flask 3.x
- **模板引擎**: Jinja2
- **前端 UI**: Bootstrap 5
- **数据库**: MySQL 8.x
- **HTTP 客户端**: requests (后端内部调用)
- **文件处理**: Python os/shutil 模块

## 三、系统架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        用户浏览器 (Browser)                          │
│                                                                     │
│    Bootstrap 5 CSS + Jinja2 模板渲染的 HTML 页面                    │
│    原始数据 | 结果管理 | 文件管理 | 元数据管理                      │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │ HTTP 请求/响应
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Python Flask 应用                               │
│                                                                     │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │  路由处理    │  │  业务逻辑   │  │  Jinja2     │               │
│   │ /raw-data   │  │  数据库操作 │  │  模板渲染   │               │
│   │ /results    │  │  文件管理   │  │             │               │
│   │ /files      │  │  元数据配置 │  │             │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │                    内部 API 调用                            │   │
│   │    requests.get(f"http://localhost:{port}/api/xxx")        │   │
│   └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │ HTTP (内部)
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     现有 backend.py (API 服务)                       │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │ SQL (MySQL)
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        MySQL 8.4 数据库                             │
│                                                                     │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────────┐  │
│   │field_config │ │raw_project  │ │select_options              │  │
│   │(字段配置)   │ │(原始数据)   │ │(下拉选项)                   │  │
│   └─────────────┘ └─────────────┘ └─────────────────────────────┘  │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────────┐  │
│   │result_project│ │file_record  │ │abbr_mapping                │  │
│   │(结果数据)   │ │(文件记录)   │ │(缩写映射)                   │  │
│   └─────────────┘ └─────────────┘ └─────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

## 四、目录结构

```
app/
├── server.py              # Flask 主应用 + 页面路由
├── backend.py             # 现有 API 服务 (保持不变)
├── database_mysql.py      # 数据库管理
├── init_db.py             # 数据库初始化
├── metadata_config_manager_mysql.py  # 元数据配置管理
├── field_names.py         # 字段名称定义
│
├── templates/             # Jinja2 模板
│   ├── base.html          # 基础模板 (导航、样式)
│   ├── index.html         # 首页
│   ├── raw_data.html      # 原始数据页面
│   ├── results.html       # 结果管理页面
│   ├── files.html         # 文件管理页面
│   ├── metadata.html      # 元数据管理页面
│   ├── components/        # 可复用组件
│   │   ├── modal.html     # 弹窗组件
│   │   ├── filter.html    # 筛选组件
│   │   └── table.html     # 表格组件
│   └── macros/            # Jinja2 宏
│       ├── pagination.html
│       └── form_field.html
│
├── static/                # 静态文件
│   ├── css/
│   │   └── custom.css     # 自定义样式
│   └── js/
│       └── app.js         # 自定义脚本
│
└── docker-entrypoint.sh   # Docker 入口脚本
```

## 五、数据库字段映射

### 5.1 原始数据表 (raw_project) 字段

| 字段名 | 中文名 | 类型 | 必填 | 数据来源 |
|--------|--------|------|------|----------|
| `raw_id` | 项目编号 | VARCHAR(50) | 是 | 自动生成 |
| `raw_title` | 项目名称 | VARCHAR(255) | 是 | 用户输入 |
| `raw_type` | 数据类型 | VARCHAR(50) | 是 | field_config → select_options |
| `raw_species` | 物种 | VARCHAR(50) | 是 | field_config → select_options |
| `raw_tissue` | 组织来源 | VARCHAR(255) | 否 | field_config → select_options (多选) |
| `raw_DOI` | DOI | VARCHAR(100) | 否 | 用户输入 / 引用文件解析 |
| `raw_db_id` | 数据库编号 | VARCHAR(100) | 否 | 用户输入 |
| `raw_db_link` | 数据库链接 | VARCHAR(500) | 否 | 用户输入 |
| `raw_author` | 作者 | VARCHAR(500) | 否 | 用户输入 / 引用文件解析 |
| `raw_article` | 文章标题 | VARCHAR(500) | 否 | 用户输入 / 引用文件解析 |
| `raw_description` | 描述 | TEXT | 否 | 用户输入 |
| `raw_keywords` | 关键词 | VARCHAR(500) | 否 | 用户输入 |

### 5.2 结果数据表 (result_project) 字段

| 字段名 | 中文名 | 类型 | 必填 | 数据来源 |
|--------|--------|------|------|----------|
| `results_id` | 项目编号 | VARCHAR(50) | 是 | 自动生成 |
| `results_title` | 项目名称 | VARCHAR(255) | 是 | 用户输入 |
| `results_type` | 结果类型 | VARCHAR(50) | 是 | field_config → select_options |
| `results_raw` | 关联原始数据 | VARCHAR(50) | 否 | 用户选择 |
| `results_description` | 描述 | TEXT | 否 | 用户输入 |
| `results_keywords` | 关键词 | VARCHAR(500) | 否 | 用户输入 |

### 5.3 元数据字段配置 (field_config) 字段

| 字段 | 说明 |
|------|------|
| `field_id` | 字段标识符 (如 raw_type, raw_species) |
| `field_name` | 字段中文名称 (如 数据类型, 物种) |
| `field_type` | 字段类型 (text/textarea/select/multi_select) |
| `field_table` | 所属项目类型 (raw/result/file) |
| `field_necessary` | 是否必填 (0:否, 1:是) |
| `field_options` | 选项配置 (JSON) |
| `field_seq` | 排序序号 |

## 六、功能模块详细设计

### 6.1 导航布局

```
┌─────────────────────────────────────────────────────────────────────────┐
│  BioData Manager                                         [系统状态]    │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                   │
│  │ 原始数据  │ │ 结果管理  │ │ 文件管理  │ │ 元数据管理│                   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  当前页面内容...                                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 原始数据页面

#### 页面布局

```
┌─────────────────────────────────────────────────────────────────────┐
│  原始数据                                                            │
├─────────────────────────────────────────────────────────────────────┤
│  筛选条件:                                                            │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ...  [重置] [应用筛选]      │
│  │ 数据类型 ▼│ │  物种 ▼  │ │ 样本类型 ▼│                             │
│  └─────────┘  └─────────┘  └─────────┘                             │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 列表                              [新建原始数据项目]          │ │
│  ├───────────────────────────────────────────────────────────────┤ │
│  │  # │ 项目编号     │ 数据类型 │  物种   │ 创建时间 │  操作    │ │
│  ├────┼──────────────┼──────────┼─────────┼──────────┼──────────┤ │
│  │ 1  │ RAW-A1B2C3D4 │ RNA-Seq  │  人类   │ 2024-01  │ [查看]   │ │
│  │ 2  │ RAW-E5F6G7H8 │ 单细胞   │  小鼠   │ 2024-01  │ [查看]   │ │
│  │    │              │          │         │          │ [删除]   │ │
│  └────┴──────────────┴──────────┴─────────┴──────────┴──────────┘ │
│                                                                     │
│  共 X 条记录  [< 1 2 3 >]  每页 [10 ▼] 条                          │
└─────────────────────────────────────────────────────────────────────┘
```

#### 功能说明

1. **筛选模块**
   - 下拉框动态生成，根据 `field_config` 表中 `field_table='raw'` 的字段配置
   - `field_type='select'` 显示为单选下拉
   - `field_type='multi_select'` 显示为多选下拉
   - 筛选条件点击"应用筛选"后生效
   - 支持"重置"按钮清除所有筛选条件

2. **列表模块**
   - 默认按 `created_at` 降序排序
   - 点击列头可排序
   - 列表字段：项目编号、数据类型、物种、创建时间、操作
   - 操作列：查看、删除按钮
   - 分页功能：可设置每页条数（10/20/50/100）

3. **查看详情弹窗** (单列布局 - 特例)
   ```
   ┌─────────────────────────────────────────────────────────┐
   │  项目详情 - RAW-A1B2C3D4                        [X]    │
   ├─────────────────────────────────────────────────────────┤
   │  项目编号: RAW-A1B2C3D4                                │
   │                                                         │
   │  ┌─────────────────────────────────────────────────┐   │
   │  │  数据类型:  [转录组 (RNA-Seq)]                  │   │
   │  │  物种:       [人类 (Homo sapiens)]              │   │
   │  │  样本类型:  [肿瘤组织]                          │   │
   │  │  疾病背景:  [肺癌]                              │   │
   │  │  DOI:        [10.1234/example]                  │   │
   │  │  数据库编号: [PRJ001]                           │   │
   │  │  作者:       [张三, 李四]                       │   │
   │  │  期刊:       [Nature Communications]            │   │
   │  │  创建时间:  [2024-01-15 10:30:00]               │   │
   │  └─────────────────────────────────────────────────┘   │
   │                                                         │
   │  ┌─────────────────────────────────────────────────┐   │
   │  │  标签:  [公开数据] [原始数据]                   │   │
   │  └─────────────────────────────────────────────────┘   │
   │                                                         │
   │  ┌─────────────────────────────────────────────────┐   │
   │  │  描述:                                           │   │
   │  │  ┌─────────────────────────────────────────┐     │   │
   │  │  │ 这是一个RNA-Seq转录组分析项目...        │     │   │
   │  │  └─────────────────────────────────────────┘     │   │
   │  └─────────────────────────────────────────────────┘   │
   │                                         [关闭]         │
   └─────────────────────────────────────────────────────────┘
   ```

   **设计说明:**
   - 所有信息均来自 `raw_project` 表
   - 上半部分：输入框列表展示各元数据字段（只读）
   - 下半部分：标签徽章 + 描述文本域
   - 文件列表：不在此处展示，由文件管理功能处理

4. **新建项目** (两列布局)
   ```
   ┌─────────────────────────────────────────────────────────────────┐
   │  新建原始数据项目                                          [X]  │
   ├─────────────────────────────────────────────────────────────────┤
   │                                                                 │
   │  项目编号: [RAW-A1B2C3D4 ▼]  [📄 引用文件]                      │
   │                                                                 │
   │  项目名称: [__________________________________________]         │
   ├───────────────────────────────────┬─────────────────────────────┤
   │  数据类型: [▼]                    │ 物种: [▼]                   │
   │  样本类型: [多选 ▼]               │ DOI: [____________]          │
   │  数据库编号: [____________]       │ 数据库链接: [______________]│
   │  作者: [_____________________]   │ 文章标题: [________________]│
   ├─────────────────────────────────────────────────────────────────┤
   │  描述:                                                         │
   │  [________________________________________________________]    │
   │  [________________________________________________________]    │
   │                                                                 │
   │                                        [取消]  [保存]           │
   └─────────────────────────────────────────────────────────────────┘
   ```

   - 项目编号独占一行，右侧有"引用文件"按钮
   - 项目名称独占一行（跨两列）
   - 其余字段两两排列
   - 描述字段独占一行（跨两列）

### 6.3 结果管理页面

与原始数据页面结构相同，针对结果数据（`result_project` 表）进行管理。

### 6.4 文件管理页面

#### 页面布局

```
┌─────────────────────────────────────────────────────────────────────┐
│  文件管理                                                            │
├────────────────────────┬────────────────────────────────────────────┤
│  导入模块              │  查看模块                                   │
│                        │                                             │
│  目录扫描:             │  筛选:                                     │
│  [扫描下载目录]        │  ┌─────────┐ [查询]                       │
│                        │  │ 项目编号 ▼│                             │
│  文件夹列表:           │  └─────────┘                               │
│  ┌─────────────────┐  │                                             │
│  │ 📁 sample1      │  │  ┌─────────────────────────────────────┐   │
│  │   [导入] [查看] │  │  │ 项目列表                            │   │
│  └─────────────────┘  │  └─────────────────────────────────────┘   │
│  ┌─────────────────┐  │                                             │
│  │ 📁 sample2      │  │  详情弹窗:                               │
│  │   [导入] [查看] │  │  ┌─────────────────────────────────────┐   │
│  └─────────────────┘  │  │ 项目详情 - RES-XXX          [X]     │   │
│  ┌─────────────────┐  │  ├─────────────────────────────────────┤   │
│  │ 📁 sample3      │  │  │ ☑ file1.fastq.gz      2.3 GB       │   │
│  │   [导入] [查看] │  │  │ ☑ file2.bam           1.8 GB       │   │
│  └─────────────────┘  │  │                   [全选] [下载]     │   │
│                        │  └─────────────────────────────────────┘   │
└────────────────────────┴────────────────────────────────────────────┘
```

#### 6.4.1 文件导入功能

**点击"导入"按钮后的弹窗:**

```
┌─────────────────────────────────────────────────────────────────────┐
│  导入文件 - sample1                                            [X]  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  目标项目:                                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ ○ 新建项目                                                     │   │
│  │ ○ 选择已有项目                                                 │   │
│  │   ┌─────────────────────────┐                                │   │
│  │   │ 请选择项目 (编号 - 名称) ▼│                                │   │
│  │   └─────────────────────────┘                                │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  数据类型:                                                          │
│  ┌─────────────────────────┐                                      │ │
│  │ ○ 原始数据  ○ 结果数据 │                                      │ │
│  └─────────────────────────┘                                      │ │
│                                                                     │
│  项目信息 (新建项目时显示，两列布局):                                │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 项目编号: RAW-A1B2C3D4 (自动生成，可编辑)                     │   │
│  │           [📄 引用文件] ← 点击上传 .bib/.ris/.enw            │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │ 项目名称: [__________________________________________]       │   │
│  ├───────────────────────────┬─────────────────────────────────┤   │
│  │ 数据类型: [▼]             │ 物种: [▼]                       │   │
│  │ 样本类型: [多选 ▼]        │ DOI: [_______________]          │   │
│  │ 作者: [________________] │ 期刊: [_________________]        │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │ 描述:                                                         │   │
│  │ [________________________________________________________]  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  选择文件:                                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 当前目录: /bioraw/downloads/sample1/                       │   │
│  │                                                             │   │
│  │ ☑ ☑ subfolder1/                                            │   │
│  │     ☑ file1.fastq.gz (2.3 GB)                              │   │
│  │     ☑ file2.fastq.gz (2.1 GB)                              │   │
│  │ ☑ ☑ subfolder2/                                            │   │
│  │     ☑ alignment.bam (1.8 GB)                               │   │
│  │                                                             │   │
│  │ [全选] [取消全选]                                            │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                        [取消]  [导入]              │
└─────────────────────────────────────────────────────────────────────┘
```

**引用文件导入功能:**
- 在项目编号右侧显示"📄 引用文件"按钮
- 仅在"新建项目"模式下显示，"选择已有项目"时不显示
- 支持上传格式: `.bib` (BibTeX)、`.ris` (RIS)、`.enw` (EndNote)
- 上传后自动解析文献元数据，自动填充到对应输入框:
  - DOI → `raw_DOI` 字段
  - Title → `raw_title` 项目名称
  - Author → `raw_author` 作者字段
  - Journal → `raw_article` 期刊字段
  - Abstract → `raw_description` 描述字段
- 解析失败时显示错误提示

**导入规则:**
- 项目编号自动生成: `RAW-{UUID}` 或 `RES-{UUID}`
- UUID: 8位数字和大小写字母 (例如: `A1b2C3d4`)
- 文件存储路径: `/bioraw/rawdata/{数据类型缩写}/{物种缩写}/{项目编号}/`
- 缩写来源: `abbr_mapping` 表，通过 `field_id` 区分不同字段类型
  - `field_id='raw_type'` → 获取数据类型缩写
  - `field_id='raw_species'` → 获取物种缩写

#### 6.4.2 文件查看功能

查看已导入项目的文件列表，支持勾选和批量下载。

### 6.5 元数据管理页面

#### 页面布局

```
┌─────────────────────────────────────────────────────────────────────┐
│  元数据管理                                                          │
├──────┬──────┬──────┬───────────────────────────────────────────────┤
│ 原始数据 │ 结果 │ 文件管理 │  [刷新] [更新排序] [保存排序] [备份]    │
└──────┴──────┴──────┴───────────────────────────────────────────────┘
│                                                                     │
│  排序模式: [关闭]                                                    │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 排序 │ 字段标识符  │ 字段名称  │ 类型    │ 必填 │ 操作        │ │
│  ├──────┼─────────────┼───────────┼─────────┼──────┼─────────────┤ │
│  │ [1]  │ raw_type    │ 数据类型  │ 下拉选择│ 是   │ [编辑] [删] │ │
│  │ [2]  │ raw_species │ 物种      │ 下拉选择│ 是   │ [编辑] [删] │ │
│  │ [3]  │ raw_tissue  │ 组织来源  │ 多选    │ 否   │ [编辑] [删] │ │
│  │ [4]  │ raw_DOI     │ DOI       │ 文本    │ 否   │ [编辑] [删] │ │
│  │ [5]  │ raw_author  │ 作者      │ 文本    │ 否   │ [编辑] [删] │ │
│  └──────┴─────────────┴───────────┴─────────┴──────┴─────────────┘ │
│                                                                     │
│  [添加字段]                                                          │
└─────────────────────────────────────────────────────────────────────┘
```

#### 功能说明

1. **标签切换**: 点击"原始数据"、"结果"、"文件管理"切换不同的元数据配置
   - `field_table='raw'` → 原始数据
   - `field_table='result'` → 结果数据
   - `field_table='file'` → 文件管理

2. **刷新按钮**: 从 `field_config` 表重新获取配置

3. **更新排序按钮**: 排序列变为可编辑输入框

4. **保存排序按钮**: 保存新的排序到 `field_config.field_seq`

5. **备份按钮**: 导出数据库为压缩包

6. **编辑字段弹窗**
   ```
   ┌─────────────────────────────────────────────────────────┐
   │  编辑字段配置                                    [X]    │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │  字段标识符: raw_type (只读)                            │
   │                                                         │
   │  字段名称: _____________ [必填]                        │
   │                                                         │
   │  字段类型: ○ 文本  ○ 文本域  ○ 下拉选择  ○ 多选        │
   │                                                         │
   │  是否必填: ○ 是  ○ 否                                  │
   │                                                         │
   │  排序序号: _____________                               │
   │                                         [取消] [保存]   │
   └─────────────────────────────────────────────────────────┘
   ```

## 七、Flask 路由设计

### 7.1 页面路由

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/` | 首页/仪表盘 |
| GET | `/raw-data` | 原始数据列表 |
| GET | `/raw-data/new` | 新建原始数据项目 |
| GET | `/raw-data/<raw_id>` | 查看原始数据详情 |
| POST | `/raw-data` | 创建原始数据项目 |
| POST | `/raw-data/delete` | 删除原始数据项目 |
| GET | `/results` | 结果数据列表 |
| GET | `/results/new` | 新建结果项目 |
| GET | `/results/<results_id>` | 查看结果详情 |
| POST | `/results` | 创建结果项目 |
| POST | `/results/delete` | 删除结果项目 |
| GET | `/files` | 文件管理 |
| POST | `/files/scan` | 扫描下载目录 |
| POST | `/files/import` | 导入文件 |
| GET | `/files/<project_type>/<project_id>` | 查看项目文件 |
| POST | `/files/download` | 下载文件 |
| GET | `/metadata` | 元数据配置 |
| POST | `/metadata/add` | 添加字段 |
| POST | `/metadata/edit` | 编辑字段 |
| POST | `/metadata/delete` | 删除字段 |
| POST | `/metadata/sort` | 更新排序 |
| GET | `/metadata/backup` | 备份数据库 |

### 7.2 API 路由 (内部调用)

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/projects` | 获取项目列表 |
| POST | `/api/projects` | 创建项目 |
| GET | `/api/projects/<id>` | 获取项目详情 |
| DELETE | `/api/projects/<id>` | 删除项目 |
| GET | `/api/metadata/<category>` | 获取元数据配置 |
| POST | `/api/metadata` | 添加字段 |
| PUT | `/api/metadata/<id>` | 更新字段 |
| DELETE | `/api/metadata/<id>` | 删除字段 |
| PUT | `/api/metadata/sort` | 更新排序 |
| GET | `/api/files/scan` | 扫描下载目录 |
| POST | `/api/files/import` | 导入文件 |
| GET | `/api/files/<project_id>` | 获取项目文件 |
| GET | `/api/files/download` | 下载文件 |
| POST | `/api/parse-reference` | 解析引用文件 |

## 八、模板设计

### 8.1 基础模板 (base.html)

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}BioData Manager{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">BioData Manager</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'raw_data' %}active{% endif %}" 
                           href="{{ url_for('raw_data') }}">原始数据</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'results' %}active{% endif %}" 
                           href="{{ url_for('results') }}">结果管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'files' %}active{% endif %}" 
                           href="{{ url_for('files') }}">文件管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'metadata' %}active{% endif %}" 
                           href="{{ url_for('metadata') }}">元数据管理</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container-fluid py-4">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert alert-info">{{ messages[0] }}</div>
        {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>
```

### 8.2 动态表单生成 (两列布局)

```html
{% macro render_form_field(field, value='') %}
<div class="col-md-6 mb-3">
    <label class="form-label">
        {{ field.field_name }}
        {% if field.field_necessary %}<span class="text-danger">*</span>{% endif %}
    </label>
    
    {% if field.field_type == 'text' %}
        <input type="text" name="{{ field.field_id }}" 
               class="form-control" value="{{ value or '' }}"
               {% if field.field_necessary %}required{% endif %}>
    
    {% elif field.field_type == 'textarea' %}
        <textarea name="{{ field.field_id }}" class="form-control" rows="3"
                  {% if field.field_necessary %}required{% endif %}>{{ value or '' }}</textarea>
    
    {% elif field.field_type == 'select' %}
        <select name="{{ field.field_id }}" class="form-select"
                {% if field.field_necessary %}required{% endif %}>
            <option value="">请选择...</option>
            {% for opt in field.options %}
            <option value="{{ opt.value }}" {% if value == opt.value %}selected{% endif %}>
                {{ opt.label }}
            </option>
            {% endfor %}
        </select>
    
    {% elif field.field_type == 'multi_select' %}
        <select name="{{ field.field_id }}" class="form-select" multiple
                {% if field.field_necessary %}required{% endif %}>
            {% for opt in field.options %}
            <option value="{{ opt.value }}" {% if value in (value or [])|split(',') %}selected{% endif %}>
                {{ opt.label }}
            </option>
            {% endfor %}
        </select>
    {% endif %}
</div>
{% endmacro %}
```

## 九、数据流

### 9.1 新建项目流程

```
1. 用户访问 /raw-data/new
2. Flask 调用 /api/metadata/raw 获取 field_config
3. 前端渲染表单（两列布局）
4. 用户填写表单，点击"保存"
5. POST /raw-data
6. Flask 调用 /api/projects 创建项目
7. 返回成功，跳转 /raw-data
```

### 9.2 筛选流程

```
1. 用户在筛选模块选择条件
2. 点击"应用筛选"
3. GET /raw-data?type=rnaseq&species=Homo sapiens
4. Flask 调用 /api/projects?type=rnaseq&species=Homo sapiens
5. 后端查询 raw_project 表
6. 返回结果，渲染列表
```

### 9.3 文件导入流程

```
1. 用户点击文件夹的"导入"按钮
2. 弹窗显示，选择"新建项目"
3. 点击"📄 引用文件"，上传 .bib 文件
4. POST /api/parse-reference 解析文献
5. 自动填充表单字段
6. 用户选择要导入的文件
7. 点击"导入"
8. POST /api/files/import
9. 后端:
   - 复制文件到 /bioraw/rawdata/{abbr}/{abbr}/{raw_id}/
   - 创建 file_record 记录
   - 更新 raw_project.file_count 和 total_size
10. 返回成功，刷新页面
```

## 十、响应式设计

| 断点 | 屏幕宽度 | 布局变化 |
|------|----------|----------|
| xs | <576px | 单列布局 |
| sm | ≥576px | 两列布局 |
| md | ≥768px | 三列布局 |
| lg | ≥992px | 四列布局 |
| xl | ≥1200px | 全宽布局 |

---

**文档版本**: 3.0  
**创建时间**: 2026-01-16  
**技术栈**: Python Flask + Jinja2 + Bootstrap 5  
**数据库**: MySQL 8.x (详见 docs/数据库设计规范.md)
