# BioData Manager 应用功能设计文档

## 一、系统概述

BioData Manager 是一个生物信息学数据管理系统，用于管理原始测序数据、分析结果和相关元数据。采用 **Python Flask + Jinja2 + Bootstrap 5** 技术栈，提供完整的项目管理、文件管理和元数据配置功能。

## 二、技术选型

| 类别 | 技术 | 说明 |
|------|------|------|
| 后端框架 | Flask 3.x | Python Web 框架 |
| 模板引擎 | Jinja2 | Flask 模板渲染 |
| 前端 UI | Bootstrap 5 | 本地化 CSS/JS |
| 数据库 | MySQL 8.x | 主数据存储 |
| HTTP 客户端 | jQuery AJAX | 异步请求处理 |
| 文件处理 | Python os/shutil | 本地文件管理 |

## 三、系统架构

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        用户浏览器 (Browser)                          │
│                                                                     │
│    Bootstrap 5 + Jinja2 模板 + jQuery AJAX                         │
│    ┌─────────────────────────────────────────────────────────┐     │
│    │  原始数据  │  结果管理  │  文件管理  │  元数据管理       │     │
│    └─────────────────────────────────────────────────────────┘     │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │ HTTP 请求/响应
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Python Flask 应用 (server.py)                   │
│                                                                     │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │  页面路由    │  │  业务逻辑   │  │  API 接口   │               │
│   │ /raw-data   │  │ Backend     │  │ /api/*      │               │
│   │ /results    │  │ Manager     │  │             │               │
│   │ /files      │  │             │  │             │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │              DatabaseManager (连接池管理)                    │   │
│   │         mysql.connector.pooling.MySQLConnectionPool         │   │
│   └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │ SQL (MySQL)
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        MySQL 8.4 数据库                             │
│                                                                     │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────────┐  │
│   │field_config │ │raw_project  │ │select_options              │  │
│   │(字段配置)   │ │(原始数据)   │ │(下拉选项)                   │  │
│   └─────────────┘ └─────────────┘ └─────────────────────────────┘  │
│   ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────────┐  │
│   │result_project│ │file_record  │ │abbr_mapping                │  │
│   │(结果数据)   │ │(文件记录)   │ │(缩写映射)                   │  │
│   └─────────────┘ └─────────────┘ └─────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 连接池架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                    DatabaseManager 连接池架构                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   Flask 请求         请求处理          连接池操作                     │
│                                                                     │
│   请求A ──────────► get_connection() ──► 从池获取连接 #1           │
│                       │                    │                         │
│                       ▼                    ▼                         │
│                   query()              执行 SQL                      │
│                       │                    │                         │
│                       ▼                    ▼                         │
│                   finally: ──► connection.close() 归还连接          │
│                       │                                              │
│   请求B ──────────► get_connection() ──► 从池获取连接 #2           │
│                       │                    │                         │
│                       ▼                    ▼                         │
│                   execute()             执行 SQL                      │
│                       │                    │                         │
│                       ▼                    ▼                         │
│                   finally: ──► connection.close() 归还连接          │
│                                                                     │
│   连接池配置: pool_size=20, pool_reset_session=True                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 四、目录结构

```
app/
├── server.py              # Flask 主应用 + 页面路由 + API 接口
├── backend.py             # 业务逻辑层 (BioDataManager)
├── database_mysql.py      # 数据库管理 (DatabaseManager + 连接池)
├── citation_parser.py     # 引文解析模块 (BibTeX/RIS/ENW)
├── init_db.py             # 数据库初始化脚本
├── metadata_config_manager_mysql.py  # 元数据配置管理
├── field_names.py         # 字段名称定义
│
├── templates/             # Jinja2 模板
│   ├── base.html          # 基础模板 (导航、样式、AJAX 封装)
│   ├── index.html         # 首页/仪表盘
│   ├── raw_data.html      # 原始数据页面
│   ├── results.html       # 结果管理页面
│   ├── files.html         # 文件管理页面
│   ├── metadata.html      # 元数据管理页面
│   └── error.html         # 错误页面
│
├── static/                # 静态文件 (本地化)
│   ├── css/
│   │   ├── bootstrap.min.css
│   │   └── bootstrap-icons.css
│   └── js/
│       ├── bootstrap.bundle.min.js
│       └── jquery.min.js
│
└── docker-entrypoint.sh   # Docker 入口脚本
```

## 五、核心模块设计

### 5.1 数据库管理模块 (database_mysql.py)

#### 5.1.1 DatabaseManager 类

```python
class DatabaseManager:
    """数据库管理器 - 使用连接池支持并发请求"""
    
    _pool = None          # 类级别连接池
    _pool_lock = None     # 线程安全锁
    
    def __init__(self):
        """初始化"""
        self.connection = None
        self.config = self._load_config()
    
    def get_connection(self):
        """从连接池获取连接 (不缓存实例变量)"""
        if self._pool:
            return self._pool.get_connection()
        return None
    
    def query(self, query, params=None):
        """查询多条记录 (自动获取/归还连接)"""
        connection = self.get_connection()
        if connection is None:
            return []
        
        cursor = None
        try:
            cursor = connection.cursor()
            cursor.execute(query, params)
            return cursor.fetchall()
        except Error as e:
            print(f"查询失败: {e}")
            return []
        finally:
            if cursor:
                cursor.close()
            if connection:
                connection.close()
```

#### 5.1.2 连接池配置

```python
cls._pool = pooling.MySQLConnectionPool(
    pool_name="biodata_pool",
    pool_size=20,              # 支持 20 个并发连接
    pool_reset_session=True,   # 重置会话状态
    **config
)
```

#### 5.1.3 连接生命周期

```
请求进入
    │
    ▼
get_connection() ──────► 从连接池获取连接
    │
    ▼
执行 SQL (query/execute)
    │
    ▼
finally:
    cursor.close()    ────► 关闭游标
    connection.close() ────► 归还连接到池
    │
    ▼
请求完成
```

**关键原则**:
- 每个数据库操作都独立获取/归还连接
- 不在实例变量中缓存连接
- 始终在 finally 块中释放资源

### 5.2 业务逻辑模块 (backend.py)

#### 5.2.1 BioDataManager 类

```python
class BioDataManager:
    """生物数据业务管理器"""
    
    def __init__(self, db_manager, config_manager):
        self.db_manager = db_manager
        self.config_manager = config_manager
    
    def get_all_raw_projects(self):
        """获取所有原始数据项目"""
        return self.db_manager.query("""
            SELECT * FROM raw_project ORDER BY created_at DESC
        """)
    
    def get_all_result_projects(self):
        """获取所有结果数据项目"""
        return self.db_manager.query("""
            SELECT * FROM result_project ORDER BY created_at DESC
        """)
    
    def create_raw_project(self, data):
        """创建原始数据项目"""
        raw_id = f"RAW_{uuid.uuid4().hex[:8].upper()}"
        # ... 插入数据
        return raw_id
```

### 5.3 Flask 应用模块 (server.py)

#### 5.3.1 单例模式管理器

```python
_db_manager = None
_config_manager = None
_manager = None

def get_db_manager():
    """获取数据库管理器 (延迟初始化)"""
    global _db_manager
    if _db_manager is None:
        _db_manager = DatabaseManager()
    return _db_manager
```

#### 5.3.2 页面路由

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/` | 首页 |
| GET | `/raw-data` | 原始数据列表 |
| GET | `/results` | 结果管理列表 |
| GET | `/files` | 文件管理 |
| GET | `/metadata` | 元数据配置 |

#### 5.3.3 API 路由

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/projects` | 获取项目列表 |
| GET | `/api/projects?table=result` | 获取结果项目 |
| POST | `/api/projects` | 创建项目 |
| DELETE | `/api/projects/<type>/<id>` | 删除项目 |
| GET | `/api/metadata/config` | 获取元数据配置 |
| POST | `/api/files/scan` | 扫描目录 |
| POST | `/api/files/import` | 导入文件 |

### 5.4 前端模块 (templates/)

#### 5.4.1 基础模板 (base.html) - AJAX 封装

```javascript
// 连接池相关配置
const AJAX_POOL = {
    getDebounceMs: 200,    // GET 请求防抖间隔
    postDebounceMs: 500,   // POST/PUT/DELETE 防抖间隔
    pending: new Map()     // 待处理请求
};

// 防抖函数
function debounce(fn, delay) {
    return function(...args) {
        const key = `${fn.name}_${JSON.stringify(args)}`;
        if (AJAX_POOL.pending.has(key)) {
            return AJAX_POOL.pending.get(key);
        }
        const promise = new Promise((resolve) => {
            setTimeout(() => {
                AJAX_POOL.pending.delete(key);
                resolve(fn.apply(this, args));
            }, delay);
        });
        AJAX_POOL.pending.set(key, promise);
        return promise;
    };
}

// API 调用封装
const apiGet = debounce(function(url, params = {}) {
    return $.get(url, params);
}, AJAX_POOL.getDebounceMs);

const apiPost = debounce(function(url, data = {}) {
    return $.ajax({
        url: url,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data)
    });
}, AJAX_POOL.postDebounceMs);
```

#### 5.4.2 前端加载流程

```
页面加载 (base.html)
    │
    ▼
$(document).ready()
    │
    ├──► 初始化工具提示
    │
    └──► 页面特定初始化 (raw_data.html / results.html)
            │
            ├──► apiGet('/api/metadata/config')
            │        │
            │        ▼
            │    渲染筛选下拉框
            │
            ├──► apiGet('/api/projects?table=xxx')
            │        │
            │        ▼
            │    渲染数据表格
            │
            └──► 绑定事件处理器
                    │
                    ▼
                用户交互 (筛选/刷新/编辑)
                    │
                    └──► 防抖控制 → AJAX 请求
```

## 六、数据库设计

### 6.1 数据表结构

| 表名 | 说明 | 核心字段 |
|------|------|----------|
| `field_config` | 元数据字段配置 | field_id, field_name, field_type, field_table, **field_readonly** |
| `raw_project` | 原始数据项目 | raw_id, raw_title, raw_type, raw_species |
| `result_project` | 结果数据项目 | results_id, results_title, results_type, results_raw |
| `file_record` | 文件记录 | file_name, file_path, file_project_type, file_project_id |
| `select_options` | 下拉选项 | option_type, option_value, option_label |
| `abbr_mapping` | 缩写映射 | field_id, full_name, abbr_name |

> **field_readonly 字段说明**: 用于控制字段是否可编辑。`0` = 可编辑，`1` = 只读（系统自动管理）。系统在导入文件时会自动更新 `raw_file_count`、`raw_total_size`、`results_file_count`、`results_total_size` 等统计字段，这些字段标记为只读。

### 6.2 字段类型映射

| field_type 值 | 前端组件 | 说明 |
|---------------|----------|------|
| `text` | `<input type="text">` | 单行文本 |
| `textarea` | `<textarea>` | 多行文本 |
| `select` | `<select>` | 选择下拉 |

**下拉框行为模式**：
- **新建项目/编辑项目**：使用 `multi_select` 模式（可多选，用逗号分隔存储）
- **文件导入**：使用 `single_select` 模式（仅单选）

## 七、功能模块详细设计

### 7.1 原始数据管理

#### 功能特性
- 项目列表展示与分页
- 多条件筛选 (数据类型、物种、组织来源等)
- 项目详情查看 (弹窗展示)
- 新建/编辑/删除项目
- 文献引用文件导入 (.bib/.ris/.enw)

#### 项目编号规则
```
格式: {TYPE}_{8位UUID}

TYPE:
- 原始数据: RAW
- 结果数据: RES

示例:
- RAW_L22Y86D7
- RES_A1B2C3D4

UUID规则:
- 字符集: 0-9, A-Z, a-z (共62个字符)
- 长度: 8位
- 由 backend.py 的 generate_project_id() 生成
```

#### 页面布局
```
┌─────────────────────────────────────────────────────────────────┐
│  原始数据                                    [新建原始数据项目] │
├─────────────────────────────────────────────────────────────────┤
│  筛选条件:                                                          │
│  [数据类型 ▼] [物种 ▼] [组织来源 ▼]  [重置] [应用筛选]          │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ # │ 项目编号   │ 数据类型 │ 物种  │ 创建时间 │ 操作    │   │
│  ├────┼───────────┼──────────┼───────┼──────────┼─────────┤   │
│  │ 1 │ RAW_L22Y86D7 │ RNA-Seq  │ 人类  │ 2026-01  │ [查看]  │   │
│  │   │           │          │       │          │ [删除]  │   │
│  └────┴───────────┴──────────┴───────┴──────────┴─────────┘   │
│                                                                 │
│  共 X 条记录  [< 1 2 3 >]  每页 [10 ▼] 条                       │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 结果数据管理

与原始数据管理功能相同，针对 `result_project` 表进行管理。

#### 特有功能
- 关联原始数据项目 (`results_raw` 字段)
- 结果类型分类 (DEA、Marker、Enrichment、PPI、Network 等)

### 7.3 文件管理

#### 功能特性
- 扫描下载目录结构
- 导入文件到项目
- 项目文件查看与下载
- 批量选择与下载

#### 文件导入表单
导入文件时，系统根据数据类型（原始数据/结果数据）动态加载元数据字段配置：

**目标项目选择**：
- **[新建项目]**: 切换到新建项目模式，显示完整元数据表单
- **[选择已有项目]**: 切换到选择已有项目模式，显示项目下拉选择框
- 下拉框选项格式: `项目编号|项目标题`（如 `RAW_A1B2C3D4|肺癌mRNAseq研究`）

**原始数据导入表单布局**：
```
┌─────────────────────────────────────────────────────────┐
│ 目标项目: [新建项目]  ◉ [选择已有项目]                   │
├─────────────────────────────────────────────────────────┤
│ 数据类型: ● [原始数据]  ○ [结果数据]                    │
├─────────────────────────────────────────────────────────┤
│ 选择已有项目: [RAW_A1B2C3D4|肺癌mRNAseq研究 ▼]         │
├─────────────────────────────────────────────────────────┤
│ 项目编号: RAW_A1B2C3D4   (只读)                         │
│ 数据类型: [mRNAseq ▼]       (可编辑，single_select)     │
│ 物种:     [Homo sapiens ▼]  (可编辑，single_select)     │
├─────────────────────────────────────────────────────────┤
│ 选择文件: [全选] [取消全选]                              │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ ☑ file1.fastq  ☑ file2.fastq                       │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

**结果数据导入表单布局**：
```
┌─────────────────────────────────────────────────────────┐
│ 目标项目: [新建项目]  ◉ [选择已有项目]                   │
├─────────────────────────────────────────────────────────┤
│ 数据类型: ○ [原始数据]  ● [结果数据]                    │
├─────────────────────────────────────────────────────────┤
│ 选择已有项目: [RES_X1Y2Z3|差异分析结果 ▼]               │
├─────────────────────────────────────────────────────────┤
│ 项目编号: RES_X1Y2Z3   (只读)                           │
│ 分析类型: [DEA ▼]              (可编辑，single_select)  │
├─────────────────────────────────────────────────────────┤
│ 选择文件: [全选] [取消全选]                              │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ ☑ result.csv  ☑ stats.txt                          │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

**元数据字段显示规则**：
- 原始数据: 显示元数据编号 2-4 号字段（raw_type、raw_species、raw_tissue），共 3 栏
- 结果数据: 显示元数据编号 2-3 号字段（results_type），共 2 栏
- 所有字段均为可编辑字段（single_select 模式）

**选择已有项目时的追加导入规则**：
- 同一个原始数据项目可以包含不同种属、不同数据类型、不同样本来源的原始数据
- 同一个结果项目也可以包含不同的分析类型
- **如果修改了字段值（如 raw_type 从 mRNAseq 改为 sRNAseq）**，新导入的文件将存储到新路径（追加模式），原路径文件保持不变
- **存储路径计算**：根据导入时选择的字段值动态确定存储目录


**文件导入流程**：
```
用户选择文件夹 ──► 选择目标项目/新建项目 ──► 选择导入文件 ──► 确认导入
                                                                    │
                                                                    ▼
                                                        复制文件到存储目录
                                                        创建 file_record 记录
                                                        更新项目文件计数
```

#### 存储目录结构

**原始数据存储**：
```
/bio/rawdata/
└── {数据类型}/
    └── {物种}/
        └── {样本来源}/
            └── {项目编号}/
                ├── sample1.fastq
                ├── sample2.fastq
                └── ...

目录规则:
- 数据类型: 如 mRNAseq、sRNAseq、蛋白组 等（来自 raw_type）
- 物种: 如 Homo sapiens、Mus musculus 等（来自 raw_species）
- 样本来源: 可选，如 Lung、Liver 等（来自 raw_tissue，为空时省略该层级）
- 项目编号: 如 RAW_A1B2C3D4（自动生成）
```

**结果数据存储**：
```
/bio/results/
└── {项目编号}/
    └── {分析类型}/
        ├── result1.csv
        ├── result2.csv
        └── ...

目录规则:
- 项目编号: 如 RES_X1Y2Z3（关联的原始项目编号）
- 分析类型: 如 DEA、Marker、Enrichment 等（来自 results_type）
```

**相对路径格式**：
- 原始数据: `./数据类型/物种/样本来源/项目编号/`（四级结构，样本来源可选）
- 结果数据: `./项目编号/分析类型/`（二级结构）
- 所有路径均为相对于 `/bio/rawdata` 或 `/bio/results` 根目录的相对路径

### 7.4 元数据配置

#### 功能特性
- 动态字段配置管理
- 字段类型编辑
- **只读字段设置 (`field_readonly`)**: 可设置字段为系统自动管理（文件导入时自动更新）
- 下拉选项管理
- 字段排序调整
- 数据库备份

#### 字段配置管理
```
┌─────────────────────────────────────────────────────────────┐
│  元数据配置                      [刷新] [更新排序] [备份]  │
├────────┬────────┬────────┬─────────────────────────────────┤
│ 原始数据│ 结果   │ 文件   │                                 │
└────────┴────────┴────────┴─────────────────────────────────┘
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 排序 │ 字段标识符  │ 字段名称 │ 类型    │ 必填 │ 排列方式 │ 只读 │ 操作│   │
│  ├──────┼────────────┼──────────┼─────────┼──────┼──────────┼──────┼──────┤   │
│  │ [1]  │ raw_type   │ 数据类型 │ 下拉选择│ 是   │ 两列     │ 否   │ [编辑]│   │
│  │ [2]  │ raw_species│ 物种     │ 下拉选择│ 是   │ 两列     │ 否   │ [编辑]│   │
│  │ [12] │ raw_file_count │ 文件数量 │ 文本  │ 否   │ 两列     │ 是   │ [编辑]│   │
│  └──────┴────────────┴──────────┴─────────┴──────┴──────────┴──────┴──────┘   │
│                                                             │
│  列说明:                                                     │
│  - 排序: 拖拽调整字段显示顺序                                │
│  - 字段标识符: 数据库字段名称 (如 raw_type)                  │
│  - 字段名称: 前端显示的标签名称                              │
│  - 类型: 文本/多行文本/单选/多选                            │
│  - 必填: 是否为必填字段                                     │
│  - 排列方式: 单列(占满整行) 或 两列(默认)                    │
│  - 只读: 是否为系统自动管理字段 (不可手动编辑)               │
│                                                             │
│  [添加字段]                                                 │
└─────────────────────────────────────────────────────────────┘
```

## 八、API 接口设计

### 8.1 项目相关接口

#### 获取项目列表
```
GET /api/projects?table=raw|result

Response:
{
    "success": true,
    "data": [
        {
            "id": 1,
            "raw_id": "RAW-A1B2C3D4",
            "raw_title": "项目名称",
            "raw_type": "mRNAseq",
            "raw_species": "Homo sapiens",
            ...
        }
    ],
    "total": 10
}
```

#### 创建项目
```
POST /api/projects
Content-Type: application/json

{
    "table": "raw",
    "data": {
        "raw_title": "项目名称",
        "raw_type": "mRNAseq",
        "raw_species": "Homo sapiens",
        ...
    }
}

Response:
{"success": true, "message": "创建成功", "id": "RAW-A1B2C3D4"}
```

### 8.2 元数据配置接口

#### 获取配置
```
GET /api/metadata/config

Response:
{
    "success": true,
    "config": [
        {
            "id": 1,
            "field_id": "raw_type",
            "field_name": "数据类型",
            "field_type": "select",
            "field_table": "raw",
            "field_necessary": true,
            "field_readonly": false,
            "field_placeholder": "2",
            "field_seq": 2,
            "field_options": [
                {"value": "mRNAseq", "label": "mRNAseq"},
                {"value": "miRNAseq", "label": "miRNAseq"}
            ]
        },
        {
            "id": 12,
            "field_id": "raw_file_count",
            "field_name": "文件数量",
            "field_type": "text",
            "field_table": "raw",
            "field_necessary": false,
            "field_readonly": true,
            "field_placeholder": "2",
            "field_seq": 12,
            "field_options": null
        }
    ]
}
```

**响应字段说明**:
- `field_placeholder`: 排列方式，`1`=单列显示，`2`=两列显示
- `field_readonly`: 只读属性，`0`=可编辑，`1`=系统自动管理

### 8.3 文件管理接口

#### 扫描目录
```
POST /api/files/scan
Content-Type: application/json

{"path": "/downloads/test_project"}

Response:
{
    "success": true,
    "files": [
        {"name": "sample.fastq", "path": "...", "size": 1024000}
    ]
}
```

## 九、性能优化

### 9.1 数据库连接池

```python
# 优化配置
pool_size=20              # 根据并发需求调整
pool_reset_session=True   # 重置会话状态
connection_timeout=30     # 连接超时时间
```

**优化效果**:
- 避免频繁创建/销毁连接
- 支持并发请求处理
- 减少数据库服务器负载

### 9.2 请求防抖

```javascript
// 防抖配置
const AJAX_POOL = {
    getDebounceMs: 200,    // GET 请求 200ms
    postDebounceMs: 500    // POST 请求 500ms
};
```

**优化效果**:
- 防止用户快速点击导致的重复请求
- 减少数据库查询压力
- 提升前端响应体验

### 9.3 连接生命周期管理

```python
# 每个操作独立获取/归还连接
def query(self, query, params=None):
    connection = self.get_connection()
    try:
        # 执行查询
        cursor.execute(query, params)
        return cursor.fetchall()
    finally:
        # 始终释放资源
        cursor.close()
        connection.close()
```

**优化效果**:
- 防止连接泄漏
- 确保连接及时归还池
- 避免连接耗尽

## 十、部署架构

### 10.1 Docker 部署

```
┌─────────────────────────────────────────────────────────────────┐
│                      Docker Compose                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────┐    ┌─────────────────────┐           │
│  │ biodata-manager     │    │ biodata-mysql       │           │
│  │ - Flask 8000        │───►│ - MySQL 3306        │           │
│  │ - 连接池 20         │    │                     │           │
│  └─────────────────────┘    └─────────────────────┘           │
│                                                                 │
│  端口映射:                                                         │
│  - 20425:8000 (对外)                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 10.2 数据存储

```
/bioraw/
├── rawdata/          # 原始数据存储
│   └── {abbr}/{abbr}/{abbr}/{raw_id}/
├── downloads/        # 下载目录 (扫描导入)
├── results/          # 结果数据存储
└── analysis/         # 分析结果存储
```

## 十一、引文解析模块

### 11.1 模块概述

引文解析模块用于解析文献引用文件（.bib、.ris、.enw），自动提取文献信息并填充项目元数据。

### 11.2 文件结构

```
app/
├── citation_parser.py   # 引文解析模块
```

### 11.3 CitationParser 类

```python
class CitationParser:
    """文献引用解析器"""
    
    SUPPORTED_FORMATS = ['.bib', '.ris', '.enw']
    
    def parse_file(self, file_path: str) -> List[Dict[str, Any]]:
        """解析引文文件"""
        # 根据文件扩展名自动选择解析方式
        # 支持 BibTeX、RIS、ENW 格式
        
    def parse_content(self, content: str, format_type: str) -> List[Dict[str, Any]]:
        """直接解析内容字符串"""
        
    def citation_to_project(self, citation: Dict[str, Any]) -> Dict[str, Any]:
        """将引文信息转换为项目数据"""
```

### 11.4 支持的格式

| 格式 | 扩展名 | 说明 |
|------|--------|------|
| BibTeX | .bib | LaTeX 文献引用格式 |
| RIS | .ris | 研究信息标准格式 |
| ENW | .enw | EndNote 引用格式 |

### 11.5 API 接口

```python
@app.route('/api/parse-citation', methods=['POST'])
def api_parse_citation():
    """解析引文文件
    
    请求:
    - Content-Type: multipart/form-data
    - file: 引文文件 (.bib, .ris, .enw)
    
    响应:
    {
        "success": true,
        "count": 1,
        "citations": [{
            "citation": {...},  # 原始解析结果
            "project": {...}    # 转换为项目数据
        }]
    }
    """
```

### 11.6 工作流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     引文解析工作流程                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 用户上传文件 (.bib/.ris/.enw)                               │
│           │                                                     │
│           ▼                                                     │
│  2. 前端 POST /api/parse-citation                               │
│           │                                                     │
│           ▼                                                     │
│  3. 后端保存临时文件                                            │
│           │                                                     │
│           ▼                                                     │
│  4. CitationParser 解析内容                                     │
│           │                                                     │
│           ▼                                                     │
│  5. 转换为项目数据格式                                          │
│           │                                                     │
│           ▼                                                     │
│  6. 返回解析结果                                                │
│           │                                                     │
│           ▼                                                     │
│  7. 前端自动填充表单                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 11.7 提取的字段

| 引文字段 | 项目字段 | 说明 |
|----------|----------|------|
| title | raw_title | 文献标题 |
| author | (处理中) | 作者列表 |
| year | - | 出版年份 |
| journal | - | 期刊名称 |
| doi | raw_DOI | DOI 号 |
| abstract | raw_description | 摘要 |
| keywords | raw_keywords | 关键词 |

## 十二、错误处理

### 11.1 前端错误处理

```javascript
// 统一错误处理
$.ajaxSetup({
    timeout: 30000,
    error: function(xhr, status, error) {
        showToast('请求失败: ' + error, 'error');
    }
});

// Loading 状态管理
let loadingCount = 0;
function showLoading() {
    loadingCount++;
    if (loadingCount === 1) $('#loading').show();
}
function hideLoading() {
    loadingCount--;
    if (loadingCount <= 0) {
        loadingCount = 0;
        $('#loading').hide();
    }
}
```

### 11.2 后端错误处理

```python
@app.errorhandler(500)
def internal_error(error):
    return render_template('error.html', message="服务器内部错误"), 500

@app.errorhandler(404)
def not_found_error(error):
    return render_template('error.html', message="页面不存在"), 404
```

---

**文档版本**: 6.1  
**更新日期**: 2026-01-20  
**技术栈**: Python Flask + Jinja2 + Bootstrap 5 + MySQL  
**主要更新**: 元数据配置页面字段列表更新（排列方式列、只读列）、API响应增加field_placeholder字段说明