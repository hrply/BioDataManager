# BioData Manager 综合功能内测流程文档

## 一、测试目标

### 1.1 已知问题（必须测试）
| 功能模块 | 问题描述 | 验证标准 |
|---------|---------|---------|
| 文件下载 | API是否存在、是否可用 | 单文件/多文件下载成功 |
| 文件删除 | 软删除到回收站、记录更新 | 文件移至 /bio/recycle、file_count 更新 |
| 导入已有项目 | metadata_override 合并 | 数据库字段正确更新 |
| 逗号分隔处理 | 中文逗号→英文逗号 | 存储使用英文逗号 |
| 关联项目字段 | results_raw 存储、排序、去重 | 逗号分隔、ASCII排序、无重复 |

### 1.2 主动发现问题（阅读设计文档和代码发现）

**发现问题清单**（每轮测试前重新评估）：

| 序号 | 潜在问题 | 发现来源 | 验证方法 |
|-----|---------|---------|---------|
| 1 | multi_select 字段不一致 | 代码搜索 | 检查 field_config 和前端实现 |
| 2 | API 响应字段名不一致 | 代码对比 | 检查 project_id vs raw_id/results_id |
| 3 | 前端筛选功能 | 设计文档 | 测试多条件筛选 |
| 4 | 动态列渲染 | 设计文档 | 测试 rowtitle_mapping 正确性 |
| 5 | 引文解析功能 | 代码阅读 | 测试 .bib/.ris/.enw 解析 |
| 6 | 文件路径生成 | 代码阅读 | 测试各种 tissue 为空的情况 |
| 7 | 缩写映射缺失 | 代码阅读 | 测试无 abbr_mapping 的情况 |
| 8 | 权限验证缺失 | 代码阅读 | 测试未登录访问 |
| 9 | 并发处理 | 代码分析 | 测试连续快速请求 |
| 10 | 异常处理 | 代码分析 | 测试各种错误情况 |

## 二、测试方法

### 2.1 容器内测试（直接调用模块）
- **位置**：容器内 `/app/test_internal.py`
- **目的**：验证核心业务逻辑、数据库操作、文件系统操作
- **优点**：快速、无网络依赖、可直接访问数据库

### 2.2 容器外测试（HTTP API）
- **位置**：宿主机 `app/test_external_api.py`
- **端口**：20425
- **目的**：模拟真实用户操作、验证完整请求响应
- **验证方式**：API 请求后进入容器确认数据库和文件系统

## 三、每轮测试流程

### 第N轮测试（N=1,2,3）

#### 步骤1：阅读文档发现问题（约10分钟）
- [ ] 阅读 `docs/应用功能设计.md`
- [ ] 阅读 `docs/数据库设计规范.md`
- [ ] 阅读 `app/server.py` API 实现
- [ ] 阅读 `app/backend.py` 业务逻辑
- [ ] 更新「主动发现问题清单」
- [ ] 记录新发现的问题到日志

#### 步骤2：生成内测代码（约20分钟）
- [ ] 根据问题清单编写容器内测试代码 `test_internal_round{N}.py`
- [ ] 根据问题清单编写容器外测试代码 `test_external_round{N}.py`
- [ ] 代码必须包含清理函数（测试前后清理数据）
- [ ] 代码必须有详细的日志输出

#### 步骤3：容器内测试（约10分钟）
- [ ] 复制测试代码到容器
- [ ] 执行容器内测试
- [ ] 记录通过/失败情况
- [ ] 失败的问题分析根因
- [ ] 修复代码问题（如有）
- [ ] 重新运行直到无错误

#### 步骤4：容器外测试（约15分钟）
- [ ] 执行容器外测试
- [ ] API 请求后立即在容器内验证：
  - [ ] 数据库记录正确
  - [ ] /bio 目录文件正确
- [ ] 失败的问题分析根因
- [ ] 修复代码问题（如有）
- [ ] 重新运行直到无错误

#### 步骤5：汇总报告（约5分钟）
- [ ] 汇总本轮测试结果
- [ ] 更新 `.test/logs/changes_{timestamp}.log`
- [ ] 更新 `.test/results/round{N}_result.json`
- [ ] 决定是否进入下一轮

## 四、验证标准（必须同时满足）

### 4.1 数据库验证
```sql
-- 检查 raw_project
SELECT raw_id, raw_type, raw_species, raw_tissue, raw_file_count FROM raw_project WHERE raw_id LIKE 'TEST_%';

-- 检查 result_project  
SELECT results_id, results_type, results_raw, results_file_count FROM result_project WHERE results_id LIKE 'TEST_%';

-- 检查 file_record
SELECT file_name, file_path, file_property FROM file_record WHERE file_project_id LIKE 'TEST_%';
```

### 4.2 文件系统验证
```bash
# 检查原始数据文件
ls -la /bio/rawdata/*/*/*/TEST_RAW_*/

# 检查结果数据文件
ls -la /bio/results/*/*/TEST_RES_*/

# 检查回收站文件
ls -la /bio/recycle/*/
```

### 4.3 路径格式验证
- 原始数据：`/bio/rawdata/{type_abbr}/{species_abbr}/{tissue_abbr}/{raw_id}/`
- 结果数据：`/bio/results/{results_id}/{type_abbr}/{raw_ids}/`

### 4.4 属性格式验证
- file_property 使用英文逗号
- 无中文逗号
- 无多余空格

## 五、测试用例模板

### 5.1 容器内测试用例
```python
def test_xxx():
    """TC-ID: 功能模块-测试点"""
    # 1. 准备测试数据
    # 2. 调用被测函数
    # 3. 验证数据库记录
    # 4. 验证文件系统
    # 5. 记录结果
```

### 5.2 容器外测试用例
```python
def test_xxx_api():
    """TC-ID: 功能模块-测试点-API"""
    # 1. 发送 API 请求
    # 2. 等待响应
    # 3. 进入容器验证数据库
    # 4. 进入容器验证文件系统
    # 5. 记录结果
```

## 六、问题记录格式

### 6.1 问题日志格式
```log
#========================================
# 时间: YYYY-MM-DD HH:MM:SS
# 轮次: N
# 发现方式: 阅读文档/代码/测试
#========================================
问题类型: 代码Bug/测试问题/需求不清
问题描述: 
严重程度: P0/P1/P2/P3
复现步骤: 
根因分析: 
解决方案: 
状态: 待修复/已修复/已验证
#========================================
```

## 七、退出标准

每轮测试必须满足以下条件才能进入下一轮：
1. 所有已知问题测试用例执行完毕
2. 所有主动发现的问题测试用例执行完毕
3. 无 P0/P1 级别的问题未解决
4. 容器内测试通过率 100%
5. 容器外测试通过率 100%

## 八、当前状态

| 轮次 | 状态 | 容器内通过 | 容器外通过 | 发现新问题 |
|-----|------|-----------|-----------|-----------|
| 第1轮 | 待开始 | - | - | - |
| 第2轮 | 待开始 | - | - | - |
| 第3轮 | 待开始 | - | - | - |

---

**文档版本**: 2.0  
**创建时间**: 2026-01-27  
**最后更新**: 2026-01-27