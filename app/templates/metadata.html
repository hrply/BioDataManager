{% extends "base.html" %}

{% block title %}元数据管理 - BioData Manager{% endblock %}

{% block content %}
<!-- 页面头部 -->
<div class="page-header">
    <div class="container">
        <h1>
            <i class="bi bi-gear me-3"></i>元数据管理
        </h1>
        <p class="lead">配置字段属性、管理选项列表</p>
    </div>
</div>

<div class="container">
    <!-- 标签页切换 -->
    <ul class="nav nav-tabs mb-4" id="metadata-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="raw-tab" data-bs-toggle="tab" data-bs-target="#raw-fields" type="button" role="tab">
                <i class="bi bi-collection me-2"></i>原始数据字段
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="result-tab" data-bs-toggle="tab" data-bs-target="#result-fields" type="button" role="tab">
                <i class="bi bi-bar-chart-steps me-2"></i>结果数据字段
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-fields" type="button" role="tab">
                <i class="bi bi-folder2-open me-2"></i>文件管理字段
            </button>
        </li>
    </ul>

    <!-- 标签页内容 -->
    <div class="tab-content" id="metadata-tab-content">
                <!-- 原始数据字段 -->
                <div class="tab-pane fade show active" id="raw-fields" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-list me-2"></i>字段列表</span>
                            <div>
                                <button class="btn btn-outline-secondary btn-sm me-2" id="raw-edit-btn" onclick="toggleEditMode('raw')">
                                    <i class="bi bi-pencil-square me-1"></i><span id="raw-edit-text">编辑模式</span>
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="showAddFieldModal('raw')">
                                    <i class="bi bi-plus-circle me-1"></i>添加字段
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="raw-field-table">
                                    <thead class="table-light" id="raw-field-thead">
                                        <tr>
                                            <th>加载中...</th>
                                        </tr>
                                    </thead>
                                    <tbody id="raw-field-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
        
                <!-- 结果数据字段 -->
                <div class="tab-pane fade" id="result-fields" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-list me-2"></i>字段列表</span>
                            <div>
                                <button class="btn btn-outline-secondary btn-sm me-2" id="result-edit-btn" onclick="toggleEditMode('result')">
                                    <i class="bi bi-pencil-square me-1"></i><span id="result-edit-text">编辑模式</span>
                                </button>
                                <button class="btn btn-success btn-sm" onclick="showAddFieldModal('result')">
                                    <i class="bi bi-plus-circle me-1"></i>添加字段
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light" id="result-field-thead">
                                        <tr>
                                            <th>加载中...</th>
                                        </tr>
                                    </thead>
                                    <tbody id="result-field-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
        
                <!-- 文件管理字段 -->
                <div class="tab-pane fade" id="file-fields" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-list me-2"></i>字段列表</span>
                            <div>
                                <button class="btn btn-outline-secondary btn-sm me-2" id="file-edit-btn" onclick="toggleEditMode('file')">
                                    <i class="bi bi-pencil-square me-1"></i><span id="file-edit-text">编辑模式</span>
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="showAddFieldModal('file')">
                                    <i class="bi bi-plus-circle me-1"></i>添加字段
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light" id="file-field-thead">
                                        <tr>
                                            <th>加载中...</th>
                                        </tr>
                                    </thead>
                                    <tbody id="file-field-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

<!-- 添加/编辑字段模态框 -->
<div class="modal fade" id="field-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="field-modal-title">添加字段</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="field-form">
                    <input type="hidden" id="field-id">
                    <input type="hidden" id="field-table">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">字段标识符 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="field-field_id" required 
                                   placeholder="如: raw_type, raw_species" pattern="[a-z_]+">
                            <div class="form-text">只能包含小写字母和下划线</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">字段名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="field-field_name" required
                                   placeholder="如: 数据类型, 物种">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">字段类型 <span class="text-danger">*</span></label>
                            <select class="form-select" id="field-field_type" required onchange="toggleOptionsField()">
                                <option value="text">单行文本</option>
                                <option value="textarea">多行文本</option>
                                <option value="select">下拉选项</option>
                                <option value="multi_select">多选下拉</option>
                                <option value="link">链接</option>
                                <option value="tags">标签</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">是否必填</label>
                            <select class="form-select" id="field-field_necessary">
                                <option value="0">否</option>
                                <option value="1">是</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">排列方式</label>
                            <select class="form-select" id="field-field_placeholder">
                                <option value="2">两列显示（默认）</option>
                                <option value="1">单列显示（占满整行）</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">是否只读</label>
                            <select class="form-select" id="field-field_readonly">
                                <option value="0">否</option>
                                <option value="1">是（系统自动管理）</option>
                            </select>
                            <div class="form-text">设置为"是"后，文件导入时自动更新此字段</div>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="options-field" style="display: none;">
                        <label class="form-label">选项列表</label>
                        <div class="card bg-light">
                            <div class="card-body">
                                <div id="options-container">
                                    <div class="row g-2 mb-2 option-row">
                                        <div class="col-5">
                                            <input type="text" class="form-control" placeholder="值 (value)" name="opt-value">
                                        </div>
                                        <div class="col-5">
                                            <input type="text" class="form-control" placeholder="标签 (label)" name="opt-label">
                                        </div>
                                        <div class="col-2">
                                            <button type="button" class="btn btn-outline-danger w-100" onclick="removeOptionRow(this)">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addOptionRow()">
                                    <i class="bi bi-plus me-1"></i>添加选项
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">排序序号</label>
                        <input type="number" class="form-control" id="field-field_seq" value="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveField()">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .edit-mode input, .edit-mode select {
        border-color: #0d6efd;
        background-color: #f8f9fa;
    }
    .edit-mode tr {
        transition: all 0.2s;
    }
    .edit-mode tr:hover {
        background-color: #e9ecef;
    }
    .edit-mode .form-control:focus, .edit-mode .form-select:focus {
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let config = [];
    let columnHeaders = [];
    let editMode = {raw: false, result: false, file: false};

    // 初始化
    $(document).ready(function() {
        loadColumnHeaders().then(function() {
            loadConfig();
        });
    });

    // 加载列标题
    function loadColumnHeaders() {
        return apiGet('/api/metadata/config/columns').then(function(res) {
            if (res.success) {
                columnHeaders = res.columns || [];
                renderTableHeaders();
            }
        });
    }

    // 渲染表头
    function renderTableHeaders() {
        // 生成表头 HTML
        let headerHtml = ``;
        
        // 动态生成列标题 (第 1-7 列)
        columnHeaders.forEach(function(col) {
            headerHtml += `<th>${col.comment}</th>`;
        });
        
        headerHtml += `<th>操作</th>`;
        
        // 更新所有表格的表头
        ['raw', 'result', 'file'].forEach(function(table) {
            const thead = $(`#${table}-field-thead`);
            thead.html(`<tr>${headerHtml}</tr>`);
        });
    }

    // 获取列标题
    function getColumnHeader(colName) {
        const col = columnHeaders.find(c => c.name === colName);
        return col ? col.comment : colName;
    }

    // 渲染字段列表表头
    function renderFieldTableHeader() {
        let headerHtml = ``;
        
        // 动态生成列标题 (第 1-7 列)
        const displayColumns = ['field_seq', 'field_id', 'field_name', 'field_type', 'field_necessary', 'field_placeholder', 'field_readonly'];
        displayColumns.forEach(function(colName) {
            const header = getColumnHeader(colName);
            headerHtml += `<th>${header}</th>`;
        });
        
        headerHtml += `
                    <th>操作</th>
                </tr>
            </thead>
        `;
        return headerHtml;
    }

    // 加载配置
    function loadConfig() {
        apiGet('/api/metadata/config').then(function(res) {
            if (res.success) {
                config = res.config || [];
                renderFieldLists();
            }
        });
    }

    // 渲染字段列表
    function renderFieldLists() {
        const isEditMode = editMode.raw || editMode.result || editMode.file;
        
        ['raw', 'result', 'file'].forEach(function(table) {
            const fields = config.filter(f => f.field_table === table);
            const tbody = $(`#${table}-field-list`);
            const tableEditMode = editMode[table];
            
            if (fields.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">
                            <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                            暂无字段
                        </td>
                    </tr>
                `);
            } else {
                let html = '';
                fields.sort((a, b) => (a.field_seq || 0) - (b.field_seq || 0)).forEach(function(f, index) {
                    const placeholderText = f.field_placeholder === '1' ? '单列' : '两列';
                    const placeholderClass = f.field_placeholder === '1' ? 'text-primary' : 'text-muted';
                    const readonlyText = f.field_readonly == 1 ? '是' : '否';
                    const readonlyClass = f.field_readonly == 1 ? 'text-warning' : 'text-muted';
                    
                    const fieldTypeText = 
                        f.field_type === 'text' ? '文本' : 
                        f.field_type === 'textarea' ? '多行文本' : 
                        f.field_type === 'select' ? '下拉选项' : 
                        f.field_type === 'multi_select' ? '多选下拉' : 
                        f.field_type === 'link' ? '链接' : 
                        f.field_type === 'tags' ? '标签' : '未知';
                    const fieldTypeClass = f.field_type === 'select' ? 'bg-info' : 'bg-secondary';
                    const necessaryText = f.field_necessary == 1 ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-dash-circle text-muted"></i>';
                    
                    // 编辑模式下生成可编辑的输入框
                    const fieldSeqHtml = tableEditMode 
                        ? `<input type="number" class="form-control form-control-sm" value="${f.field_seq || 0}" data-field="field_seq" data-id="${f.id}" style="width: 60px;">`
                        : `<small class="text-muted">${f.field_seq || 0}</small>`;
                    
                    const fieldNameValue = f.field_name || f.field_id || '';
                    const fieldNameHtml = tableEditMode
                        ? `<input type="text" class="form-control form-control-sm" value="${fieldNameValue}" data-field="field_name" data-id="${f.id}">`
                        : (f.field_name || f.field_id || '');
                    
                    const fieldTypeHtml = tableEditMode
                        ? `<select class="form-select form-select-sm" data-field="field_type" data-id="${f.id}">
                            <option value="text" ${f.field_type === 'text' ? 'selected' : ''}>文本</option>
                            <option value="textarea" ${f.field_type === 'textarea' ? 'selected' : ''}>多行文本</option>
                            <option value="select" ${f.field_type === 'select' ? 'selected' : ''}>下拉选项</option>
                            <option value="multi_select" ${f.field_type === 'multi_select' ? 'selected' : ''}>多选下拉</option>
                            <option value="link" ${f.field_type === 'link' ? 'selected' : ''}>链接</option>
                            <option value="tags" ${f.field_type === 'tags' ? 'selected' : ''}>标签</option>
                           </select>`
                        : `<span class="badge ${fieldTypeClass}">${fieldTypeText}</span>`;
                    
                    const necessaryHtml = tableEditMode
                        ? `<select class="form-select form-select-sm" data-field="field_necessary" data-id="${f.id}">
                            <option value="0" ${f.field_necessary == 0 ? 'selected' : ''}>否</option>
                            <option value="1" ${f.field_necessary == 1 ? 'selected' : ''}>是</option>
                           </select>`
                        : necessaryText;
                    
                    const placeholderHtml = tableEditMode
                        ? `<select class="form-select form-select-sm" data-field="field_placeholder" data-id="${f.id}">
                            <option value="1" ${f.field_placeholder === '1' ? 'selected' : ''}>单列</option>
                            <option value="2" ${f.field_placeholder === '2' || !f.field_placeholder ? 'selected' : ''}>两列</option>
                           </select>`
                        : `<span class="${placeholderClass}">${placeholderText}</span>`;
                    
                    const readonlyHtml = tableEditMode
                        ? `<select class="form-select form-select-sm" data-field="field_readonly" data-id="${f.id}">
                            <option value="0" ${f.field_readonly == 0 ? 'selected' : ''}>否</option>
                            <option value="1" ${f.field_readonly == 1 ? 'selected' : ''}>是</option>
                           </select>`
                        : `<span class="${readonlyClass}">${readonlyText}</span>`;
                    
                    html += `
                        <tr data-id="${f.id}">
                            <td>${fieldSeqHtml}</td>
                            <td><code>${f.field_id}</code></td>
                            <td>${fieldNameHtml}</td>
                            <td>${fieldTypeHtml}</td>
                            <td>${necessaryHtml}</td>
                            <td>${placeholderHtml}</td>
                            <td>${readonlyHtml}</td>
                            <td>
                                ${tableEditMode 
                                    ? `<button class="btn btn-outline-secondary btn-sm" onclick="cancelEdit('${table}')" title="取消">
                                        <i class="bi bi-x-circle"></i>
                                       </button>`
                                    : `<button class="btn btn-outline-primary btn-sm me-1" onclick="editField(${f.id})" title="编辑">
                                        <i class="bi bi-pencil"></i>
                                       </button>
                                       <button class="btn btn-outline-danger btn-sm" onclick="deleteField(${f.id})" title="删除">
                                        <i class="bi bi-trash"></i>
                                       </button>`
                                }
                            </td>
                        </tr>
                    `;
                });
                tbody.html(html);
            }
        });
    }

    // 显示添加字段模态框
    function showAddFieldModal(table) {
        $('#field-modal-title').text('添加字段');
        // 先设置 field-table，再重置表单，确保值不会被 reset() 影响
        $('#field-table').val(table);
        $('#field-form')[0].reset();
        $('#field-table').val(table); // reset 后再次确认设置
        $('#options-container').html(
            '<div class="row g-2 mb-2">' +
            '<div class="col-5 fw-bold small text-muted">选项值</div>' +
            '<div class="col-5 fw-bold small text-muted">选项名称</div>' +
            '<div class="col-2"></div></div>' +
            '<div class="row g-2 mb-2 option-row">' +
            '<div class="col-5"><input type="text" class="form-control" placeholder="值 (value)" name="opt-value"></div>' +
            '<div class="col-5"><input type="text" class="form-control" placeholder="标签 (label)" name="opt-label"></div>' +
            '<div class="col-2"><button type="button" class="btn btn-outline-danger w-100" onclick="removeOptionRow(this)"><i class="bi bi-x"></i></button></div></div>'
        );
        $('#options-field').hide();
        new bootstrap.Modal($('#field-modal')).show();
    }

    // 编辑字段
    function editField(id) {
        const field = config.find(f => f.id === id);
        if (!field) return;
        
        $('#field-modal-title').text('编辑字段');
        $('#field-id').val(field.id);
        $('#field-table').val(field.field_table);
        $('#field-field_id').val(field.field_id);
        $('#field-field_name').val(field.field_name);
        $('#field-field_type').val(field.field_type);
        $('#field-field_necessary').val(field.field_necessary ? '1' : '0');
        $('#field-field_seq').val(field.field_seq || 0);
        $('#field-field_placeholder').val(field.field_placeholder || '2');
        $('#field-field_readonly').val(field.field_readonly ? '1' : '0');
        
        // 选项
        const options = field.field_options || [];
        let optionsHtml = '<div class="row g-2 mb-2">' +
            '<div class="col-5 fw-bold small text-muted">选项值</div>' +
            '<div class="col-5 fw-bold small text-muted">选项名称</div>' +
            '<div class="col-2"></div></div>';
        options.forEach(function(opt) {
            optionsHtml += `
                <div class="row g-2 mb-2 option-row">
                    <div class="col-5"><input type="text" class="form-control" placeholder="值 (value)" name="opt-value" value="${opt.value}"></div>
                    <div class="col-5"><input type="text" class="form-control" placeholder="标签 (label)" name="opt-label" value="${opt.label}"></div>
                    <div class="col-2"><button type="button" class="btn btn-outline-danger w-100" onclick="removeOptionRow(this)"><i class="bi bi-x"></i></button></div>
                </div>
            `;
        });
        $('#options-container').html(optionsHtml + `
            <div class="row g-2 mb-2 option-row">
                <div class="col-5"><input type="text" class="form-control" placeholder="值 (value)" name="opt-value"></div>
                <div class="col-5"><input type="text" class="form-control" placeholder="标签 (label)" name="opt-label"></div>
                <div class="col-2"><button type="button" class="btn btn-outline-danger w-100" onclick="removeOptionRow(this)"><i class="bi bi-x"></i></button></div>
            </div>
        `);
        toggleOptionsField();
        
        new bootstrap.Modal($('#field-modal')).show();
    }

    // 保存字段
    function saveField() {
        const fieldType = $('#field-field_type').val();
        const options = [];
        
        if (fieldType === 'select') {
            $('#options-container .option-row').each(function() {
                const value = $(this).find('[name="opt-value"]').val();
                const label = $(this).find('[name="opt-label"]').val();
                if (value && label) {
                    options.push({value, label});
                }
            });
        }
        
        const data = {
            id: $('#field-id').val() || undefined,
            field_table: $('#field-table').val(),
            field_id: $('#field-field_id').val(),
            field_name: $('#field-field_name').val(),
            field_type: fieldType,
            field_necessary: $('#field-field_necessary').val(),
            field_seq: $('#field-field_seq').val(),
            field_options: JSON.stringify(options),
            field_placeholder: $('#field-field_placeholder').val(),
            field_readonly: $('#field-field_readonly').val()
        };
        
        if (!data.field_id || !data.field_name) {
            showToast('请填写必填字段', 'warning');
            return;
        }
        
        const url = data.id ? '/api/metadata/config/update' : '/api/metadata/config';
        apiPost(url, data).then(function(res) {
            if (res.success) {
                showToast(data.id ? '字段更新成功' : '字段添加成功');
                $('#field-modal').modal('hide');
                loadConfig();
            } else {
                showToast(res.message || '操作失败', 'error');
            }
        });
    }

    // 删除字段
    function deleteField(id) {
        if (!confirm('确定要删除此字段吗？相关数据不会被删除。')) {
            return;
        }
        
        apiPost('/api/metadata/config/delete', {id: id}).then(function(res) {
            if (res.success) {
                showToast('字段已删除');
                loadConfig();
            } else {
                showToast(res.message || '删除失败', 'error');
            }
        });
    }

    // 切换选项字段显示
    function toggleOptionsField() {
        const type = $('#field-field_type').val();
        $('#options-field').toggle(type === 'select');
    }

    // 添加选项行
    function addOptionRow() {
        $('#options-container').append(`
            <div class="row g-2 mb-2 option-row">
                <div class="col-5"><input type="text" class="form-control" placeholder="值 (value)" name="opt-value"></div>
                <div class="col-5"><input type="text" class="form-control" placeholder="标签 (label)" name="opt-label"></div>
                <div class="col-2"><button type="button" class="btn btn-outline-danger w-100" onclick="removeOptionRow(this)"><i class="bi bi-x"></i></button></div>
            </div>
        `);
    }

    // 删除选项行
    function removeOptionRow(btn) {
        $(btn).closest('.option-row').remove();
    }

    // 切换编辑模式
    function toggleEditMode(table) {
        if (editMode[table]) {
            // 当前是编辑模式，切换到保存状态
            saveEdit(table);
        } else {
            // 切换到编辑模式
            editMode[table] = true;
            $(`#${table}-fields`).addClass('edit-mode');
            $(`#${table}-edit-btn`).removeClass('btn-outline-secondary').addClass('btn-warning');
            $(`#${table}-edit-text`).text('保存');
            renderFieldLists();
        }
    }

    // 取消编辑
    function cancelEdit(table) {
        editMode[table] = false;
        $(`#${table}-fields`).removeClass('edit-mode');
        $(`#${table}-edit-btn`).removeClass('btn-warning').addClass('btn-outline-secondary');
        $(`#${table}-edit-text`).text('编辑模式');
        renderFieldLists();
    }

    // 保存编辑
    function saveEdit(table) {
        const configs = [];
        const tbody = $(`#${table}-field-list`);
        
        // 收集所有修改的数据
        tbody.find('input, select').each(function() {
            const $input = $(this);
            const id = $input.data('id');
            const fieldKey = $input.data('field');
            const value = $input.val();
            
            // 必须有id、field且value不为空
            if (!id || !fieldKey || value === null || value === undefined) {
                return;
            }
            
            // field_id 不能为空，跳过
            if (fieldKey === 'field_id') {
                return;
            }
            
            let existing = configs.find(c => c.id == id);
            if (!existing) {
                existing = {id: id};
                configs.push(existing);
            }
            
            // field_name 不能为空，跳过空值
            if (fieldKey === 'field_name' && (!value || value.trim() === '')) {
                return;
            }
            
            // 处理数值类型字段
            if (fieldKey === 'field_placeholder' || fieldKey === 'field_readonly' || fieldKey === 'field_necessary') {
                existing[fieldKey] = parseInt(value) || 0;
            } else {
                existing[fieldKey] = value;
            }
        });
        
        // 过滤掉无效的配置（没有有效字段的）
        const validConfigs = configs.filter(c => {
            // 至少有一个可更新的字段
            return Object.keys(c).some(k => k !== 'id');
        });
        
        if (validConfigs.length === 0) {
            cancelEdit(table);
            return;
        }
        
        // 批量更新
        apiPost('/api/metadata/config/batch-update', {configs: validConfigs}).then(function(res) {
            if (res.success) {
                showToast('保存成功');
                editMode[table] = false;
                $(`#${table}-fields`).removeClass('edit-mode');
                $(`#${table}-edit-btn`).removeClass('btn-warning').addClass('btn-outline-secondary');
                $(`#${table}-edit-text`).text('编辑模式');
                loadConfig();
            } else {
                showToast(res.message || '保存失败', 'error');
            }
        });
    }
</script>
{% endblock %}
