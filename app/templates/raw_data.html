{% extends "base.html" %}

{% block title %}原始数据 - BioData Manager{% endblock %}

{% block content %}
<!-- 页面头部 -->
<div class="page-header">
    <div class="container">
        <h1>
            <i class="bi bi-collection me-3"></i>原始数据管理
        </h1>
        <p class="lead">管理测序原始数据、项目元数据与引用文献</p>
    </div>
</div>

<div class="container">
    <!-- 筛选模块 -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-funnel me-2"></i>筛选条件
        </div>
        <div class="card-body">
            <div class="row g-3" id="filter-form">
                <div class="col-md-3">
                    <label class="form-label">数据类型</label>
                    <select class="form-select" id="filter-raw_type">
                        <option value="">全部</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">物种</label>
                    <select class="form-select" id="filter-raw_species">
                        <option value="">全部</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">组织来源</label>
                    <select class="form-select" id="filter-raw_tissue">
                        <option value="">全部</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end gap-2">
                    <button class="btn btn-outline-secondary" onclick="resetFilter()">
                        <i class="bi bi-arrow-clockwise me-1"></i>重置
                    </button>
                    <button class="btn btn-primary" onclick="applyFilter()">
                        <i class="bi bi-search me-1"></i>应用筛选
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 列表模块 -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list me-2"></i>项目列表</span>
            <button class="btn btn-primary btn-sm" onclick="showCreateModal()">
                <i class="bi bi-plus-circle me-1"></i>新建原始数据项目
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
{%- if rowtitle_mapping %}
{%- for field_seq, field_info in rowtitle_mapping.items()|sort %}
                            <th>{{ field_info.field_name }}</th>
{%- endfor %}
{%- else %}
                            <th>数据类型</th>
                            <th>物种</th>
                            <th>组织来源</th>
{%- endif %}
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="project-list">
                        {% if projects -%}
                        {% for p in projects -%}
                        <tr>
                            <td>{{ loop.index }}</td>
{%- if rowtitle_mapping %}
{%- for field_seq, field_info in rowtitle_mapping.items()|sort %}
{%- set field_id = field_info.field_id %}
{%- set field_type = field_info.field_type %}
{%- set options = field_info.options %}
{%- set raw_value = p[field_id] or '' %}
{%- if options and raw_value and raw_value in options %}
                            <td>{{ options[raw_value] }}</td>
{%- elif field_type == 'tags' and raw_value %}
                            <td>{% for tag in raw_value.split(',') %}<span class="badge bg-primary me-1">{{ tag.strip() }}</span>{% endfor %}</td>
{%- elif field_type == 'select' and raw_value %}
                            <td>{% for t in raw_value.split(',') %}<span class="badge bg-primary me-1">{{ t.strip() }}</span>{% endfor %}</td>
{%- else %}
                            <td>{{ raw_value or '-' }}</td>
{%- endif %}
{%- endfor %}
{%- else %}
                            <td>{{ p.raw_type or '-' }}</td>
                            <td>{{ p.raw_species or '-' }}</td>
                            <td>{{ p.raw_tissue or '-' }}</td>
{%- endif %}
                            <td>{{ p.created_at[:10] if p.created_at is string and p.created_at|length > 10 else (p.created_at if p.created_at else '-') }}</td>
                            <td>
                                <button class="btn btn-outline-primary btn-sm me-1" onclick="viewDetail('{{ p.raw_id }}')" title="查看详情">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-warning btn-sm me-1" onclick="editProject('{{ p.raw_id }}')" title="编辑项目">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteProject('{{ p.raw_id }}')" title="删除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor -%}
                        {% else -%}
                        {% set col_count = 3 + (rowtitle_mapping|length if rowtitle_mapping else 3) -%}
                        <tr>
                            <td colspan="{{ col_count }}" class="text-center py-4 text-muted">
                                <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                                暂无数据
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center">
            <span class="text-muted" id="total-count">共 0 条记录</span>
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0" id="pagination"></ul>
            </nav>
        </div>
    </div>
</div>

<!-- 新建/编辑项目模态框 -->
<div class="modal fade" id="project-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title">新建原始数据项目</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="project-form">
                    <input type="hidden" id="project-id">
                    <!-- 第一行：项目编号 + 引文文件 -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label">项目编号</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="project-raw_id" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="generateProjectId()">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-primary w-100" onclick="showCitationModal()">
                                <i class="bi bi-file-earmark-text me-1"></i>引文文件
                            </button>
                        </div>
                    </div>
                    <!-- 第二行：项目名称 -->
                    <div class="mb-3">
                        <label class="form-label">项目名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="project-raw_title" required>
                    </div>
                    <!-- 动态元数据字段区域 -->
                    <div id="dynamic-project-fields"></div>
                    <!-- 只读字段：由系统自动管理 -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <label class="form-label text-muted">文件数量</label>
                            <input type="text" class="form-control bg-light" id="project-raw_file_count" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted">文件总大小</label>
                            <input type="text" class="form-control bg-light" id="project-raw_total_size" readonly>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveProject()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 查看详情模态框 (单列布局) -->
<div class="modal fade" id="detail-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detail-title">项目详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detail-content">
                <!-- 详情内容由JS动态填充 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑项目模态框 -->
<div class="modal fade" id="edit-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="edit-title">编辑项目</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="edit-content">
                <!-- 编辑内容由JS动态填充 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveEditProject()">
                    <i class="bi bi-check-lg me-1"></i>保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 引文文件解析模态框 -->
<div class="modal fade" id="citation-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">解析引文文件</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">支持 .bib、.ris、.enw 格式，上传后自动解析并填充元数据</p>
                <div class="mb-3">
                    <label class="form-label">选择文件</label>
                    <input type="file" class="form-control" id="citation-file" accept=".bib,.ris,.enw">
                </div>
                <div class="alert alert-info" id="citation-info" style="display: none;">
                    <i class="bi bi-info-circle me-2"></i>
                    <span id="citation-msg"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="parseCitationFile()">
                    <i class="bi bi-file-earmark-text me-1"></i>解析并导入
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let projects = [];
    let currentPage = 1;
    const pageSize = 10;
    // 从服务器端获取的列配置
    const rowtitleMapping = {{ rowtitle_mapping|tojson if rowtitle_mapping else '{}' }};
    
    // 从 rowtitleMapping 提取字段列表用于分页渲染（动态列）
    const displayFields = Object.entries(rowtitleMapping).map(([seq, info]) => ({
        field_seq: parseInt(seq),
        field_id: info.field_id,
        field_name: info.field_name,
        field_type: info.field_type,
        field_options: Object.entries(info.options || {}).map(([value, label]) => ({ value, label }))
    })).sort((a, b) => a.field_seq - b.field_seq);

    // 格式化文件大小
    function formatFileSize(bytes) {
        if (!bytes || bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 初始化
    $(document).ready(function() {
        loadProjects();
        loadFilterOptions();
    });

    // 加载筛选选项
    function loadFilterOptions() {
        apiGet('/api/metadata/config', { table: 'raw' }).then(function(res) {
            if (res.success && res.config) {
                // 存储 value -> label 映射，用于筛选时转换
                window.filterValueToLabelMap = {};
                
                rawFields.forEach(function(field) {
                    if (field.field_type === 'select' || field.field_type === 'multi_select') {
                        const options = field.field_options || [];
                        // 建立 value -> label 映射
                        window.filterValueToLabelMap[field.field_id] = {};
                        options.forEach(function(opt) {
                            window.filterValueToLabelMap[field.field_id][opt.value] = opt.label;
                        });
                        
                        const $select = $(`#project-${field.field_id}`);
                        const $filter = $(`#filter-${field.field_id}`);
                        
                        // 先清空所有下拉框，避免重复
                        $select.empty();
                        $filter.empty();
                        
                        // 先添加"全部"选项
                        $select.append('<option value="">请选择</option>');
                        $filter.append('<option value="">全部</option>');
                        
                        options.forEach(function(opt) {
                            $select.append(`<option value="${opt.value}">${opt.label}</option>`);
                            $filter.append(`<option value="${opt.value}">${opt.label}</option>`);
                        });
                    }
                });
            }
        });
    }

    // 加载项目列表
    function loadProjects() {
        // 先获取字段配置
        apiGet('/api/metadata/fields', { table: 'raw' }).then(function(fieldRes) {
            // 保存字段配置供列表和详情使用
            window.rawFields = [];
            if (fieldRes.success && fieldRes.fields) {
                // 按 field_seq 排序，过滤可显示字段
                window.rawFields = fieldRes.fields
                    .filter(f => f.field_readonly === false || f.field_readonly === 0)
                    .sort((a, b) => a.field_seq - b.field_seq);
            }
            
            // 再加载项目数据
            return apiGet('/api/projects', {table: 'raw'});
        }).then(function(res) {
            if (res.success) {
                projects = res.data || [];
                renderProjects();
            }
        }).catch(function(err) {
            showToast('加载项目列表失败', 'error');
        });
    }

    // 渲染项目列表
    function renderProjects() {
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageProjects = projects.slice(start, end);
        const fields = displayFields.length > 0 ? displayFields : (window.rawFields || []);
        
        // 计算动态列数（固定列: 序号 + 创建时间 + 操作按钮 = 3）
        const dynamicColCount = 3 + fields.length;

        if (pageProjects.length === 0) {
            $('#project-list').html(`
                <tr>
                    <td colspan="${dynamicColCount}" class="text-center py-4 text-muted">
                        <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                        暂无数据
                    </td>
                </tr>
            `);
        } else {
            let html = '';
            pageProjects.forEach(function(p, index) {
                html += `<tr><td>${start + index + 1}</td>`;
                
                // 动态渲染字段列（根据 rowtitle_mapping 配置，从第2列开始）
                fields.forEach(function(field) {
                    const fieldId = field.field_id;
                    let fieldValue = p[fieldId] || '-';
                    
                    // 处理 select 类型渲染为 badges
                    if (fieldValue !== '-' && (field.field_type === 'select' || field.field_type === 'multi_select')) {
                        const values = fieldValue.split(',').map(v => v.trim());
                        fieldValue = values.map(v => `<span class="badge bg-primary me-1">${v}</span>`).join('');
                    } else if (fieldValue !== '-' && field.field_type === 'tags') {
                        // tags 类型渲染为 badges
                        const tags = fieldValue.split(',').map(k => `<span class="badge bg-primary me-1">${k.trim()}</span>`).join('');
                        fieldValue = tags;
                    }
                    
                    html += `<td>${fieldValue}</td>`;
                });
                
                html += `
                    <td>${p.created_at ? p.created_at.substring(0, 10) : '-'}</td>
                                                <td>
                                                    <button class="btn btn-outline-primary btn-sm me-1" onclick="viewDetail('${p.raw_id}')" title="查看详情">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                    <button class="btn btn-outline-warning btn-sm me-1" onclick="editProject('${p.raw_id}')" title="编辑项目">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteProject('${p.raw_id}')" title="删除">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>                </tr>
                `;
            });
            $('#project-list').html(html);
        }
        
        // 更新总数
        $('#total-count').text(`共 ${projects.length} 条记录`);
        
        // 渲染分页
        renderPagination();
    }

    // 渲染分页
    function renderPagination() {
        const totalPages = Math.ceil(projects.length / pageSize);
        let html = '';
        
        html += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">上一页</a>
            </li>
        `;
        
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>
                    </li>
                `;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }
        
        html += `
            <li class="page-item ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">下一页</a>
            </li>
        `;
        
        $('#pagination').html(html);
    }

    // 翻页
    function goToPage(page) {
        const totalPages = Math.ceil(projects.length / pageSize);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            renderProjects();
        }
    }

    // 显示新建模态框
    function showCreateModal() {
        $('#modal-title').text('新建原始数据项目');
        $('#project-form')[0].reset();
        $('#project-id').val('');
        generateProjectId();
        
        // 加载动态字段
        loadNewProjectFields('raw');
        
        new bootstrap.Modal($('#project-modal')).show();
    }

    // 生成项目编号
    function generateProjectId() {
        const uuid = Math.random().toString(36).substring(2, 10).toUpperCase();
        $('#project-raw_id').val(`RAW_${uuid}`);
    }

    // 加载新建项目动态字段
    function loadNewProjectFields(tableType) {
        apiGet('/api/metadata/fields', { table: tableType }).then(function(res) {
            if (res.success && res.fields) {
                // 过滤 field_readonly=0 的字段，按 field_seq 排序
                const fields = res.fields
                    .filter(f => f.field_readonly === false || f.field_readonly === 0)
                    .sort((a, b) => a.field_seq - b.field_seq);
                // 保存字段配置供 saveProject 使用
                window.newProjectFields = fields;
                renderNewProjectFields(fields, 'dynamic-project-fields');
            }
        });
    }

    // 渲染新建项目字段
    function renderNewProjectFields(fields, containerId) {
        const container = $('#' + containerId);
        
        // 1. 过滤掉已硬编码的字段
        let filteredFields = fields.filter(f => 
            !['raw_id', 'raw_title', 'results_id', 'results_title'].includes(f.field_id)
        );
        
        // 2. 按 field_seq 排序
        filteredFields.sort((a, b) => a.field_seq - b.field_seq);
        
        // 3. 分组：双列组(placeholder=2)在前，单列组(placeholder=1)在后
        const doubleColFields = filteredFields.filter(f => (f.field_placeholder || '2') === '2');
        const singleColFields = filteredFields.filter(f => f.field_placeholder === '1');
        
        if (filteredFields.length === 0) {
            container.html('');
            return;
        }

        let html = '';
        let colIndex = 0;
        let currentRowFields = [];

        // 4. 先渲染双列字段
        doubleColFields.forEach(function(field, index) {
            const fieldId = 'project-' + field.field_id;
            const requiredMark = field.field_necessary ? '<span class="text-danger">*</span>' : '';
            const fieldOptions = field.field_options || [];
            
            let inputHtml = '';
            if (field.field_type === 'select') {
                inputHtml = `<select class="form-select" id="${fieldId}" multiple>
                    ${fieldOptions.map(function(opt) {
                        const val = opt.value !== undefined ? opt.value : opt;
                        const label = opt.label !== undefined ? opt.label : opt;
                        return `<option value="${val}">${label}</option>`;
                    }).join('')}
                </select>`;
            } else if (field.field_type === 'textarea') {
                inputHtml = `<textarea class="form-control" id="${fieldId}" rows="3"></textarea>`;
            } else {
                inputHtml = `<input type="text" class="form-control" id="${fieldId}">`;
            }
            
            currentRowFields.push(`<div class="col-md-6">
                <label class="form-label">${field.field_name} ${requiredMark}</label>
                ${inputHtml}
            </div>`);
            colIndex++;

            // 每2个字段或最后一个双列字段时关闭行
            if (colIndex === 2 || index === doubleColFields.length - 1) {
                html += '<div class="row mb-3">' + currentRowFields.join('') + '</div>';
                currentRowFields = [];
                colIndex = 0;
            }
        });

        // 5. 再渲染单列字段
        singleColFields.forEach(function(field) {
            const fieldId = 'project-' + field.field_id;
            const requiredMark = field.field_necessary ? '<span class="text-danger">*</span>' : '';
            const fieldOptions = field.field_options || [];
            
            let inputHtml = '';
            if (field.field_type === 'select') {
                inputHtml = `<select class="form-select" id="${fieldId}" multiple>
                    ${fieldOptions.map(function(opt) {
                        const val = opt.value !== undefined ? opt.value : opt;
                        const label = opt.label !== undefined ? opt.label : opt;
                        return `<option value="${val}">${label}</option>`;
                    }).join('')}
                </select>`;
            } else if (field.field_type === 'textarea') {
                inputHtml = `<textarea class="form-control" id="${fieldId}" rows="3"></textarea>`;
            } else {
                inputHtml = `<input type="text" class="form-control" id="${fieldId}">`;
            }
            html += `<div class="mb-3">
                <label class="form-label">${field.field_name} ${requiredMark}</label>
                ${inputHtml}
            </div>`;
        });

        container.html(html);
        
        // 初始化 Bootstrap Select
        $('#' + containerId).find('select.form-select').each(function() {
            initBootstrapSelect(this);
        });
    }

    // 保存项目
    function saveProject() {
        const data = {
            raw_id: $('#project-raw_id').val(),
            raw_title: $('#project-raw_title').val(),
            raw_file_count: $('#project-raw_file_count').val() || 0,
            raw_total_size: $('#project-raw_total_size').val() || 0
        };
        
        if (!data.raw_title) {
            showToast('请填写项目名称', 'warning');
            return;
        }
        
        // 从动态字段收集数据
        if (window.newProjectFields && window.newProjectFields.length > 0) {
            window.newProjectFields.forEach(function(field) {
                const fieldId = 'project-' + field.field_id;
                const el = $('#' + fieldId);
                if (el.length) {
                    if (field.field_type === 'select') {
                        // select 类型获取选中的值（多选用逗号分隔）
                        const selectedValues = el.val();
                        if (selectedValues && Array.isArray(selectedValues)) {
                            // 规范化分隔符：将全角问号、中文逗号、英文问号替换为英文逗号
                            let value = selectedValues.join(',');
                            value = value.replace(/[\uFF1F\uFF0C\u003F\u002C]/g, ',');
                            data[field.field_id] = value;
                        } else {
                            data[field.field_id] = '';
                        }
                    } else if (field.field_type === 'textarea') {
                        // 规范化分隔符
                        let value = el.val() || '';
                        data[field.field_id] = value.replace(/[\uFF1F\uFF0C\u003F\u002C]/g, ',');
                    } else {
                        // 规范化分隔符
                        let value = el.val() || '';
                        data[field.field_id] = value.replace(/[\uFF1F\uFF0C\u003F\u002C]/g, ',');
                    }
                }
            });
        }
        
        const isEdit = $('#project-id').val();
        
        if (isEdit) {
            data.id = $('#project-id').val();
            apiPost('/api/projects', data).then(function(res) {
                if (res.success) {
                    showToast('项目更新成功');
                    $('#project-modal').modal('hide');
                    loadProjects();
                } else {
                    showToast(res.message || '操作失败', 'error');
                }
            });
        } else {
            apiPost('/api/projects', data).then(function(res) {
                if (res.success) {
                    showToast('项目创建成功');
                    $('#project-modal').modal('hide');
                    loadProjects();
                } else {
                    showToast(res.message || '操作失败', 'error');
                }
            });
        }
    }

    // 查看详情
    function viewDetail(id) {
        apiGet('/api/project', {id: id}).then(function(res) {
            if (res.success && res.project) {
                const p = res.project;
                $('#detail-title').text(`项目详情 - ${p.raw_id}`);
                
                // 动态获取字段配置并渲染
                apiGet('/api/metadata/fields', { table: 'raw' }).then(function(fieldRes) {
                    let html = `<div class="row">`;
                    
                    if (fieldRes.success && fieldRes.fields) {
                        // 按 field_seq 排序字段
                        const sortedFields = fieldRes.fields.sort((a, b) => a.field_seq - b.field_seq);
                        
                        sortedFields.forEach(function(field) {
                            const fieldId = field.field_id;
                            let fieldValue = p[fieldId] || '-';
                            
                            // 处理特殊字段格式化
                            if (fieldValue !== '-' && fieldId === 'raw_total_size') {
                                // 文件总大小添加单位
                                fieldValue = formatFileSize(parseInt(fieldValue) || 0);
                            } else if (fieldValue !== '-' && fieldId === 'raw_file_count') {
                                // 文件数量添加"个"后缀
                                fieldValue = fieldValue + ' 个';
                            } else if (fieldValue !== '-' && (field.field_type === 'select' || field.field_type === 'multi_select')) {
                                // 处理多值字段（逗号分隔）显示
                                // 将 value 转换为 label 显示
                                const values = fieldValue.split(',').map(v => v.trim());
                                const labels = values.map(v => {
                                    const opt = (field.field_options || []).find(o => o.value === v);
                                    return opt ? opt.label : v;
                                });
                                fieldValue = labels.join(', ');
                            }
                            
                            // 跳过创建时间（已由后端处理）
                            if (fieldId === 'created_at') return;
                            
                            // 根据 field_placeholder 配置确定布局
                            // 1 = 单列 (col-md-12), 2 = 双列 (col-md-6)
                            const isSingleColumn = field.field_placeholder === '1';
                            const colClass = isSingleColumn ? 'col-md-12' : 'col-md-6';
                            
                                                // 根据 field_type 确定渲染方式
                                                let displayValue = fieldValue;
                                                
                                                if (fieldValue !== '-' && field.field_type === 'textarea') {
                                                    // textarea 类型用背景框渲染
                                                    displayValue = `<div class="bg-light p-3 rounded">${fieldValue}</div>`;
                                                } else if (fieldValue !== '-' && field.field_type === 'link') {
                                                    // link 类型显示为超链接
                                                    displayValue = `<a href="${fieldValue}" target="_blank" class="text-break">${fieldValue}</a>`;
                                                } else if (fieldValue !== '-' && field.field_type === 'tags') {
                                                    // tags 类型用标签云显示（直接用英文逗号分割）
                                                    const tags = (fieldValue || '').split(',').map(k => k.trim()).filter(k => k);
                                                    displayValue = tags.map(k => `<span class="badge bg-primary me-1 mb-1">${k}</span>`).join('');
                                                } else if (fieldValue !== '-' && (field.field_type === 'select' || field.field_type === 'multi_select')) {
                                                    // select 类型渲染为 badges
                                                    const labels = fieldValue.split(',').map(v => v.trim()).filter(v => v);
                                                    displayValue = labels.map(v => `<span class="badge bg-primary me-1 mb-1">${v}</span>`).join('');
                                                }                            
                            html += `
                                <div class="${colClass} mb-2">
                                    <label class="text-muted small">${field.field_name}</label>
                                    <div>${displayValue}</div>
                                </div>
                            `;
                        });
                    }
                    
                    html += '</div>';  // end row
                    
                    $('#detail-content').html(html);
                    new bootstrap.Modal($('#detail-modal')).show();
                });
            } else {
                showToast('获取项目详情失败', 'error');
            }
        });
    }

    // 编辑项目
    function editProject(id) {
        $('#edit-title').text(`编辑项目 - ${id}`);
        $('#edit-content').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>');
        new bootstrap.Modal($('#edit-modal')).show();
        
        apiGet('/api/project', {id: id}).then(function(res) {
            if (res.success && res.project) {
                const p = res.project;
                
                apiGet('/api/metadata/fields', { table: 'raw' }).then(function(fieldRes) {
                    let html = `<form id="edit-project-form">
                        <input type="hidden" name="raw_id" value="${p.raw_id}">`;
                    
                    if (fieldRes.success && fieldRes.fields) {
                        // 按 field_seq 排序字段
                        const sortedFields = fieldRes.fields.sort((a, b) => a.field_seq - b.field_seq);
                        
                        // 过滤掉硬编码字段
                        const editableFields = sortedFields.filter(f => 
                            !['raw_id', 'raw_title', 'results_id', 'results_title', 'created_at'].includes(f.field_id)
                        );
                        
                        // 保存字段配置供保存时使用
                        window.editProjectFields = editableFields;
                        
                        let colIndex = 0;
                        const colsPerRow = 2;
                        
                        editableFields.forEach(function(field, index) {
                            const fieldId = 'edit-' + field.field_id;
                            let fieldValue = p[field.field_id] || '';
                            if (fieldValue === null || fieldValue === undefined) fieldValue = '';
                            
                            const requiredMark = field.field_necessary ? '<span class="text-danger">*</span>' : '';
                            
                            // 开始新行
                            if (colIndex === 0) {
                                html += '<div class="row mb-3">';
                            }
                            
                            // 根据 field_type 生成表单控件
                            let inputHtml = '';
                            if (field.field_type === 'select') {
                                // 下拉选择框 - 支持多选，使用 bootstrap-select
                                const fieldLabels = fieldValue.split(',').map(v => v.trim()).filter(v => v);
                                inputHtml = `<select class="form-select selectpicker" id="${fieldId}" name="${field.field_id}" data-live-search="true" multiple>
                                    ${(field.field_options || []).map(function(opt) {
                                        const val = opt.value !== undefined ? opt.value : opt;
                                        const label = opt.label !== undefined ? opt.label : opt;
                                        const selected = fieldLabels.includes(String(label)) ? 'selected' : '';
                                        return `<option value="${val}" ${selected}>${label}</option>`;
                                    }).join('')}
                                </select>`;
                            } else if (field.field_type === 'multi_select') {
                                // 标签输入框
                                inputHtml = `<input type="text" class="form-control" id="${fieldId}" name="${field.field_id}" value="${fieldValue}" placeholder="多个值用逗号分隔">`;
                            } else if (field.field_type === 'textarea') {
                                // 文本域
                                inputHtml = `<textarea class="form-control" id="${fieldId}" name="${field.field_id}" rows="3">${fieldValue}</textarea>`;
                            } else if (field.field_type === 'link') {
                                // 链接
                                inputHtml = `<input type="url" class="form-control" id="${fieldId}" name="${field.field_id}" value="${fieldValue}" placeholder="请输入链接">`;
                            } else {
                                // 文本输入框
                                inputHtml = `<input type="text" class="form-control" id="${fieldId}" name="${field.field_id}" value="${fieldValue}" placeholder="请输入${field.field_name}">`;
                            }
                            
                            const colClass = colsPerRow === 2 ? 'col-md-6' : 'col-12';
                            html += `
                                <div class="${colClass}">
                                    <label class="form-label">${field.field_name} ${requiredMark}</label>
                                    ${inputHtml}
                                </div>
                            `;
                            
                            colIndex++;
                            
                            // 结束行
                            if (colIndex === colsPerRow || index === editableFields.length - 1) {
                                html += '</div>';
                                colIndex = 0;
                            }
                        });
                    }
                    
                    html += '</form>';
                    $('#edit-content').html(html);
                    
                    // 初始化 bootstrap-select 多选组件
                    $('.selectpicker').selectpicker({
                        noneSelectedText: '请选择...',
                        selectAllText: '全选',
                        deselectAllText: '取消全选'
                    });
                });
            } else {
                showToast('获取项目信息失败', 'error');
            }
        });
    }

    // 保存编辑后的项目
    function saveEditProject() {
        const form = document.getElementById('edit-project-form');
        if (!form) return;
        
        const formData = new FormData(form);
        const data = {
            table: 'raw',
            raw_id: formData.get('raw_id')
        };
        
        // 收集所有字段数据
        const fieldRes = window.editProjectFields || [];
        fieldRes.forEach(function(field) {
            const fieldId = 'edit-' + field.field_id;
            const el = document.getElementById(fieldId);
            if (el) {
                let value = '';
                // bootstrap-select 多选用 val() 返回数组（已经是 value）
                if ($(el).hasClass('selectpicker') && $(el).attr('multiple') !== null) {
                    value = ($(el).val() || []).join(',');
                } else {
                    value = el.value || '';  // select 直接取 value
                }
                // 规范化分隔符
                value = value.replace(/[\uFF1F\uFF0C\u003F\u002C]/g, ',');
                data[field.field_id] = value;
            }
        });
        
        apiPut('/api/projects/raw/' + data.raw_id, data).then(function(res) {
            if (res.success) {
                showToast('项目已更新');
                bootstrap.Modal.getInstance($('#edit-modal')).hide();
                loadProjects();
            } else {
                showToast(res.message || '保存失败', 'error');
            }
        }).catch(function(err) {
            showToast('保存失败: ' + (err.responseJSON?.message || err.statusText), 'error');
        });
    }

    // 删除项目
    function deleteProject(id) {
        if (!confirm(`确定要删除项目 ${id} 吗？此操作不可恢复。`)) {
            return;
        }

        apiDelete('/api/projects/raw/' + id).then(function(res) {
            if (res.success) {
                showToast('项目已删除');
                loadProjects();
            } else {
                showToast(res.message || '删除失败', 'error');
            }
        }).catch(function(err) {
            showToast('删除失败: ' + (err.responseJSON?.message || err.statusText), 'error');
        });
    }

    // 显示引文文件模态框
    function showCitationModal() {
        $('#citation-file').val('');
        $('#citation-info').hide();
        new bootstrap.Modal($('#citation-modal')).show();
    }

    // 解析引文文件
    function parseCitationFile() {
        const fileInput = document.getElementById('citation-file');
        if (!fileInput.files[0]) {
            showToast('请选择文件', 'warning');
            return;
        }
        
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);
        
        // 调用后端解析 API
        $('#citation-info').show();
        $('#citation-msg').text(`正在解析文件: ${file.name}...`);
        
        $.ajax({
            url: '/api/parse-citation',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(res) {
                if (res.success) {
                    $('#citation-msg').html(`
                        <i class="bi bi-check-circle text-success"></i> 
                        成功解析 ${res.count} 条文献<br>
                        <small class="text-muted">解析结果已填入下方表单，请确认并保存</small>
                    `);
                    
                    // 如果有解析结果，自动填入表单
                    if (res.citations && res.citations.length > 0) {
                        const first = res.citations[0].project;
                        if (first.raw_title) $('#project-raw_title').val(first.raw_title);
                        if (first.raw_DOI) $('#project-raw_DOI').val(first.raw_DOI);
                        if (first.raw_article) $('#project-raw_article').val(first.raw_article);
                        if (first.raw_description) $('#project-raw_description').val(first.raw_description);
                        if (first.raw_keywords) $('#project-raw_keywords').val(first.raw_keywords);
                        
                        // 尝试匹配物种
                        const speciesSelect = document.getElementById('project-raw_species');
                        if (first.raw_species && speciesSelect) {
                            for (let i = 0; i < speciesSelect.options.length; i++) {
                                if (speciesSelect.options[i].text.includes(first.raw_species.split(' ')[0])) {
                                    speciesSelect.selectedIndex = i;
                                    break;
                                }
                            }
                        }
                    }
                    showToast('引文解析成功', 'success');
                } else {
                    $('#citation-msg').html(`
                        <i class="bi bi-exclamation-circle text-danger"></i> 
                        解析失败: ${res.message}
                    `);
                    showToast(res.message, 'error');
                }
            },
            error: function(xhr, status, error) {
                $('#citation-msg').html(`
                    <i class="bi bi-exclamation-circle text-danger"></i> 
                    网络错误: ${error}
                `);
                showToast('解析请求失败', 'error');
            }
        });
    }

    // 重置筛选
    function resetFilter() {
        $('#filter-raw_type, #filter-raw_species, #filter-raw_tissue').val('');
        currentPage = 1;
        loadProjects();
    }

                    // 应用筛选

                function applyFilter() {

                    // 获取选中的筛选值（value）

                    const typeValue = $('#filter-raw_type').val();

                                        const speciesValue = $('#filter-raw_species').val();

                                        const tissueValue = $('#filter-raw_tissue').val();

                    

                                        // API 返回的是 label，需要将筛选的 value 转换为 label

                                        const type = typeValue && window.filterValueToLabelMap?.raw_type?.[typeValue] ? window.filterValueToLabelMap.raw_type[typeValue] : typeValue;

                                        const species = speciesValue && window.filterValueToLabelMap?.raw_species?.[speciesValue] ? window.filterValueToLabelMap.raw_species[speciesValue] : speciesValue;

                                        const tissue = tissueValue && window.filterValueToLabelMap?.raw_tissue?.[tissueValue] ? window.filterValueToLabelMap.raw_tissue[tissueValue] : tissueValue;

                    

                                        apiGet('/api/projects', {table: 'raw'}).then(function(res) {

                                            if (res.success) {

                                                let filtered = res.data || [];

                    

                                                if (type) {

                                                    // 部分匹配（支持多值字段，如 "SUMO PTMome,转录组"）

                                                    filtered = filtered.filter(p => p.raw_type && p.raw_type.includes(type));

                                                }

                                                if (species) {

                                                    // 精确匹配（单值字段）

                                                    filtered = filtered.filter(p => p.raw_species === species);

                                                }

                                                if (tissue) {

                                                    // 部分匹配（可能是多值字段）

                                                    filtered = filtered.filter(p => p.raw_tissue && p.raw_tissue.includes(tissue));

                                                }

                            

                            projects = filtered;

                            currentPage = 1;

                            renderProjects();

                            showToast(`筛选完成，找到 ${projects.length} 条记录`, 'success');

                        }

                    }).catch(function(err) {

                        showToast('筛选失败', 'error');

                    });

                }</script>
{% endblock %}
