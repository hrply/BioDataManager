{% extends "base.html" %}

{% block title %}文件管理 - BioData Manager{% endblock %}

{% block content %}
<!-- 页面头部 -->
<div class="page-header">
    <div class="container">
        <h1 class="mb-2">
            <i class="bi bi-folder2-open me-2"></i>文件管理
        </h1>
        <p class="lead mb-0 opacity-75">文件分类整理、批量导入导出、存储优化</p>
    </div>
</div>

<div class="container">
    <!-- 标签页切换 -->
    <ul class="nav nav-tabs mb-4" id="files-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage-content" type="button" role="tab">
                <i class="bi bi-gear me-2"></i>管理
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import-content" type="button" role="tab">
                <i class="bi bi-upload me-2"></i>导入
            </button>
        </li>
    </ul>

    <!-- 标签页内容 -->
    <div class="tab-content" id="files-tab-content">
        <!-- 管理页面 -->
        <div class="tab-pane fade show active" id="manage-content" role="tabpanel">
            <!-- 筛选卡片 -->
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-funnel me-2"></i>筛选条件
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <select class="form-select form-select-sm" id="filter-project-type">
                                <option value="">项目类型 (全部)</option>
                                <option value="raw">原始数据</option>
                                <option value="result">结果数据</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" 
                                   id="filter-project-id" placeholder="项目编号">
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="applyFilter()">
                                <i class="bi bi-search me-1"></i>查询
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetFilter()">
                                重置
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 项目列表 -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-list me-2"></i>已导入项目</span>
                    <span class="badge bg-success" id="project-count">0 个</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="50">#</th>
                                    <th width="150" class="sortable" data-sort="project_id" onclick="sortProjects('project_id')" style="cursor: pointer;">
                                        项目编号 <i class="bi bi-chevron-expand sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-sort="title" onclick="sortProjects('title')" style="cursor: pointer;">
                                        项目名称 <i class="bi bi-chevron-expand sort-icon"></i>
                                    </th>
                                    <th width="100">数据类型</th>
                                    <th width="100" class="sortable" data-sort="file_count" onclick="sortProjects('file_count')" style="cursor: pointer;">
                                        文件数 <i class="bi bi-chevron-expand sort-icon"></i>
                                    </th>
                                    <th width="200">操作</th>
                                </tr>
                            </thead>
                            <tbody id="project-list">
                                {% if projects %}
                                {% for p in projects %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td><code>{{ p.raw_id }}</code></td>
                                    <td>{{ p.raw_title }}</td>
                                    <td><span class="badge bg-info">{{ p.raw_type }}</span></td>
                                    <td>{{ p.raw_file_count or 0 }}</td>
                                    <td style="white-space: nowrap;">
                                        <button class="btn btn-outline-primary btn-sm" onclick="showProjectDetail('{{ p.raw_id }}', 'raw')">
                                            <i class="bi bi-eye"></i> 查看
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="showProjectVerify('{{ p.raw_id }}', 'raw')">
                                            <i class="bi bi-shield-check"></i> 校验
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-muted">
                                        <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                                        暂无已导入项目
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 导入页面 -->
        <div class="tab-pane fade" id="import-content" role="tabpanel">
            <!-- 文件夹列表 -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-folder me-2"></i>下载目录文件夹</span>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-primary me-2" id="folder-count">0 个</span>
                        <button type="button" class="btn btn-primary btn-sm" onclick="scanDownloads()">
                            <i class="bi bi-search me-1"></i>扫描
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="folder-list">
                        <div class="list-group-item text-center py-4 text-muted">
                            <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                            点击扫描加载文件夹
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 弹窗放在tab-content外部，确保不受tab切换影响 -->
<!-- 导入弹窗 -->
<div class="modal fade" id="import-modal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">导入文件</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 目标项目选择 -->
                <div class="mb-3">
                    <label class="form-label fw-bold">目标项目</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="project-mode" id="mode-new" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="mode-new">新建项目</label>
                        
                        <input type="radio" class="btn-check" name="project-mode" id="mode-existing" autocomplete="off">
                        <label class="btn btn-outline-primary" for="mode-existing">选择已有项目</label>
                    </div>
                </div>

                <!-- 选择已有项目表单 -->
                <div class="mb-3" id="existing-project-form" style="display: none;">
                    <label class="form-label">选择项目</label>
                    <select class="form-select" id="target-project">
                        <option value="">请选择项目...</option>
                    </select>
                </div>

                <!-- 数据类型选择 -->
                <div class="mb-3">
                    <label class="form-label fw-bold">数据类型</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="data-type" id="type-raw" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="type-raw">原始数据</label>
                        
                        <input type="radio" class="btn-check" name="data-type" id="type-result" autocomplete="off">
                        <label class="btn btn-outline-primary" for="type-result">结果数据</label>
                    </div>
                </div>

                <!-- 新建项目表单 (只包含项目编号和名称) -->
                <div id="new-project-form">
                    <!-- 项目编号 (固定字段) -->
                    <div class="row g-2 mb-2">
                        <div class="col-md-6">
                            <label class="form-label">项目编号 <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="new-project-id" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="generateProjectId()">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">项目名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="new-project-title" placeholder="请输入项目名称">
                        </div>
                    </div>
                </div>

                <!-- 动态元数据字段容器 (在两种模式下都可见) -->
                <div id="dynamic-metadata-fields">
                    <!-- 动态渲染的字段将放在这里 -->
                </div>

                <hr>

                <!-- 文件选择区域 -->
                <div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label fw-bold mb-0">选择文件</label>
                        <div>
                            <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="selectAllFiles(true)">全选</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectAllFiles(false)">取消全选</button>
                        </div>
                    </div>
                    <div class="border rounded p-2 bg-light" style="max-height: 200px; overflow-y: auto;" id="file-selection-area">
                        <p class="text-muted text-center mb-0">请先选择要导入的文件夹</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirmImport()">
                    <i class="bi bi-upload me-1"></i>导入
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 详情弹窗 -->
<div class="modal fade" id="detail-modal" tabindex="-1">
    <div class="modal-dialog modal-xl" style="max-width: 75vw;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">项目详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detail-content">
                <!-- 动态填充 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="downloadSelectedFiles()">
                    <i class="bi bi-download me-1"></i>下载选中文件
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 校验弹窗 -->
<div class="modal fade" id="verify-modal" tabindex="-1">
    <div class="modal-dialog modal-xl" style="max-width: 95vw;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">文件校验</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="verify-content">
                <!-- 动态填充 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="saveVerifiedHash()">
                    <i class="bi bi-save me-1"></i>保存校验
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 全局数据
    let downloadFolders = [];
    let importedProjects = [];
    let currentProjectFiles = [];
    let selectedFiles = new Set();
    
    // 排序状态
    let currentSort = {
        field: 'created_at',
        order: 'desc'  // desc, asc
    };

    // ==================== 初始化 ====================
    $(document).ready(function() {
        loadImportedProjects();
        setupEventListeners();
    });

    // 设置事件监听
    function setupEventListeners() {
        // 项目模式切换
        $('input[name="project-mode"]').change(function() {
            const mode = $(this).attr('id');
            if (mode === 'mode-new') {
                $('#new-project-form').show();
                $('#existing-project-form').hide();
                window.currentProjectResultsRaw = ''; // 清除保存的 results_raw 值
                window.currentProjectRawTissue = ''; // 清除保存的 raw_tissue 值
                loadMetadataFields(); // 新建项目模式：加载动态字段（multi_select）
            } else {
                $('#new-project-form').hide();
                $('#existing-project-form').show();
                loadExistingProjects();
                $('#dynamic-metadata-fields').html(''); // 清空字段区域
            }
        });

        // 数据类型切换
        $('input[name="data-type"]').change(function() {
            updateProjectIdPrefix();
            // 重新加载元数据字段（根据当前模式）
            const mode = $('input[name="project-mode"]:checked').attr('id');
            if (mode === 'mode-new') {
                loadMetadataFields(); // 新建项目模式
            } else {
                loadExistingProjects(); // 已有项目模式
                $('#dynamic-metadata-fields').html('');
            }
        });

        // 已有项目下拉框变更监听
        $('#target-project').change(function() {
            const projectId = $(this).val();
            if (projectId) {
                const dataType = $('input[name="data-type"]:checked').attr('id');
                const projectType = dataType === 'type-raw' ? 'raw' : 'result';
                loadExistingProjectFields(projectId, projectType);
            } else {
                $('#dynamic-metadata-fields').html('');
            }
        });
    }

    // ==================== 动态元数据字段 ====================
    let metadataFields = [];

    function loadMetadataFields() {
        const dataType = $('input[name="data-type"]:checked').attr('id');
        const tableType = dataType === 'type-raw' ? 'raw' : 'result';

        apiGet('/api/metadata/fields', { table: tableType }).then(function(res) {
            if (res.success && res.fields) {
                // 过滤出可编辑字段（field_readonly=0）并按 field_seq 排序
                const editableFields = res.fields
                    .filter(f => f.field_readonly === false || f.field_readonly === 0)
                    .sort((a, b) => a.field_seq - b.field_seq);

                // 根据环境变量配置选择字段编号
                const displayFieldSeqs = res.display_fields_new || [];

                // 根据 field_seq 过滤字段
                metadataFields = editableFields.filter(f =>
                    displayFieldSeqs.includes(f.field_seq)
                );

                renderMetadataFields();
            } else {
                metadataFields = [];
                renderMetadataFields();
            }
        }).catch(function() {
            metadataFields = [];
            renderMetadataFields();
        });
    }

    function renderMetadataFields() {
        const container = $('#dynamic-metadata-fields');
        
        if (metadataFields.length === 0) {
            // 没有字段时显示提示
            container.html(`
                <p class="text-muted text-center py-3 mb-0">暂无可编辑的元数据字段</p>
            `);
            return;
        }
        
        let html = '';
        let colIndex = 0;
        const colsPerRow = 2;
        
        metadataFields.forEach(function(field, index) {
            const colClass = colsPerRow === 2 ? 'col-md-6' : 'col-12';
            const requiredMark = field.field_necessary ? '<span class="text-danger">*</span>' : '';
            const fieldId = 'metadata-' + field.field_id;
            const fieldLabel = field.field_name;
            const fieldOptions = field.field_options || [];
            
            // 开始新行
            if (colIndex === 0) {
                html += '<div class="row g-2 mb-2">';
            }
            
            // 根据字段类型生成不同的表单控件
            let inputHtml = '';
            if (field.field_type === 'select' || field.field_type === 'multi_select') {
                // 下拉选择框
                const multiple = field.field_type === 'multi_select';
                const selectAttr = multiple ? 'multiple' : '';
                
                inputHtml = `<select class="form-select" id="${fieldId}" name="${field.field_id}" ${selectAttr}>
                    <option value="">请选择...</option>
                    ${fieldOptions.map(function(opt) {
                        const val = opt.value !== undefined ? opt.value : opt;
                        const label = opt.label !== undefined ? opt.label : opt;
                        return `<option value="${val}">${label}</option>`;
                    }).join('')}
                </select>`;
            } else if (field.field_type === 'textarea') {
                // 文本域
                inputHtml = `<textarea class="form-control" id="${fieldId}" name="${field.field_id}" rows="3" placeholder="请输入${fieldLabel}"></textarea>`;
            } else {
                // 文本输入框
                inputHtml = `<input type="text" class="form-control" id="${fieldId}" name="${field.field_id}" placeholder="请输入${fieldLabel}">`;
            }
            
            html += `
                <div class="${colClass}">
                    <label class="form-label">${fieldLabel} ${requiredMark}</label>
                    ${inputHtml}
                </div>
            `;
            
            colIndex++;
            
            // 结束行
            if (colIndex === colsPerRow || index === metadataFields.length - 1) {
                html += '</div>';
                colIndex = 0;
            }
        });
        
        container.html(html);
    }

    // 获取表单数据
    function getFormData() {
        const dataType = $('input[name="data-type"]:checked').attr('id');
        const isRaw = dataType === 'type-raw';
        
        // 根据数据类型使用正确的字段名
        const formData = {
            project_id: $('#new-project-id').val(),
            data_type: isRaw ? 'raw' : 'result'
        };
        
        // 根据数据类型设置项目名称字段
        if (isRaw) {
            formData.raw_title = $('#new-project-title').val();
        } else {
            formData.results_title = $('#new-project-title').val();
        }
        
        // metadataFields 已经是过滤后的字段（只读字段已排除），直接遍历收集数据
        metadataFields.forEach(function(field) {
            const fieldId = field.field_id;
            const fieldEl = $(`[name="${fieldId}"]`);
            
            if (field.field_type === 'multi_select') {
                const values = [];
                fieldEl.find('option:selected').each(function() {
                    values.push($(this).val());
                });
                formData[fieldId] = values;
            } else {
                formData[fieldId] = fieldEl.val();
            }
        })
        
        // results_raw 字段：合并已有值和新输入的值（逗号分隔，支持中英文逗号）
        const resultsRawField = metadataFields.find(f => f.field_id === 'results_raw');
        if (resultsRawField) {
            const fieldEl = $('#metadata-' + resultsRawField.field_id);
            const resultsRawInput = fieldEl.val()?.trim() || '';
            if (resultsRawInput) {
                formData.results_raw = resultsRawInput;
            }
        }
        
        // results_type 字段：收集用户选择的结果类型（用于后端路径生成）
        const resultsTypeField = metadataFields.find(f => f.field_id === 'results_type');
        if (resultsTypeField) {
            const fieldEl = $('#metadata-' + resultsTypeField.field_id);
            const resultsTypeInput = fieldEl.val()?.trim() || '';
            if (resultsTypeInput) {
                formData.results_type = resultsTypeInput;
            }
        }
        
        return formData;
    }

    // 验证表单
    function validateFormData(data) {
        const errors = [];
        const isRaw = data.data_type === 'raw';
        
        // 根据数据类型检查项目名称
        const titleField = isRaw ? 'raw_title' : 'results_title';
        if (!data[titleField]) {
            errors.push('项目名称为必填字段');
        }
        
        // metadataFields 已经是过滤后的字段，直接遍历即可
        metadataFields.forEach(function(field) {
            if (field.field_necessary) {
                const value = data[field.field_id];
                if (!value || (Array.isArray(value) && value.length === 0)) {
                    errors.push(`${field.field_name} 为必填字段`);
                }
            }
        });
        
        return errors;
    }

    // 更新项目编号前缀
    function updateProjectIdPrefix() {
        const dataType = $('input[name="data-type"]:checked').attr('id');
        const prefix = dataType === 'type-raw' ? 'RAW_' : 'RES_';
        $('#new-project-id').val(prefix + '________');
    }

    // 生成项目编号
    function generateProjectId() {
        const dataType = $('input[name="data-type"]:checked').attr('id');
        const prefix = dataType === 'type-raw' ? 'RAW_' : 'RES_';
        const uuid = Math.random().toString(36).substring(2, 10).toUpperCase();
        $('#new-project-id').val(prefix + uuid);
    }

    // ==================== 扫描功能 ====================
    function scanDownloads() {
        updateScanStatus('running', '扫描中...');
        
        apiGet('/api/scan-downloads').then(function(res) {
            if (res.success && res.task_id) {
                pollScanTask(res.task_id, function(result) {
                    downloadFolders = result || [];
                    renderFolderList();
                    updateScanStatus('completed', `完成 (${downloadFolders.length})`);
                });
            } else {
                updateScanStatus('failed', '启动失败');
            }
        }).catch(function() {
            updateScanStatus('failed', '启动失败');
        });
    }

    function pollScanTask(taskId, callback) {
        const timer = setInterval(function() {
            apiGet('/api/task/status/' + taskId).then(function(res) {
                if (res.success && res.task) {
                    const task = res.task;
                    if (task.status === 'running') {
                        updateScanStatus('running', task.message);
                    } else if (task.status === 'completed') {
                        clearInterval(timer);
                        callback(task.result);
                    } else if (task.status === 'failed') {
                        clearInterval(timer);
                        updateScanStatus('failed', '扫描失败');
                    }
                }
            });
        }, 500);
    }

    function updateScanStatus(status, message) {
        if (status === 'running') {
            showToast(message, 'info', 5000);
        } else if (status === 'completed') {
            showToast('扫描完成，发现 ' + downloadFolders.length + ' 个文件夹', 'success');
        } else if (status === 'failed') {
            showToast(message || '扫描失败', 'error');
        }
    }

    // ==================== 渲染函数 ====================
    function renderFolderList() {
        const list = $('#folder-list');
        $('#folder-count').text(downloadFolders.length + ' 个');
        
        if (downloadFolders.length === 0) {
            list.html(`
                <div class="list-group-item text-center py-4 text-muted">
                    <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                    暂无文件夹
                </div>
            `);
        } else {
            let html = '';
            downloadFolders.forEach(function(f, index) {
                html += `
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-folder me-2 text-warning"></i>
                            <span class="fw-medium">${f.name}</span>
                            <small class="text-muted d-block">${f.file_count} 个文件</small>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-1" onclick="openImportModal('${index}')">
                                <i class="bi bi-upload"></i> 导入
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="viewFolderDetails('${index}')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            list.html(html);
        }
    }

    // ==================== 项目加载（使用新API）====================
    function loadImportedProjects() {
        const type = $('#filter-project-type').val();
        const ids = $('#filter-project-id').val().trim();
        
        const params = {};
        if (type) params.file_project_type = type;
        if (ids) params.file_project_ids = ids;
        
        // 添加排序参数
        params.sort_field = currentSort.field;
        params.sort_order = currentSort.order;
        
        apiGet('/api/files/imported-projects', params).then(function(res) {
            if (res.success && res.data) {
                importedProjects = res.data;
                renderProjectList();
            } else {
                importedProjects = [];
                renderProjectList();
            }
        }).catch(function() {
            importedProjects = [];
            renderProjectList();
        });
    }

    // ==================== 排序功能 ====================
    function sortProjects(field) {
        // 切换排序顺序
        if (currentSort.field === field) {
            currentSort.order = currentSort.order === 'desc' ? 'asc' : 'desc';
        } else {
            currentSort.field = field;
            currentSort.order = 'desc';  // 新字段默认降序
        }
        
        // 更新表头显示
        updateSortIndicators();
        
        // 重新加载数据
        loadImportedProjects();
    }

    function updateSortIndicators() {
        // 更新所有列头的排序图标
        $('.sortable').each(function() {
            const field = $(this).data('sort');
            const icon = $(this).find('.sort-icon');
            
            if (field === currentSort.field) {
                if (currentSort.order === 'desc') {
                    icon.removeClass('bi-chevron-expand bi-caret-up-fill bi-caret-down-fill')
                        .addClass('bi-caret-down-fill text-primary');
                } else {
                    icon.removeClass('bi-chevron-expand bi-caret-up-fill bi-caret-down-fill')
                        .addClass('bi-caret-up-fill text-primary');
                }
            } else {
                icon.removeClass('bi-chevron-expand bi-caret-up-fill bi-caret-down-fill')
                    .addClass('bi-chevron-expand');
            }
        });
    }

    // ==================== 渲染函数 ====================
    function renderProjectList() {
        const tbody = $('#project-list');
        $('#project-count').text(importedProjects.length + ' 个');
        
        if (importedProjects.length === 0) {
            tbody.html(`
                <tr>
                    <td colspan="6" class="text-center py-4 text-muted">
                        <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                        暂无已导入项目
                    </td>
                </tr>
            `);
        } else {
            let html = '';
            importedProjects.forEach(function(p, index) {
                const projectTypeLabel = p.project_type === 'raw' ? '原始数据' : '结果数据';
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><code>${p.project_id}</code></td>
                        <td>${p.title || '-'}</td>
                        <td><span class="badge bg-info">${projectTypeLabel}</span></td>
                        <td>${p.file_count || 0}</td>
                        <td style="white-space: nowrap;">
                            <button class="btn btn-outline-primary btn-sm" onclick="showProjectDetail('${p.project_id}', '${p.project_type}')">
                                <i class="bi bi-eye"></i> 查看
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="showProjectVerify('${p.project_id}', '${p.project_type}')">
                                <i class="bi bi-shield-check"></i> 校验
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.html(html);
        }
    }

    function loadExistingProjects() {
        const select = $('#target-project');
        const dataType = $('input[name="data-type"]:checked').attr('id');
        const type = dataType === 'type-raw' ? 'raw' : 'result';
        
        select.empty().append('<option value="">请选择项目...</option>');
        
        // 使用新的 API 获取项目列表，格式为 "项目编号|项目标题"
        apiGet('/api/projects/options', { table: type }).then(function(res) {
            if (res.success && res.options) {
                res.options.forEach(function(opt) {
                    select.append(`<option value="${opt.value}">${opt.text}</option>`);
                });
                
                // 如果有项目，自动选择第一个并加载字段
                if (res.options.length > 0) {
                    select.val(res.options[0].value).trigger('change');
                } else {
                    // 没有项目时清空字段区域
                    $('#dynamic-metadata-fields').html('<p class="text-muted text-center py-3 mb-0">暂无可用项目，请先创建项目</p>');
                }
            }
        }).catch(function() {
            // 如果新API失败，使用旧的兼容方式
            const filteredProjects = projects.filter(function(p) {
                if (type === 'raw') return p.raw_id;
                return p.results_id;
            });
            
            filteredProjects.forEach(function(p) {
                const id = p.raw_id || p.results_id;
                const title = p.raw_title || p.results_title || '-';
                select.append(`<option value="${id}">${id}|${title}</option>`);
            });
            
            // 如果有项目，自动选择第一个并加载字段
            if (filteredProjects.length > 0) {
                const firstId = filteredProjects[0].raw_id || filteredProjects[0].results_id;
                select.val(firstId).trigger('change');
            }
        });
    }

    // 加载已有项目的元数据字段（用于编辑）
    function loadExistingProjectFields(projectId, projectType) {
        const container = $('#dynamic-metadata-fields');
        
        if (!projectId) {
            container.html('');
            return;
        }
        
        // 根据项目类型获取元数据
        const apiPath = projectType === 'raw' 
            ? '/api/projects/raw/' + projectId + '/metadata'
            : '/api/projects/result/' + projectId + '/metadata';
        
        apiGet(apiPath).then(function(res) {
            if (res.success && res.metadata) {
                renderEditableMetadataFields(res.metadata, projectType);
            } else {
                container.html('<p class="text-muted text-center py-3 mb-0">无法加载项目元数据</p>');
            }
        }).catch(function() {
            container.html('<p class="text-muted text-center py-3 mb-0">无法加载项目元数据</p>');
        });
    }

    // 渲染可编辑的元数据字段（用于导入时修改）
    function renderEditableMetadataFields(currentMetadata, projectType) {
        const container = $('#dynamic-metadata-fields');
        const tableType = projectType;

        // 保存当前项目的字段值（用于追加新值）
        window.currentProjectResultsRaw = currentMetadata.results_raw || '';
        window.currentProjectRawTissue = currentMetadata.raw_tissue || '';

        // 获取字段配置
        apiGet('/api/metadata/fields', { table: tableType }).then(function(res) {
            if (res.success && res.fields) {
                // 过滤出可编辑字段（field_readonly=0）并按 field_seq 排序
                const editableFields = res.fields
                    .filter(f => f.field_readonly === false || f.field_readonly === 0)
                    .sort((a, b) => a.field_seq - b.field_seq);

                // 根据环境变量配置选择字段编号
                const displayFieldSeqs = res.display_fields_exist || [];

                // 根据 field_seq 过滤字段
                const displayFields = editableFields.filter(f =>
                    displayFieldSeqs.includes(f.field_seq)
                );
                
                // 渲染字段（single_select 模式）
                if (displayFields.length === 0) {
                    container.html('<p class="text-muted text-center py-3 mb-0">暂无可编辑的元数据字段</p>');
                    return;
                }
                
                let html = '<div class="row g-2 mb-2">';

                displayFields.forEach(function(field) {
                    const fieldId = 'metadata-' + field.field_id;
                    const currentValue = currentMetadata[field.field_id] || '';
                    const fieldType = field.field_type || 'text';
                    const fieldOptions = field.field_options || [];

                    if (fieldType === 'select') {
                        // 下拉框
                        let optionsHtml = '<option value="">请选择...</option>';
                        fieldOptions.forEach(function(opt) {
                            const val = opt.value !== undefined ? opt.value : opt;
                            const label = opt.label !== undefined ? opt.label : opt;
                            const selected = val === currentValue ? 'selected' : '';
                            optionsHtml += `<option value="${val}" ${selected}>${label}</option>`;
                        });
                        html += `
                            <div class="col-md-6">
                                <label class="form-label">${field.field_name}</label>
                                <select class="form-select" id="${fieldId}" name="${field.field_id}">
                                    ${optionsHtml}
                                </select>
                            </div>
                        `;
                    } else if (fieldType === 'textarea') {
                        // 文本域
                        html += `
                            <div class="col-md-12">
                                <label class="form-label">${field.field_name}</label>
                                <textarea class="form-control" id="${fieldId}" name="${field.field_id}" rows="2">${currentValue}</textarea>
                            </div>
                        `;
                    } else {
                        // 输入框 (text)
                        html += `
                            <div class="col-md-6">
                                <label class="form-label">${field.field_name}</label>
                                <input type="text" class="form-control" id="${fieldId}" name="${field.field_id}" value="${currentValue}">
                            </div>
                        `;
                    }
                });

                html += '</div>';
                container.html(html);
                
                // 保存字段配置供 confirmImport 使用（关键修复：设置全局变量）
                metadataFields = displayFields;
            } else {
                container.html('<p class="text-muted text-center py-3 mb-0">无法加载字段配置</p>');
            }
        }).catch(function() {
            container.html('<p class="text-muted text-center py-3 mb-0">无法加载字段配置</p>');
        });
    }

    // ==================== 导入功能 ====================
    function openImportModal(folderIndex) {
        currentFolder = downloadFolders[folderIndex];
        selectedFiles.clear();
        
        // 重置表单
        $('#mode-new').prop('checked', true).trigger('change');
        generateProjectId();
        
        // 清除保存的已有项目字段值
        window.currentProjectResultsRaw = '';
        window.currentProjectRawTissue = '';
        
        // 加载动态元数据字段
        loadMetadataFields();
        
        // 渲染文件选择区域
        renderFileSelection(currentFolder.files || []);
        
        // 显示弹窗
        new bootstrap.Modal($('#import-modal')).show();
    }

    function renderFileSelection(files) {
        const area = $('#file-selection-area');
        
        if (!files || files.length === 0) {
            area.html('<p class="text-muted text-center mb-0">该文件夹为空</p>');
            return;
        }
        
        let html = '';
        files.forEach(function(f, index) {
            const fileId = `file-${index}`;
            const relativePath = f.relative_path || '';
            html += `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="${fileId}" value="${f.name}"
                           onchange="toggleFileSelect(this)">
                    <label class="form-check-label" for="${fileId}">
                        ${f.name} <small class="text-muted">(${formatSize(f.size)})</small>
                        ${relativePath ? `<br><small class="text-muted ms-1" style="font-size: 0.75rem;">${relativePath}</small>` : ''}
                    </label>
                </div>
            `;
        });
        area.html(html);
    }

    function toggleFileSelect(checkbox) {
        if (checkbox.checked) {
            selectedFiles.add(checkbox.value);
        } else {
            selectedFiles.delete(checkbox.value);
        }
    }

    function selectAllFiles(select) {
        $('#file-selection-area input[type="checkbox"]').each(function() {
            $(this).prop('checked', select);
            if (select) {
                selectedFiles.add($(this).val());
            } else {
                selectedFiles.delete($(this).val());
            }
        });
    }

    function confirmImport() {
        const mode = $('input[name="project-mode"]:checked').attr('id');
        const dataType = $('input[name="data-type"]:checked').attr('id');
        const isRaw = dataType === 'type-raw';
        
        if (selectedFiles.size === 0) {
            showToast('请选择要导入的文件', 'warning');
            return;
        }
        
        const requestData = {
            folder_name: currentFolder.name,
            files: Array.from(selectedFiles),
            data_type: isRaw ? 'raw' : 'result'
        };
        
        if (mode === 'mode-new') {
            // 新建项目 - 使用动态表单数据
            const formData = getFormData();
            
            // 验证必填字段
            const errors = validateFormData(formData);
            if (errors.length > 0) {
                showToast(errors[0], 'warning');
                return;
            }
            
            requestData.project_info = formData;
            
            // 【关键修改】新建项目模式也需要传递 metadata_override 用于后端生成路径
            // 根据 7.5 文件导入设计规范：
            // - file_path 和 file_property 的生成只使用前端传入的 metadata
            // - 新建项目时，metadata_override 应该包含用于路径生成的字段值
            const metadata_override = {};
            if (!isRaw) {
                // 结果数据：传递 results_type 和 results_raw 用于路径生成
                if (formData.results_type) {
                    metadata_override.results_type = formData.results_type;
                }
                if (formData.results_raw) {
                    metadata_override.results_raw = formData.results_raw;
                }
            } else {
                // 原始数据：传递 raw_type, raw_species, raw_tissue 用于路径生成
                if (formData.raw_type) {
                    metadata_override.raw_type = formData.raw_type;
                }
                if (formData.raw_species) {
                    metadata_override.raw_species = formData.raw_species;
                }
                if (formData.raw_tissue) {
                    metadata_override.raw_tissue = formData.raw_tissue;
                }
            }
            requestData.metadata_override = metadata_override;
            
            // 使用异步导入 API
            apiPost('/api/files/import/async', requestData).then(function(res) {
                if (res.success && res.task_id) {
                    // 开始轮询任务状态
                    pollImportTaskStatus(res.task_id, 'new');
                } else {
                    showToast(res.message || '创建导入任务失败', 'error');
                }
            }).catch(function(err) {
                showToast('创建导入任务失败: ' + (err.responseJSON?.message || err.statusText), 'error');
            });
        } else {
            // 选择已有项目
            const projectId = $('#target-project').val();
            if (!projectId) {
                showToast('请选择项目', 'warning');
                return;
            }
            
            requestData.project_id = projectId;
            
            // 收集 metadata_override（用户修改的字段值）- 动态收集，不硬编码字段名
            const metadata_override = {};
            
            // 遍历 metadataFields 动态收集可编辑字段的值
            metadataFields.forEach(function(field) {
                const fieldId = 'metadata-' + field.field_id;
                const fieldEl = $('#' + fieldId);
                
                if (fieldEl.length) {
                    const fieldValue = fieldEl.val();
                    
                    // 对于特殊字段进行合并处理
                    if (isRaw && field.field_id === 'raw_tissue') {
                        // raw_tissue 字段：单选，收集新选择的值
                        const newValue = fieldValue && typeof fieldValue === 'string' ? fieldValue.trim() : '';
                        if (newValue) {
                            metadata_override[field.field_id] = newValue;
                        }
                    } else if (!isRaw && field.field_id === 'results_raw') {
                        // results_raw 字段：只收集新输入的值，不合并已有值
                        // 注意：合并已有值由后端 merge_field_value 处理
                        // file_path 和 file_property 生成只使用前端输入，不查询数据库
                        if (fieldValue && typeof fieldValue === 'string' && fieldValue.trim()) {
                            metadata_override[field.field_id] = fieldValue.trim();
                        }
                        // 如果用户没有输入新值，不传递任何值，后端不更新此字段
                    } else if (!isRaw && field.field_id === 'results_type') {
                        // results_type 字段：只收集新选择的值，不合并已有值
                        // file_path 和 file_property 生成只使用前端输入，不查询数据库
                        if (fieldValue && typeof fieldValue === 'string' && fieldValue.trim()) {
                            metadata_override[field.field_id] = fieldValue.trim();
                        }
                        // 如果用户没有选择新值，不传递任何值
                    } else {
                        // 其他字段直接收集值
                        if (fieldValue) {
                            if (Array.isArray(fieldValue)) {
                                metadata_override[field.field_id] = fieldValue.join(',');
                            } else {
                                metadata_override[field.field_id] = fieldValue;
                            }
                        }
                    }
                }
            });
            
            // 逗号规范化：将各种分隔符替换为英文逗号
            // 使用 Unicode 转义序列确保正确匹配全角字符
            const normalizeCommas = (str) => {
                if (!str || typeof str !== 'string') return str;
                // 替换各种分隔符为英文逗号：全角问号(U+FF1F)、全角逗号(U+FF0C)、英文问号(U+003F)
                return str.replace(/[\uFF1F\uFF0C\u003F\u002C]/g, ',');
            };
            
            // 对所有 metadata_override 值进行逗号规范化
            Object.keys(metadata_override).forEach(key => {
                metadata_override[key] = normalizeCommas(metadata_override[key]);
            });
            
            requestData.metadata_override = metadata_override;
            
            // 使用异步导入 API
            apiPost('/api/files/import/async', requestData).then(function(res) {
                if (res.success && res.task_id) {
                    // 开始轮询任务状态
                    pollImportTaskStatus(res.task_id, 'new');
                } else {
                    showToast(res.message || '创建导入任务失败', 'error');
                }
            }).catch(function(err) {
                showToast('创建导入任务失败: ' + (err.responseJSON?.message || err.statusText), 'error');
            });
        }
    }

    // ==================== 查看功能 ====================
    function viewFolderDetails(folderIndex) {
        const folder = downloadFolders[folderIndex];
        const content = $('#detail-content');
        
        let html = `
            <div class="mb-3">
                <strong>文件夹:</strong> ${folder.name}
            </div>
            <div class="mb-3">
                <strong>路径:</strong> <code>${folder.path}</code>
            </div>
            <div class="mb-3">
                <strong>文件列表:</strong>
                <ul class="list-group mt-2">
        `;
        
        (folder.files || []).forEach(function(f) {
            html += `<li class="list-group-item d-flex justify-content-between">
                <span>${f.name}</span>
                <small class="text-muted">${formatSize(f.size)}</small>
            </li>`;
        });
        
        html += `
                </ul>
            </div>
        `;
        
        content.html(html);
        new bootstrap.Modal($('#detail-modal')).show();
    }

    // ==================== 项目校验弹窗 ====================
    let currentVerifiedHash = {};  // 存储当前计算的哈希值
    
    function showProjectVerify(projectId, projectType) {
        apiGet('/api/files', { project_id: projectId }).then(function(res) {
            if (res.success && res.files) {
                currentVerifiedHash = {};  // 重置哈希值
                const content = $('#verify-content');

                let html = `
                    <div class="row mb-3">
                        <div class="col-md-6"><strong>项目编号:</strong> ${projectId}</div>
                        <div class="col-md-6"><strong>数据类型:</strong> ${projectType === 'raw' ? '原始数据' : '结果数据'}</div>
                    </div>
                    <div class="mb-3"><strong>文件数量:</strong> ${res.total || 0}</div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="mb-0"><strong>文件列表:</strong></div>
                        <div>
                            <button type="button" class="btn btn-primary btn-sm" id="calculate-hash-btn" onclick="calculateSelectedHash()">
                                <i class="bi bi-calculator me-1"></i>校验选中
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th><input type="checkbox" onchange="toggleAllVerifyFiles(this)"></th>
                                    <th>文件名</th>
                                    <th>属性</th>
                                    <th style="width: 35%;">MD5</th>
                                    <th style="width: 35%;">SHA256</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                if (res.files.length === 0) {
                    html += `<tr><td colspan="5" class="text-center py-3 text-muted">暂无文件</td></tr>`;
                } else {
                    res.files.forEach(function(f) {
                        const oldMd5 = f.file_MD5 || '-';
                        const oldSha256 = f.file_SHA256 || '-';
                        html += `<tr data-file-id="${f.id}">
                            <td><input type="checkbox" class="verify-file-check" value="${f.id}" data-filename="${f.file_name}"></td>
                            <td>${f.file_name}</td>
                            <td>${f.file_property || '-'}</td>
                            <td><div class="hash-display" id="md5-${f.id}">旧：${oldMd5}<br>新：<span style="color: #999;">-</span></div></td>
                            <td><div class="hash-display" id="sha256-${f.id}" style="font-size: 0.875em;">旧：${oldSha256}<br>新：<span style="color: #999;">-</span></div></td>
                        </tr>`;
                    });
                }

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                content.html(html);
                new bootstrap.Modal($('#verify-modal')).show();
            } else {
                showToast(res.message || '获取文件列表失败', 'error');
            }
        }).catch(function(err) {
            showToast('获取文件列表失败: ' + (err.responseJSON?.message || err.statusText), 'error');
        });
    }

    // ==================== 项目详情弹窗 ====================
    function showProjectDetail(projectId, projectType) {
        apiGet('/api/files', { project_id: projectId }).then(function(res) {
            if (res.success && res.files) {
                currentProjectFiles = res.files;
                const content = $('#detail-content');

                let html = `
                    <div class="row mb-3">
                        <div class="col-md-6"><strong>项目编号:</strong> ${projectId}</div>
                        <div class="col-md-6"><strong>数据类型:</strong> ${projectType === 'raw' ? '原始数据' : '结果数据'}</div>
                    </div>
                    <div class="mb-3"><strong>文件数量:</strong> ${res.total || 0}</div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="mb-0"><strong>文件列表:</strong></div>
                        <div>
                            <button type="button" class="btn btn-outline-danger btn-sm me-1" onclick="deleteSelectedFiles()">
                                <i class="bi bi-trash"></i> 删除选中
                            </button>
                            <button type="button" class="btn btn-primary btn-sm" onclick="downloadSelectedFiles()">
                                <i class="bi bi-download me-1"></i>下载选中
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th><input type="checkbox" onchange="toggleAllProjectFiles(this)"></th>
                                    <th>文件名</th>
                                    <th>属性</th>
                                    <th>大小</th>
                                    <th>类型</th>
                                    <th>导入时间</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                if (res.files.length === 0) {
                    html += `<tr><td colspan="6" class="text-center py-3 text-muted">暂无文件</td></tr>`;
                } else {
                    res.files.forEach(function(f) {
                        html += `<tr data-file-id="${f.id}">
                            <td><input type="checkbox" class="project-file-check" value="${f.id}" data-filename="${f.file_name}"></td>
                            <td>${f.file_name}</td>
                            <td>${f.file_property || '-'}</td>
                            <td>${formatSize(f.file_size)}</td>
                            <td>${f.file_type || '-'}</td>
                            <td>${f.imported_at ? f.imported_at : '-'}</td>
                        </tr>`;
                    });
                }

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                content.html(html);
                new bootstrap.Modal($('#detail-modal')).show();
            } else {
                showToast(res.message || '获取文件列表失败', 'error');
            }
        }).catch(function(err) {
            showToast('获取文件列表失败: ' + (err.responseJSON?.message || err.statusText), 'error');
        });
    }
    
    function toggleAllVerifyFiles(checkbox) {
        $('.verify-file-check').prop('checked', checkbox.checked);
    }
    
    function getVerifyFileIds() {
        const ids = [];
        $('.verify-file-check:checked').each(function() {
            ids.push(parseInt($(this).val()));
        });
        return ids;
    }
    
    function formatHashValue(md5, sha256) {
        let result = '';
        if (md5) {
            result += `<span style="font-size: 0.875em;">MD5：${md5}</span><br>`;
        }
        if (sha256) {
            result += `<span style="font-size: 0.875em;">SHA256：${sha256}</span>`;
        }
        return result || '-';
    }
    
    function calculateSelectedHash() {
        const fileIds = getVerifyFileIds();
        
        if (fileIds.length === 0) {
            showToast('请选择要校验的文件', 'warning');
            return;
        }
        
        // 禁用按钮，防止重复点击
        $('#calculate-hash-btn').prop('disabled', true).html('<i class="bi bi-spinner spin me-1"></i>正在计算...');
        
        apiPost('/api/files/hash/calculate', { file_ids: fileIds }).then(function(res) {
            if (res.success && res.task_id) {
                // 开始轮询任务状态
                pollHashTaskStatus(res.task_id);
            } else {
                showToast(res.message || '创建计算任务失败', 'error');
                resetCalculateButton();
            }
        }).catch(function(err) {
            showToast('创建计算任务失败: ' + (err.responseJSON?.message || err.statusText), 'error');
            resetCalculateButton();
        });
    }
    
    function pollHashTaskStatus(taskId) {
        const pollInterval = setInterval(function() {
            apiGet(`/api/files/hash/status/${taskId}`).then(function(res) {
                if (!res.success) {
                    clearInterval(pollInterval);
                    showToast('任务状态查询失败', 'error');
                    resetCalculateButton();
                    return;
                }
                
                const status = res.status;
                const current = res.current;
                const total = res.total;
                const progress = res.progress;
                
                // 更新进度提示
                if (status === 'running') {
                    showToast(`正在计算: ${current}/${total} 文件 (${progress}%)`, 'info');
                } else if (status === 'completed') {
                    clearInterval(pollInterval);
                    
                    // 更新显示
                    for (const [fileId, hashData] of Object.entries(res.results)) {
                        const newMd5 = hashData.md5 || '-';
                        const newSha256 = hashData.sha256 || '-';
                        
                        // 更新MD5列的新值
                        const md5El = $(`#md5-${fileId}`);
                        if (md5El.length > 0) {
                            const oldMd5Text = md5El.html().split('<br>')[0]; // 保留旧MD5值
                            md5El.html(`${oldMd5Text}<br>新：${newMd5}`);
                        }
                        
                        // 更新SHA256列的新值
                        const sha256El = $(`#sha256-${fileId}`);
                        if (sha256El.length > 0) {
                            const oldSha256Text = sha256El.html().split('<br>')[0]; // 保留旧SHA256值
                            sha256El.html(`${oldSha256Text}<br>新：${newSha256}`);
                        }
                        
                        // 存储计算的哈希值
                        currentVerifiedHash[fileId] = hashData;
                    }
                    
                    showToast(`成功计算 ${total} 个文件的哈希值`, 'success');
                    resetCalculateButton();
                } else if (status === 'failed') {
                    clearInterval(pollInterval);
                    showToast('计算失败: ' + (res.error || '未知错误'), 'error');
                    resetCalculateButton();
                }
            }).catch(function(err) {
                clearInterval(pollInterval);
                showToast('任务状态查询失败: ' + (err.responseJSON?.message || err.statusText), 'error');
                resetCalculateButton();
            });
        }, 7500); // 每7.5秒轮询一次
    }
    
    function resetCalculateButton() {
        $('#calculate-hash-btn').prop('disabled', false).html('<i class="bi bi-calculator me-1"></i>校验选中');
    }
    
    function saveVerifiedHash() {
        if (Object.keys(currentVerifiedHash).length === 0) {
            showToast('没有可保存的哈希值，请先进行校验', 'warning');
            return;
        }
        
        if (!confirm('确定要保存这些哈希值到数据库吗？')) {
            return;
        }
        
        apiPost('/api/files/hash/save', { hash_values: currentVerifiedHash }).then(function(res) {
            if (res.success) {
                showToast(res.message, 'success');
                $('#verify-modal').modal('hide');
                // 刷新项目列表
                loadImportedProjects();
            } else {
                showToast(res.message || '保存哈希值失败', 'error');
            }
        }).catch(function(err) {
            showToast('保存哈希值失败: ' + (err.responseJSON?.message || err.statusText), 'error');
        });
    }

    // ==================== 文件操作 ====================
    function toggleAllProjectFiles(checkbox) {
        $('.project-file-check').prop('checked', checkbox.checked);
    }

    function getSelectedFileIds() {
        const ids = [];
        $('.project-file-check:checked').each(function() {
            ids.push(parseInt($(this).val()));
        });
        return ids;
    }

    function getSelectedFileNames() {
        const names = [];
        $('.project-file-check:checked').each(function() {
            names.push($(this).data('filename'));
        });
        return names;
    }

    function deleteSelectedFiles() {
        const fileIds = getSelectedFileIds();
        const fileNames = getSelectedFileNames();
        
        if (fileIds.length === 0) {
            showToast('请选择要删除的文件', 'warning');
            return;
        }
        
        // 确认删除
        if (!confirm(`确定要删除选中的 ${fileIds.length} 个文件吗？
文件将被移动到回收站。`)) {
            return;
        }
        
        // 使用异步删除 API
        apiPost('/api/files/delete/async', { file_ids: fileIds }).then(function(res) {
            if (res.success && res.task_id) {
                // 开始轮询任务状态
                pollDeleteTaskStatus(res.task_id);
            } else {
                showToast(res.message || '创建删除任务失败', 'error');
            }
        }).catch(function(err) {
            showToast('创建删除任务失败: ' + (err.responseJSON?.message || err.statusText), 'error');
        });
    }
    
    function pollDeleteTaskStatus(taskId) {
        const pollInterval = setInterval(function() {
            apiGet(`/api/task/status/${taskId}`).then(function(res) {
                if (!res.success) {
                    clearInterval(pollInterval);
                    showToast('任务状态查询失败', 'error');
                    return;
                }
                
                const status = res.task.status;
                const taskName = res.task.name || '删除任务';
                
                // 更新进度提示
                if (status === 'running') {
                    showToast(`${taskName} 正在进行中...`, 'info');
                } else if (status === 'completed') {
                    clearInterval(pollInterval);
                    
                    const result = res.task.result || {};
                    const deleted = result.deleted || 0;
                    const total = result.total || 0;
                    
                    showToast(`${result.message || `成功删除 ${deleted}/${total} 个文件`}`, 'success');
                    
                    // 关闭详情弹窗并刷新列表
                    $('#detail-modal').modal('hide');
                    loadImportedProjects();
                } else if (status === 'failed') {
                    clearInterval(pollInterval);
                    showToast(`${taskName} 失败: ` + (res.task.error || '未知错误'), 'error');
                }
            }).catch(function(err) {
                clearInterval(pollInterval);
                showToast('任务状态查询失败: ' + (err.responseJSON?.message || err.statusText), 'error');
            });
        }, 7500); // 每7.5秒轮询一次
    }
    
    function pollImportTaskStatus(taskId, projectType) {
        const pollInterval = setInterval(function() {
            apiGet(`/api/task/status/${taskId}`).then(function(res) {
                if (!res.success) {
                    clearInterval(pollInterval);
                    showToast('任务状态查询失败', 'error');
                    return;
                }
                
                const status = res.task.status;
                const taskName = res.task.name || '导入任务';
                
                // 更新进度提示
                if (status === 'running') {
                    showToast(`${taskName} 正在进行中...`, 'info');
                } else if (status === 'completed') {
                    clearInterval(pollInterval);
                    
                    const result = res.task.result || {};
                    const imported = result.imported || 0;
                    const total = result.total || 0;
                    
                    showToast(`${result.message || `成功导入 ${imported}/${total} 个文件`}`, 'success');
                    
                    // 关闭导入弹窗并刷新列表
                    $('#import-modal').modal('hide');
                    scanDownloads();
                    loadImportedProjects();
                } else if (status === 'failed') {
                    clearInterval(pollInterval);
                    showToast(`${taskName} 失败: ` + (res.task.error || '未知错误'), 'error');
                }
            }).catch(function(err) {
                            clearInterval(pollInterval);
                            showToast('任务状态查询失败: ' + (err.responseJSON?.message || err.statusText), 'error');
                        });
                    }, 7500); // 每7.5秒轮询一次
                }
                
            
                function downloadSelectedFiles() {
        const fileIds = getSelectedFileIds();
        
        if (fileIds.length === 0) {
            showToast('请选择要下载的文件', 'warning');
            return;
        }
        
        // 使用 fetch API 以 JSON 格式发送请求
        fetch('/api/files/download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ file_ids: fileIds })
        })
        .then(response => {
            // 检查响应类型
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/zip')) {
                // 返回的是文件下载
                return response.blob().then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'download.zip';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                });
            } else {
                // 返回的是错误信息
                return response.json().then(data => {
                    showToast(data.message || '下载失败', 'error');
                });
            }
        })
        .catch(function(err) {
            showToast('下载失败: ' + (err.message || err.statusText), 'error');
        });
    }

    // ==================== 筛选功能 ====================
    function applyFilter() {
        loadImportedProjects();
    }

    function resetFilter() {
        $('#filter-project-type').val('');
        $('#filter-project-id').val('');
        loadImportedProjects();
    }

    // ==================== 工具函数 ====================
    function refreshFileList() {
        loadImportedProjects();
        showToast('列表已刷新', 'success');
    }

    function formatSize(bytes) {
        if (!bytes || bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
</script>
{% endblock %}<style>
.spin {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
