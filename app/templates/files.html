{% extends "base.html" %}

{% block title %}文件管理 - BioData Manager{% endblock %}

{% block content %}
<!-- 页面头部 -->
<div class="page-header">
    <div class="container">
        <h1 class="mb-2">
            <i class="bi bi-folder2-open me-2"></i>文件管理
        </h1>
        <p class="lead mb-0 opacity-75">文件分类整理、批量导入导出、存储优化</p>
    </div>
</div>

<div class="container">
    <!-- 标签页切换 -->
    <ul class="nav nav-tabs mb-4" id="files-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage-content" type="button" role="tab">
                <i class="bi bi-gear me-2"></i>管理
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import-content" type="button" role="tab">
                <i class="bi bi-upload me-2"></i>导入
            </button>
        </li>
    </ul>

    <!-- 标签页内容 -->
    <div class="tab-content" id="files-tab-content">
        <!-- 管理页面 -->
        <div class="tab-pane fade show active" id="manage-content" role="tabpanel">
            <!-- 筛选卡片 -->
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-funnel me-2"></i>筛选条件
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <select class="form-select form-select-sm" id="filter-project-type">
                                <option value="">项目类型 (全部)</option>
                                <option value="raw">原始数据</option>
                                <option value="result">结果数据</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" 
                                   id="filter-project-id" placeholder="项目编号">
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="applyFilter()">
                                <i class="bi bi-search me-1"></i>查询
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetFilter()">
                                重置
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 项目列表 -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-list me-2"></i>已导入项目</span>
                    <span class="badge bg-success" id="project-count">0 个</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>项目编号</th>
                                    <th>项目名称</th>
                                    <th>数据类型</th>
                                    <th>文件数</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="project-list">
                                {% if projects %}
                                {% for p in projects %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td><code>{{ p.raw_id }}</code></td>
                                    <td>{{ p.raw_title }}</td>
                                    <td><span class="badge bg-info">{{ p.raw_type }}</span></td>
                                    <td>{{ p.raw_file_count or 0 }}</td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm" onclick="showProjectDetail('{{ p.raw_id }}')">
                                            <i class="bi bi-eye"></i> 查看
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-muted">
                                        <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                                        暂无已导入项目
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 导入页面 -->
        <div class="tab-pane fade" id="import-content" role="tabpanel">
            <!-- 文件夹列表 -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-folder me-2"></i>下载目录文件夹</span>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-primary me-2" id="folder-count">0 个</span>
                        <button type="button" class="btn btn-primary btn-sm" onclick="scanDownloads()">
                            <i class="bi bi-search me-1"></i>扫描
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="folder-list">
                        <div class="list-group-item text-center py-4 text-muted">
                            <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                            点击扫描加载文件夹
                        </div>
                    </div>
                </div>
            </div>
<!-- 导入弹窗 -->
<div class="modal fade" id="import-modal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">导入文件</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 目标项目选择 -->
                <div class="mb-3">
                    <label class="form-label fw-bold">目标项目</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="project-mode" id="mode-new" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="mode-new">新建项目</label>
                        
                        <input type="radio" class="btn-check" name="project-mode" id="mode-existing" autocomplete="off">
                        <label class="btn btn-outline-primary" for="mode-existing">选择已有项目</label>
                    </div>
                </div>

                <!-- 选择已有项目表单 -->
                <div class="mb-3" id="existing-project-form" style="display: none;">
                    <label class="form-label">选择项目</label>
                    <select class="form-select" id="target-project">
                        <option value="">请选择项目...</option>
                    </select>
                </div>

                <!-- 数据类型选择 -->
                <div class="mb-3">
                    <label class="form-label fw-bold">数据类型</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="data-type" id="type-raw" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="type-raw">原始数据</label>
                        
                        <input type="radio" class="btn-check" name="data-type" id="type-result" autocomplete="off">
                        <label class="btn btn-outline-primary" for="type-result">结果数据</label>
                    </div>
                </div>

                <!-- 新建项目表单 (两列布局) -->
                <div id="new-project-form">
                    <!-- 项目编号 (固定字段) -->
                    <div class="row g-2 mb-2">
                        <div class="col-md-6">
                            <label class="form-label">项目编号 <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="new-project-id" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="generateProjectId()">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">项目名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="new-project-title" placeholder="请输入项目名称">
                        </div>
                    </div>
                    
                    <!-- 动态元数据字段容器 -->
                    <div id="dynamic-metadata-fields">
                        <!-- 动态渲染的字段将放在这里 -->
                    </div>
                </div>

                <hr>

                <!-- 文件选择区域 -->
                <div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label fw-bold mb-0">选择文件</label>
                        <div>
                            <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="selectAllFiles(true)">全选</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectAllFiles(false)">取消全选</button>
                        </div>
                    </div>
                    <div class="border rounded p-2 bg-light" style="max-height: 200px; overflow-y: auto;" id="file-selection-area">
                        <p class="text-muted text-center mb-0">请先选择要导入的文件夹</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirmImport()">
                    <i class="bi bi-upload me-1"></i>导入
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 详情弹窗 -->
<div class="modal fade" id="detail-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">项目详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detail-content">
                <!-- 动态填充 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="downloadSelectedFiles()">
                    <i class="bi bi-download me-1"></i>下载选中文件
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 全局数据
    let downloadFolders = [];
    let projects = [];
    let currentFolder = null;
    let selectedFiles = new Set();

    // ==================== 初始化 ====================
    $(document).ready(function() {
        loadProjects();
        setupEventListeners();
    });

    // 设置事件监听
    function setupEventListeners() {
        // 项目模式切换
        $('input[name="project-mode"]').change(function() {
            const mode = $(this).attr('id');
            if (mode === 'mode-new') {
                $('#new-project-form').show();
                $('#existing-project-form').hide();
            } else {
                $('#new-project-form').hide();
                $('#existing-project-form').show();
                loadExistingProjects();
            }
        });

        // 数据类型切换
        $('input[name="data-type"]').change(function() {
            updateProjectIdPrefix();
            loadMetadataFields(); // 重新加载元数据字段
        });
    }

    // ==================== 动态元数据字段 ====================
    let metadataFields = [];

    function loadMetadataFields() {
        const dataType = $('input[name="data-type"]:checked').attr('id');
        const tableType = dataType === 'type-raw' ? 'raw' : 'result';
        
        apiGet('/api/metadata/fields', { table: tableType }).then(function(res) {
            if (res.success && res.fields) {
                // 过滤出可编辑字段（field_readonly=0）并按 field_seq 排序
                const editableFields = res.fields
                    .filter(f => f.field_readonly === false || f.field_readonly === 0)
                    .sort((a, b) => a.field_seq - b.field_seq);
                
                // 排除前端已硬编码的前2个字段（raw_id, raw_title 或 results_id, results_title）
                const dynamicFields = editableFields.slice(2);
                
                // 根据项目类型限制显示数量：
                // 原始数据项目：显示排序前3-7号（共5个）
                // 结果数据项目：显示排序前3-5号（共3个）
                const maxFields = tableType === 'raw' ? 5 : 3;
                metadataFields = dynamicFields.slice(0, maxFields);
                
                renderMetadataFields();
            } else {
                metadataFields = [];
                renderMetadataFields();
            }
        }).catch(function() {
            metadataFields = [];
            renderMetadataFields();
        });
    }

    function renderMetadataFields() {
        const container = $('#dynamic-metadata-fields');
        
        if (metadataFields.length === 0) {
            // 没有字段时显示提示
            container.html(`
                <p class="text-muted text-center py-3 mb-0">暂无可编辑的元数据字段</p>
            `);
            return;
        }
        
        let html = '';
        let colIndex = 0;
        const colsPerRow = 2;
        
        metadataFields.forEach(function(field, index) {
            const colClass = colsPerRow === 2 ? 'col-md-6' : 'col-12';
            const requiredMark = field.field_necessary ? '<span class="text-danger">*</span>' : '';
            const fieldId = 'metadata-' + field.field_id;
            const fieldLabel = field.field_name;
            const fieldOptions = field.field_options || [];
            
            // 开始新行
            if (colIndex === 0) {
                html += '<div class="row g-2 mb-2">';
            }
            
            // 根据字段类型生成不同的表单控件
            let inputHtml = '';
            if (field.field_type === 'select' || field.field_type === 'multi_select') {
                // 下拉选择框
                const multiple = field.field_type === 'multi_select';
                const selectAttr = multiple ? 'multiple' : '';
                
                inputHtml = `<select class="form-select" id="${fieldId}" name="${field.field_id}" ${selectAttr}>
                    <option value="">请选择...</option>
                    ${fieldOptions.map(function(opt) {
                        const val = opt.value !== undefined ? opt.value : opt;
                        const label = opt.label !== undefined ? opt.label : opt;
                        return `<option value="${val}">${label}</option>`;
                    }).join('')}
                </select>`;
            } else if (field.field_type === 'textarea') {
                // 文本域
                inputHtml = `<textarea class="form-control" id="${fieldId}" name="${field.field_id}" rows="3" placeholder="请输入${fieldLabel}"></textarea>`;
            } else {
                // 文本输入框
                inputHtml = `<input type="text" class="form-control" id="${fieldId}" name="${field.field_id}" placeholder="请输入${fieldLabel}">`;
            }
            
            html += `
                <div class="${colClass}">
                    <label class="form-label">${fieldLabel} ${requiredMark}</label>
                    ${inputHtml}
                </div>
            `;
            
            colIndex++;
            
            // 结束行
            if (colIndex === colsPerRow || index === metadataFields.length - 1) {
                html += '</div>';
                colIndex = 0;
            }
        });
        
        container.html(html);
    }

    // 获取表单数据
    function getFormData() {
        const dataType = $('input[name="data-type"]:checked').attr('id');
        const isRaw = dataType === 'type-raw';
        
        const formData = {
            project_id: $('#new-project-id').val(),
            project_title: $('#new-project-title').val(),
            data_type: isRaw ? 'raw' : 'result'
        };
        
        // metadataFields 已经是过滤后的字段（只读字段已排除），直接遍历收集数据
        metadataFields.forEach(function(field) {
            const fieldId = field.field_id;
            const fieldEl = $(`[name="${fieldId}"]`);
            
            if (field.field_type === 'multi_select') {
                const values = [];
                fieldEl.find('option:selected').each(function() {
                    values.push($(this).val());
                });
                formData[fieldId] = values;
            } else {
                formData[fieldId] = fieldEl.val();
            }
        });
        
        return formData;
    }

    // 验证表单
    function validateFormData(data) {
        const errors = [];
        
        // 检查项目名称
        if (!data.project_title) {
            errors.push('项目名称为必填字段');
        }
        
        // metadataFields 已经是过滤后的字段，直接遍历即可
        metadataFields.forEach(function(field) {
            if (field.field_necessary) {
                const value = data[field.field_id];
                if (!value || (Array.isArray(value) && value.length === 0)) {
                    errors.push(`${field.field_name} 为必填字段`);
                }
            }
        });
        
        return errors;
    }

    // 更新项目编号前缀
    function updateProjectIdPrefix() {
        const dataType = $('input[name="data-type"]:checked').attr('id');
        const prefix = dataType === 'type-raw' ? 'RAW_' : 'RES_';
        $('#new-project-id').val(prefix + '________');
    }

    // 生成项目编号
    function generateProjectId() {
        const dataType = $('input[name="data-type"]:checked').attr('id');
        const prefix = dataType === 'type-raw' ? 'RAW_' : 'RES_';
        const uuid = Math.random().toString(36).substring(2, 10).toUpperCase();
        $('#new-project-id').val(prefix + uuid);
    }

    // ==================== 扫描功能 ====================
    function scanDownloads() {
        updateScanStatus('running', '扫描中...');
        
        apiGet('/api/scan-downloads').then(function(res) {
            if (res.success && res.task_id) {
                pollScanTask(res.task_id, function(result) {
                    downloadFolders = result || [];
                    renderFolderList();
                    updateScanStatus('completed', `完成 (${downloadFolders.length})`);
                });
            } else {
                updateScanStatus('failed', '启动失败');
            }
        }).catch(function() {
            updateScanStatus('failed', '启动失败');
        });
    }

    function pollScanTask(taskId, callback) {
        const timer = setInterval(function() {
            apiGet('/api/task/status/' + taskId).then(function(res) {
                if (res.success && res.task) {
                    const task = res.task;
                    if (task.status === 'running') {
                        updateScanStatus('running', task.message);
                    } else if (task.status === 'completed') {
                        clearInterval(timer);
                        callback(task.result);
                    } else if (task.status === 'failed') {
                        clearInterval(timer);
                        updateScanStatus('failed', '扫描失败');
                    }
                }
            });
        }, 500);
    }

    function updateScanStatus(status, message) {
        if (status === 'running') {
            showToast(message, 'info', 5000);
        } else if (status === 'completed') {
            showToast('扫描完成，发现 ' + downloadFolders.length + ' 个文件夹', 'success');
        } else if (status === 'failed') {
            showToast(message || '扫描失败', 'error');
        }
    }

    // ==================== 渲染函数 ====================
    function renderFolderList() {
        const list = $('#folder-list');
        $('#folder-count').text(downloadFolders.length + ' 个');
        
        if (downloadFolders.length === 0) {
            list.html(`
                <div class="list-group-item text-center py-4 text-muted">
                    <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                    暂无文件夹
                </div>
            `);
        } else {
            let html = '';
            downloadFolders.forEach(function(f, index) {
                html += `
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-folder me-2 text-warning"></i>
                            <span class="fw-medium">${f.name}</span>
                            <small class="text-muted d-block">${f.file_count} 个文件</small>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-1" onclick="openImportModal('${index}')">
                                <i class="bi bi-upload"></i> 导入
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="viewFolderDetails('${index}')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            list.html(html);
        }
    }

    function renderProjectList() {
        const tbody = $('#project-list');
        $('#project-count').text(projects.length + ' 个');
        
        if (projects.length === 0) {
            tbody.html(`
                <tr>
                    <td colspan="6" class="text-center py-4 text-muted">
                        <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                        暂无已导入项目
                    </td>
                </tr>
            `);
        } else {
            let html = '';
            projects.forEach(function(p, index) {
                const dataTypeLabel = getDataTypeLabel(p.data_type || p.results_type);
                const fileCount = p.raw_file_count || p.results_file_count || 0;
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><code>${p.id || p.raw_id || p.results_id}</code></td>
                        <td>${p.title || p.raw_title || p.results_title}</td>
                        <td><span class="badge bg-info">${dataTypeLabel}</span></td>
                        <td>${fileCount}</td>
                        <td>
                            <button class="btn btn-outline-primary btn-sm" onclick="showProjectDetail('${p.id || p.raw_id || p.results_id}')">
                                <i class="bi bi-eye"></i> 查看
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.html(html);
        }
    }

    function getDataTypeLabel(type) {
        const labels = {
            'rnaseq': 'RNA-Seq',
            'singlecell': '单细胞',
            'spatial': '空间组',
            'proteomics': '蛋白组',
            'phosphoproteomics': '磷酸化组',
            'multiomics': '多组学',
            'alignment': '比对',
            'counts': '计数矩阵',
            'peak_calling': 'Peak Calling',
            'variants': '变异检测',
            'enrichment': '富集分析',
            'visualization': '可视化',
            'other': '其他'
        };
        return labels[type] || type || '未分类';
    }

    // ==================== 项目加载 ====================
    function loadProjects() {
        // 先清空现有项目
        projects = [];
        
        // 并发加载原始数据和结果数据项目
        apiGet('/api/projects').then(function(res) {
            if (res.success && res.data) {
                projects = res.data;
                renderProjectList();
            }
        });
        
        apiGet('/api/bioresult-projects').then(function(res) {
            if (res.success && res.projects) {
                projects = projects.concat(res.projects);
                renderProjectList();
            }
        });
    }

    function loadExistingProjects() {
        const select = $('#target-project');
        const dataType = $('input[name="data-type"]:checked').attr('id');
        const type = dataType === 'type-raw' ? 'raw' : 'result';
        
        select.empty().append('<option value="">请选择项目...</option>');
        
        const filteredProjects = projects.filter(function(p) {
            if (type === 'raw') return p.raw_id;
            return p.results_id;
        });
        
        filteredProjects.forEach(function(p) {
            const id = p.raw_id || p.results_id;
            const title = p.raw_title || p.results_title;
            select.append(`<option value="${id}">${id} - ${title}</option>`);
        });
    }

    // ==================== 导入功能 ====================
    function openImportModal(folderIndex) {
        currentFolder = downloadFolders[folderIndex];
        selectedFiles.clear();
        
        // 重置表单
        $('#mode-new').prop('checked', true).trigger('change');
        generateProjectId();
        
        // 加载动态元数据字段
        loadMetadataFields();
        
        // 渲染文件选择区域
        renderFileSelection(currentFolder.files || []);
        
        // 显示弹窗
        new bootstrap.Modal($('#import-modal')).show();
    }

    function renderFileSelection(files) {
        const area = $('#file-selection-area');
        
        if (!files || files.length === 0) {
            area.html('<p class="text-muted text-center mb-0">该文件夹为空</p>');
            return;
        }
        
        let html = '';
        files.forEach(function(f, index) {
            const fileId = `file-${index}`;
            html += `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="${fileId}" value="${f.name}" 
                           onchange="toggleFileSelect(this)">
                    <label class="form-check-label" for="${fileId}">
                        ${f.name} <small class="text-muted">(${formatSize(f.size)})</small>
                    </label>
                </div>
            `;
        });
        area.html(html);
    }

    function toggleFileSelect(checkbox) {
        if (checkbox.checked) {
            selectedFiles.add(checkbox.value);
        } else {
            selectedFiles.delete(checkbox.value);
        }
    }

    function selectAllFiles(select) {
        $('#file-selection-area input[type="checkbox"]').each(function() {
            $(this).prop('checked', select);
            if (select) {
                selectedFiles.add($(this).val());
            } else {
                selectedFiles.delete($(this).val());
            }
        });
    }

    function confirmImport() {
        const mode = $('input[name="project-mode"]:checked').attr('id');
        const dataType = $('input[name="data-type"]:checked').attr('id');
        const isRaw = dataType === 'type-raw';
        
        if (selectedFiles.size === 0) {
            showToast('请选择要导入的文件', 'warning');
            return;
        }
        
        const requestData = {
            folder_name: currentFolder.name,
            files: Array.from(selectedFiles),
            data_type: isRaw ? 'raw' : 'result'
        };
        
        if (mode === 'mode-new') {
            // 新建项目 - 使用动态表单数据
            const formData = getFormData();
            
            // 验证必填字段
            const errors = validateFormData(formData);
            if (errors.length > 0) {
                showToast(errors[0], 'warning');
                return;
            }
            
            requestData.project_info = formData;
            
            apiPost('/api/import-download', requestData).then(function(res) {
                if (res.success) {
                    showToast('导入成功');
                    $('#import-modal').modal('hide');
                    scanDownloads();
                    loadProjects();
                } else {
                    showToast(res.message || '导入失败', 'error');
                }
            });
        } else {
            // 选择已有项目
            requestData.project_id = $('#target-project').val();
            if (!requestData.project_id) {
                showToast('请选择项目', 'warning');
                return;
            }
            
            apiPost('/api/import-download', requestData).then(function(res) {
                if (res.success) {
                    showToast('导入成功');
                    $('#import-modal').modal('hide');
                    scanDownloads();
                    loadProjects();
                } else {
                    showToast(res.message || '导入失败', 'error');
                }
            });
        }
    }

    // ==================== 查看功能 ====================
    function viewFolderDetails(folderIndex) {
        const folder = downloadFolders[folderIndex];
        const content = $('#detail-content');
        
        let html = `
            <div class="mb-3">
                <strong>文件夹:</strong> ${folder.name}
            </div>
            <div class="mb-3">
                <strong>路径:</strong> <code>${folder.path}</code>
            </div>
            <div class="mb-3">
                <strong>文件列表:</strong>
                <ul class="list-group mt-2">
        `;
        
        (folder.files || []).forEach(function(f) {
            html += `<li class="list-group-item d-flex justify-content-between">
                <span>${f.name}</span>
                <small class="text-muted">${formatSize(f.size)}</small>
            </li>`;
        });
        
        html += `
                </ul>
            </div>
        `;
        
        content.html(html);
        new bootstrap.Modal($('#detail-modal')).show();
    }

    function showProjectDetail(projectId) {
        apiGet('/api/projects/raw/' + projectId).then(function(res) {
            if (res.success && res.project) {
                const p = res.project;
                const content = $('#detail-content');

                let html = `
                    <div class="row mb-3">
                        <div class="col-md-6"><strong>项目编号:</strong> ${p.raw_id}</div>
                        <div class="col-md-6"><strong>数据类型:</strong> ${p.raw_type || '-'}</div>
                    </div>
                    <div class="mb-3"><strong>项目名称:</strong> ${p.raw_title || '-'}</div>
                    <div class="mb-3"><strong>物种:</strong> ${p.raw_species || '-'}</div>
                    ${p.raw_DOI ? `<div class="mb-3"><strong>DOI:</strong> ${p.raw_DOI}</div>` : ''}
                    ${p.raw_description ? `<div class="mb-3"><strong>描述:</strong> ${p.raw_description}</div>` : ''}
                    <hr>
                    <div class="mb-2"><strong>文件列表:</strong></div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead><tr><th>文件名</th><th>大小</th><th><input type="checkbox" onchange="toggleAllProjectFiles(this)"></th></tr></thead>
                            <tbody>
                `;

                (p.files || []).forEach(function(f) {
                    html += `<tr>
                        <td>${f.file_name}</td>
                        <td>${formatSize(f.file_size)}</td>
                        <td><input type="checkbox" class="project-file-check" value="${f.file_path}"></td>
                    </tr>`;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                content.html(html);
                new bootstrap.Modal($('#detail-modal')).show();
            } else {
                showToast(res.message || '获取项目详情失败', 'error');
            }
        }).catch(function(err) {
            showToast('获取项目详情失败: ' + (err.responseJSON?.message || err.statusText), 'error');
        });
    }

    function toggleAllProjectFiles(checkbox) {
        $('.project-file-check').prop('checked', checkbox.checked);
    }

    function downloadSelectedFiles() {
        const selected = [];
        $('.project-file-check:checked').each(function() {
            selected.push($(this).val());
        });
        
        if (selected.length === 0) {
            showToast('请选择要下载的文件', 'warning');
            return;
        }
        
        showToast('下载功能开发中', 'info');
    }

    // ==================== 筛选功能 ====================
    function applyFilter() {
        const type = $('#filter-project-type').val();
        const id = $('#filter-project-id').val().trim();
        
        let filtered = projects;
        
        if (type) {
            if (type === 'raw') {
                filtered = filtered.filter((p) => p.raw_id);
            } else {
                filtered = filtered.filter((p) => p.results_id);
            }
        }
        
        if (id) {
            filtered = filtered.filter(function(p) {
                const pid = p.raw_id || p.results_id || '';
                return pid.toLowerCase().includes(id.toLowerCase());
            });
        }
        
        const originalProjects = projects;
        projects = filtered;
        renderProjectList();
        projects = originalProjects; // 恢复
    }

    function resetFilter() {
        $('#filter-project-type').val('');
        $('#filter-project-id').val('');
        loadProjects();
    }

    // ==================== 工具函数 ====================
    function refreshFileList() {
        loadProjects();
        showToast('列表已刷新', 'success');
    }

    function formatSize(bytes) {
        if (!bytes || bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
</script>
{% endblock %}