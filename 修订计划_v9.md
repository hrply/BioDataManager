# BioData Manager 综合修订计划 v9

## 修订日期: 2026-01-23

> ⚠️ **全局重要说明**：本计划包含 26 个测试用例，任何用例遗漏都可能导致问题未被发现。每个用例必须执行并记录"实际结果"和"判定"，不能仅验证"无错误"。

---

# 一、问题清单速查（必须全部覆盖）

| ID | 问题描述 | 修改文件 | 验证方法 |
|----|----------|----------|----------|
| **A** | file_record 新增 file_project_ref_id 字段 | database_mysql.py | DB-01 ~ DB-03 |
| **B** | confirmImport 动态收集字段（不用硬编码） | files.html | B-01 ~ B-03 |
| **C1** | 原始数据详情弹窗显示所有字段（含 raw_db_link） | raw_data.html | DET-01a, DET-01b |
| **C2** | 结果数据详情弹窗显示所有字段（含 results_DOI, results_db_link） | results.html | DET-03a, DET-03b |
| **D** | 筛选框下拉选项为空 | raw_data.html, results.html | FIL-01 ~ FIL-05 |
| **E** | file_property 显示为空 | backend.py | RAW-01, RAW-02, RES-04, FM-01 |
| **F** | file_list 不返回 file_property | backend.py | API-01 ~ API-04 |
| **G** | files.html 详情不显示 file_property 列 | files.html | FM-01, FM-02 |
| **H** | 同名文件检测 | backend.py | DUP-01 ~ DUP-04 |

---

# 二、核心验证原则

## 2.1 字段值验证（必做）

```
不是验证"没有错误"，而是验证：
  数据库值 = API 返回值 = 页面显示值
```

**示例**：
```bash
# 查询数据库
docker exec biodata-manager python3 -c "
from database_mysql import DatabaseManager
db = DatabaseManager()
result = db.query('SELECT file_property FROM file_record WHERE file_project_id = %s', ('TEST_xxx',))
expected = '转录组-小鼠-Liver'
print(f'实际: {result[0][0]}')
print(f'预期: {expected}')
print('✓ 一致' if result[0][0] == expected else '✗ 不一致')
"
```

## 2.2 文件夹验证（必做）

```
不是验证"文件夹存在"，而是验证：
  1. 无 UNK 文件夹
  2. 无重复文件夹
  3. 无空文件夹
  4. 路径使用缩写（mRseq, Ms, Liv）
```

**验证命令**：
```bash
# 必须执行的验证
docker exec biodata-manager bash -c '
echo "=== 关键检查 ==="
echo "【UNK文件夹】" && find /bio -type d -name "*UNK*" || echo "  ✓ 无"
echo "【空文件夹】" && find /bio -empty -type d || echo "  ✓ 无"
echo "【重复项目】" && find /bio -mindepth 4 -maxdepth 4 -type d -exec basename {} \; | sort | uniq -c | awk '"'"'$1>1'"'"' || echo "  ✓ 无"
'
```

## 2.3 详情弹窗验证（必做）

```
不是验证"弹窗打开"，而是验证：
  原始数据详情显示：raw_title, raw_type, raw_species, raw_tissue, raw_db_link
  结果数据详情显示：results_title, results_type, results_raw, results_DOI, results_db_link
  文件列表显示：file_property, file_project_ref_id
```

---

# 三、修订目标

1. **file_record 表新增关联项目字段**：记录结果文件关联的原始数据项目
2. **confirmImport 动态字段收集**：根据 metadataFields 动态收集而非硬编码
3. **项目详情弹窗动态渲染**：根据 metadata_config 渲染所有配置字段
4. **筛选框下拉选项修复**：确保筛选下拉框加载正确选项
5. **file_property 显示修复**：确保文件属性正确显示
6. **重复文件检测**：同名文件检测并提示用户
7. **全功能回归测试**：确保现有功能不受影响

---

# 四、修改任务

## 4.1 数据库修改

| 序号 | 修改内容 | 文件 |
|------|----------|------|
| 1.1 | 新增 `file_project_ref_id` VARCHAR(50) 字段（可空，COMMENT: '关联项目编号'） | database_mysql.py |

## 4.2 后端修改

| 序号 | 修改内容 | 文件 |
|------|----------|------|
| 2.1 | 修改 `add_file_record` 函数：新增 `ref_project_id` 参数 | backend.py |
| 2.2 | 修改 `add_file_record` 函数：插入时包含 `file_project_ref_id` 字段 | backend.py |
| 2.3 | 修改 `add_file_record` 函数：添加重复文件检测逻辑 | backend.py |
| 2.4 | 修改 `add_file_record` 函数：返回字典包含 success, message, is_duplicate | backend.py |
| 2.5 | 修改 `import_download_files` 函数：传递 `results_raw` 作为 `ref_project_id` | backend.py |
| 2.6 | 修改 `get_files_by_project` 函数：返回完整字段包括 file_property | backend.py |
| 2.7 | 修改 `get_raw_project_by_id` 函数：文件列表 SELECT 包含 file_property | backend.py |
| 2.8 | 修改 `get_result_project_by_id` 函数：文件列表 SELECT 包含 file_property | backend.py |

## 4.3 前端修改

| 序号 | 修改内容 | 文件 |
|------|----------|------|
| 3.1 | 修改 `confirmImport` 函数：移除硬编码字段，遍历 metadataFields 动态收集 | files.html |
| 3.2 | 修改 `raw_data.html` 的 `viewDetail` 函数：动态渲染 metadata_config 中的字段 | raw_data.html |
| 3.3 | 修改 `results.html` 的 `viewDetail` 函数：动态渲染 metadata_config 中的字段 | results.html |
| 3.4 | 修改 `loadFilterOptions` 函数：修复元素 ID 匹配（`filter-type` → `filter-raw_type`） | raw_data.html, results.html |
| 3.5 | 修改 `files.html` 的 `showProjectDetail` 函数：显示 file_property 列 | files.html |
| 3.6 | 修改 `files.html` 的 `showProjectDetail` 函数：显示 file_project_ref_id 列 | files.html |

---

# 五、内测用例

> ⚠️ **重要**：每个用例必须填写"实际结果"和"判定"，不能留空。

## 5.1 问题 A：file_project_ref_id 字段测试

| 用例 | 测试内容 | 预期结果 | 实际结果 | 判定 |
|------|----------|----------|----------|------|
| DB-01 | 检查 file_record 表结构 | 存在 `file_project_ref_id` VARCHAR(50) | | |
| DB-02 | 检查字段注释 | COMMENT 为 '关联项目编号' | | |
| DB-03 | 检查默认值 | 插入不含 ref_project_id 的记录，值为 NULL | | |
| RES-01 | 新建结果项目（有关联） | file_project_ref_id = "TEST_RAW_001" | | |
| RES-02 | 新建结果项目（无关联） | file_project_ref_id = NULL | | |

## 5.2 问题 B：confirmImport 动态字段测试

| 用例 | 测试内容 | 预期结果 | 实际结果 | 判定 |
|------|----------|----------|----------|------|
| B-01 | 动态收集 raw_type | raw_type 存储 label（"转录组"），不是 value（"mRNAseq"） | | |
| B-02 | 动态收集 raw_species | raw_species 存储 label（"人类"），不是 value（"Hs"） | | |
| B-03 | 动态收集 raw_db_link | raw_db_link 字段可编辑，值正确存储 | | |

## 5.3 问题 C1/C2：详情弹窗测试

| 用例 | 测试内容 | 预期结果 | 实际结果 | 判定 |
|------|----------|----------|----------|------|
| DET-01a | 原始数据详情显示 raw_db_link | raw_db_link 字段显示，值与数据库一致 | | |
| DET-01b | 原始数据详情显示所有字段 | raw_title, raw_type, raw_species, raw_tissue, raw_db_link **全部显示** | | |
| DET-03a | 结果数据详情显示 results_DOI | results_DOI 字段显示，值与数据库一致 | | |
| DET-03b | 结果数据详情显示 results_db_link | results_db_link 字段显示，值与数据库一致 | | |
| DET-02 | 原始数据文件列表显示 file_property | 每行显示 file_property = "转录组-小鼠-Liver" | | |
| DET-04 | 结果数据文件列表显示 file_property | 每行显示 file_property = "Marker-TEST_RAW_001" | | |
| DET-05a | 结果数据文件列表显示关联项目 | 每行显示 file_project_ref_id = "TEST_RAW_001" | | |

## 5.4 问题 D：筛选功能测试

| 用例 | 测试内容 | 预期结果 | 实际结果 | 判定 |
|------|----------|----------|----------|------|
| FIL-01 | 原始数据筛选框有选项 | raw_type, raw_species, raw_tissue 下拉有选项 | | |
| FIL-02 | 原始数据筛选功能 | 选择 raw_type="mRNAseq" 后只显示匹配项目 | | |
| FIL-03 | 结果数据筛选框有选项 | results_type 下拉有选项 | | |
| FIL-04 | 结果数据筛选功能 | 选择 results_type="Marker" 后只显示匹配项目 | | |

## 5.5 问题 E/F/G：file_property 测试

| 用例 | 测试内容 | 预期结果 | 实际结果 | 判定 |
|------|----------|----------|----------|------|
| RAW-01 | 原始数据 file_property 格式 | "转录组-小鼠-Liver"，不是 "mRseq-Ms-Liv" | | |
| RAW-02 | 多个文件 file_property | 同一项目文件 file_property 相同 | | |
| RES-04 | 结果数据 file_property 格式 | "Marker-TEST_RAW_001"（按字母排序关联项目） | | |
| API-01 | get_files_by_project 返回 file_property | 返回数据包含 file_property 字段 | | |
| API-02 | get_raw_project_by_id 返回 file_property | files 数组每个对象包含 file_property | | |
| FM-01 | files.html 显示 file_property | 文件列表显示 file_property 列 | | |
| FM-02 | files.html 显示 file_project_ref_id | 结果文件列表显示关联项目列 | | |

## 5.6 问题 H：重复文件检测测试

| 用例 | 测试内容 | 预期结果 | 实际结果 | 判定 |
|------|----------|----------|----------|------|
| DUP-01 | 相同项目相同文件名 | 返回 is_duplicate=true，不创建文件 | | |
| DUP-02 | 不同项目相同文件名 | 返回 success=true，创建文件 | | |
| DUP-03 | 批量导入含重复 | 返回 is_duplicate=true，不导入任何文件 | | |
| DUP-04 | 修改元数据后导入同名文件 | 返回 success=true，创建新文件 | | |

## 5.7 文件夹路径验证（必做）

| 用例 | 测试内容 | 预期结果 | 实际结果 | 判定 |
|------|----------|----------|----------|------|
| FOLD-01 | 无 UNK 文件夹 | find /bio -name "*UNK*" 返回空 | | |
| FOLD-02 | 无空文件夹 | find /bio -empty 返回空 | | |
| FOLD-03 | 无重复文件夹 | 每个项目ID只出现一次 | | |
| FOLD-04 | 路径使用缩写 | mRseq → 转录组，Ms → 小鼠 | | |

---

# 六、验证命令速查

## 6.1 验证 file_property 格式
```bash
docker exec biodata-manager python3 -c "
from database_mysql import DatabaseManager
db = DatabaseManager()
result = db.query('SELECT file_name, file_property FROM file_record WHERE file_project_id = %s', ('TEST_xxx',))
for row in result:
    print(f'{row[0]}: {row[1]}')
"
```

## 6.2 验证 file_project_ref_id
```bash
docker exec biodata-manager python3 -c "
from database_mysql import DatabaseManager
db = DatabaseManager()
result = db.query('SELECT file_name, file_project_ref_id FROM file_record WHERE file_project_id LIKE %s', ('TEST_RES_%',))
for row in result:
    print(f'{row[0]}: {row[1]}')
"
```

## 6.3 验证详情字段
```bash
docker exec biodata-manager python3 -c "
from database_mysql import DatabaseManager
db = DatabaseManager()
raw = db.query('SELECT raw_title, raw_type, raw_species, raw_tissue, raw_db_link FROM raw_project WHERE project_id = %s', ('TEST_RAW_001',))[0]
print(f'raw_title: {raw[0]}')
print(f'raw_type: {raw[1]}')
print(f'raw_species: {raw[2]}')
print(f'raw_tissue: {raw[3]}')
print(f'raw_db_link: {raw[4]}')
"
```

## 6.4 文件夹关键检查（必做）
```bash
docker exec biodata-manager bash -c '
echo "=== 关键检查 ===" && \
echo "[UNK文件夹]" && (find /bio -type d -name "*UNK*" || echo "  ✓ 无") && \
echo "[空文件夹]" && (find /bio -empty -type d || echo "  ✓ 无") && \
echo "[重复项目]" && (find /bio -mindepth 4 -maxdepth 4 -type d -exec basename {} \; | sort | uniq -c | awk '"'"'$1>1'"'"' || echo "  ✓ 无")
'
```

---

# 七、循环测试流程

## 7.1 循环规则

```
循环次数要求：最少 5 轮
终止条件：连续 3 轮自检通过
自检方式：AI 自己问自己"测试计划所提及的问题是否都解决了？"
```

## 7.2 单轮流程

```
┌─────────────────────────────────────────────────────────┐
│  第 N 轮                                                 │
├─────────────────────────────────────────────────────────┤
│  1. 执行内测 → 2. 发现问题 → 3. 修订代码 → 4. 重新内测   │
│                       ↓                                  │
│              5. 自检（核对清单）                         │
│                       ↓                                  │
│              6. AI 自问："问题 A~H 是否都解决了？        │
│                       ↓                                  │
│              7. 自检通过？                               │
│               /        \                                 │
│             是          否                               │
│             ↓           ↓                                │
│       记录通过       记录失败，继续下一轮                 │
│             ↓           ↓                                │
│      连续通过计数+1   连续通过计数归零                   │
│             ↓           ↓                                │
│      检查是否满足终止条件？                              │
│   （最少5轮 + 连续3轮通过）                              │
│               ↓                                          │
│          满足则结束                                      │
│          不满足则继续下一轮                              │
└─────────────────────────────────────────────────────────┘
```

## 7.3 循环计数器

| 轮次 | 内测结果 | 自检通过 | 连续通过计数 | 备注 |
|------|----------|----------|--------------|------|
| 1 | | | 0 | |
| 2 | | | | |
| 3 | | | | |
| 4 | | | | |
| 5 | | | | |
| ... | | | | |
| N | | | | |

**终止条件**：连续 3 轮"自检通过=是"且已完成至少 5 轮

## 7.4 自检清单（每轮结束后执行）

> ⚠️ **自检通过标准：所有检查项必须全部通过**

| 检查项 | 验证方法 | 通过 |
|--------|----------|------|
| ☐ 所有内测用例通过 | 核对用例判定列，无 ❌ | |
| ☐ 无 UNK 文件夹 | find /bio -name "*UNK*" | |
| ☐ 无空文件夹 | find /bio -empty | |
| ☐ 无重复文件夹 | 项目ID无重复 | |
| ☐ file_project_ref_id 正确 | 查询数据库验证 | |
| ☐ file_property 格式正确 | 查询数据库验证 | |
| ☐ 详情弹窗字段完整 | 人工检查或截图对比 | |
| ☐ 筛选功能正常 | 人工测试 | |

## 7.5 AI 自检话术（每轮自检时）

> **自问**："测试计划所提及的问题（A~H）是否都解决了？"

**自检逻辑**：
```
IF 所有检查项都通过 AND 所有用例判定都通过 THEN
    自检通过 = 是
    自问："问题 A~H 是否都解决了？" → 回答："是"
ELSE
    自检通过 = 否
    自问："问题 A~H 是否都解决了？" → 回答："否，还有以下问题：..."
    记录问题，继续下一轮
ENDIF
```

## 7.6 循环终止条件

```
必须同时满足：
  1. 已完成至少 5 轮
  2. 连续 3 轮自检全部通过
  3. AI 自问后确认："测试计划所提及的问题 A~H 都已解决"
```

## 7.7 避免无限循环的措施

```
1. 每轮必须记录：内测结果、自检通过/不通过、发现问题列表
2. 连续通过计数：自检通过则 +1，不通过则归零
3. 达到终止条件立即结束，不再继续循环
4. 如果 10 轮仍未满足终止条件，强制报告并请求人工介入
```

---

# 八、执行顺序

| 顺序 | 任务 | 状态 |
|-----|------|------|
| 1 | 数据库：修改 file_record 表结构 | 待执行 |
| 2 | 后端：修改 add_file_record 函数 | 待执行 |
| 3 | 后端：修改 import_download_files 函数 | 待执行 |
| 4 | 后端：修改 get_files_by_project 函数 | 待执行 |
| 5 | 后端：修改 get_raw_project_by_id 函数 | 待执行 |
| 6 | 后端：修改 get_result_project_by_id 函数 | 待执行 |
| 7 | 前端：修改 confirmImport 函数 | 待执行 |
| 8 | 前端：修改 raw_data.html viewDetail 函数 | 待执行 |
| 9 | 前端：修改 results.html viewDetail 函数 | 待执行 |
| 10 | 前端：修改 loadFilterOptions 函数 | 待执行 |
| 11 | 前端：修改 files.html showProjectDetail 函数 | 待执行 |
| 12 | 开始循环测试（第1轮） | 待执行 |
| 13 | 第2轮内测 | 待执行 |
| 14 | 第3轮内测 | 待执行 |
| 15 | 第4轮内测 | 待执行 |
| 16 | 第5轮内测 | 待执行 |
| 17 | 继续循环（若未满足终止条件） | 待执行 |

---

# 九、最终检查清单（执行完毕后勾选）

> ⚠️ **此清单必须在所有测试完成后逐项核对，任何一项未通过都不能结束**

| 检查项 | 验证方法 | 通过 |
|--------|----------|------|
| ☐ file_project_ref_id 字段存在 | DESCRIBE file_record | |
| ☐ confirmImport 使用动态字段 | 检查前端代码，遍历 metadataFields | |
| ☐ 原始数据详情显示 raw_db_link | 打开详情弹窗查看 | |
| ☐ 结果数据详情显示 results_DOI | 打开详情弹窗查看 | |
| ☐ 筛选框有选项 | 点击筛选下拉框 | |
| ☐ file_property 格式正确 | 查询 file_property = "转录组-小鼠-Liver" | |
| ☐ file_project_ref_id 正确 | 查询结果文件，关联项目ID正确 | |
| ☐ 同名文件检测 | 重复导入，返回 is_duplicate=true | |
| ☐ 无 UNK 文件夹 | find /bio -name "*UNK*" | |
| ☐ 无空文件夹 | find /bio -empty | |
| ☐ 无重复文件夹 | 每个项目ID只出现一次 | |
| ☐ 数据库值 = 页面显示值 | 对比数据库与页面 | |

---

# 十、判定标准

| 标准 | 说明 |
|------|------|
| ✅ 通过 | 实际结果与预期完全一致 |
| ❌ 不通过 | 实际结果与预期不一致，必须修复后重新测试 |
| ⚠️ 部分通过 | 部分通过，需要补充测试 |

**连续 3 轮自检通过 + 最少 5 轮 = 才能结束本轮修订**

---

## 修订历史

| 版本 | 日期 | 内容 |
|-----|------|------|
| v9 | 2026-01-23 | 添加全局问题清单速查、验证原则、循环测试流程（AI自检）、最终检查清单 |
