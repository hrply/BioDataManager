# 文件管理模块设计修订描述

本文档描述文件管理模块的完整设计方案，包括管理页面、导入页面、项目详情模态框、数据操作逻辑、文件操作逻辑、API设计以及 file_record 表字段规范更新。

---

## 目录

- [7.3 文件管理 - 管理页面](#73-文件管理---管理页面)
  - [7.3.1 筛选条件模块](#731-筛选条件模块管理标签页内)
  - [7.3.2 已导入项目表格模块](#732-已导入项目表格模块管理标签页内)
  - [7.3.3 列表排序功能](#733-列表排序功能)
- [7.5 项目详情模态框](#75-项目详情模态框)
  - [7.5.1 文件列表排序功能](#751-文件列表排序功能)
- [7.6 文件操作功能](#76-文件操作功能)
- [7.7 API 接口设计](#77-api-接口设计)
- [7.8 file_record 表字段规范更新](#78-filerecord-表字段规范更新)
- [7.9 后台实现逻辑](#79-后台实现逻辑)

---

## 7.3 文件管理 - 管理页面

### 功能概述

文件管理-管理页面提供文件项目的筛选、查看和文件操作功能，通过"管理"和"导入"两个标签页切换不同的功能模块。

### 页面布局

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  文件管理                                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│  [管理] [导入]                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 筛选条件                                                             │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │ [项目类型 ▼] [项目编号      ]  [查询]                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 已导入项目                                            (共 X 个项目)  │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │ # │ 项目编号     │ 项目名称 │ 项目类型 │ 创建时间 │ 文件数量 │ 操作 │   │
│  ├────┼─────────────┼──────────┼──────────┼──────────┼──────────┼──────┤   │
│  │ 1 │ RAW_XXX     │ 项目A   │ 原始数据 │ 2026-01  │ 10      │[详情]│   │
│  │ 2 │ RES_YYY     │ 项目B   │ 结果数据 │ 2026-01  │ 5       │[详情]│   │
│  └────┴─────────────┴──────────┴──────────┴──────────┴──────────┴──────┘   │
│                                                                             │
│  共 X 条记录  [< 1 2 3 >]  每页 [10 ▼] 条                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 标签页结构

| 标签 | 功能 |
|------|------|
| 管理 | 筛选已导入项目、查看项目详情、管理文件 |
| 导入 | 扫描下载目录、导入新文件 |

### 7.3.1 筛选条件模块（管理标签页内）

#### 功能描述

根据用户选择的项目类型和输入的项目编号，向后台发送请求获取符合条件的项目信息。

#### 前端交互

```
┌─────────────────────────────────────────────────────────────────┐
│  筛选条件                                                       │
├─────────────────────────────────────────────────────────────────┤
│  [项目类型 ▼] [项目编号      ]  [查询]                            │
├─────────────────────────────────────────────────────────────────┤
│ 项目类型选项:                                                    │
│   - 全部（默认）                                                  │
│   - 原始数据 (raw)                                               │
│   - 结果数据 (result)                                            │
│                                                                 │
│ 项目编号输入:                                                    │
│   - 支持逗号分隔輸入多個項目編號（中英文逗號都可）                  │
│   - 例如: RAW_XXX, RES_YYY, RAW_ZZZ                              │
│   - 留空則表示不限制項目編號                                      │
└─────────────────────────────────────────────────────────────────┘
```

#### 篩選邏輯

**查詢條件組合規則：**
```
最終查詢 = 項目類型條件 AND (項目編號1 OR 項目編號2 OR ...)

示例:
- 項目類型=raw, 項目編號=RAW_A,RAW_B
  → file_project_type='raw' AND (file_project_id='RAW_A' OR file_project_id='RAW_B')

- 項目類型=留空, 項目編號=留空
  → 返回所有項目 (無篩選條件)

- 項目類型=raw, 項目編號=留空
  → file_project_type='raw'

- 項目類型=留空, 項目編號=RAW_A,RAW_B
  → (file_project_id='RAW_A' OR file_project_id='RAW_B')
```

| 項目類型 | 項目編號輸入 | 篩選行為 |
|---------|-------------|---------|
| 全部 | 留空 | 顯示所有項目 |
| 原始數據 | 留空 | 顯示所有 raw 類型項目 |
| 結果數據 | 留空 | 顯示所有 result 類型項目 |
| 全部 | RAW_A,RAW_B | 顯示編號為 RAW_A 或 RAW_B 的所有項目 |
| 原始數據 | RAW_A,RAW_B | 顯示 raw 類型且編號為 RAW_A 或 RAW_B 的項目 |
| 結果數據 | RAW_A,RAW_B | 顯示 result 類型且編號為 RAW_A 或 RAW_B 的項目 |

#### 前端代碼示例

```javascript
// 解析項目編號輸入（支持中英文逗號）
function parseProjectIds(input) {
    if (!input.trim()) return [];
    // 支持中文逗號和英文逗號
    return input.split(/[,，]/).map(id => id.trim()).filter(id => id);
}

// 應用篩選
function applyFilter() {
    const projectType = $('#filter-project-type').val();
    const projectIdInput = $('#filter-project-id').val();
    const projectIds = parseProjectIds(projectIdInput);
    
    apiGet('/api/files/imported-projects', {
        file_project_type: projectType || undefined,
        file_project_ids: projectIds.length > 0 ? projectIds.join(',') : undefined
    }).then(function(res) {
        if (res.success) {
            renderProjectList(res.data);
        }
    });
}

// 重置篩選
function resetFilter() {
    $('#filter-project-type').val('');
    $('#filter-project-id').val('');
    applyFilter(); // 加載全部項目
}
```

### 7.3.2 已導入項目表格模塊（管理標籤頁內）

#### 表格字段說明

| 字段 | 數據庫來源 | 說明 |
|------|-----------|------|
| # | 序號 | 自動編號（不支持排序） |
| 項目編號 | file_record.file_project_id | 所属项目编号（支持排序） |
| 項目名稱 | raw_project.raw_title / result_project.results_title | 項目標題（支持排序） |
| 項目類型 | file_record.file_project_type | raw / result（支持排序） |
| 創建時間 | raw_project.created_at / result_project.created_at | 項目創建時間（支持排序） |
| 文件數量 | raw_project.raw_file_count / result_project.results_file_count | 關聯文件數量（支持排序） |
| 操作 | - | 查看詳情按鈕（不支持排序）

#### 數據獲取流程

```
用戶選擇篩選條件
        │
        ▼
前端發送請求: GET /api/files/imported-projects
    參數: file_project_type?, file_project_ids?
        │
        ▼
後台查詢 file_record 表獲取符合條件的 file_project_id 和 file_project_type
        │
        ▼
根據 file_project_type 關聯查詢 raw_project 或 result_project
        │
        ▼
返回: [{ raw_id, raw_title, raw_type, created_at, raw_file_count }, ...]
        │
        ▼
前端渲染表格
```

#### 前端代碼示例

```javascript
// 加載已導入項目列表
function loadImportedProjects() {
    apiGet('/api/files/imported-projects').then(function(res) {
        if (res.success && res.data) {
            renderProjectList(res.data);
        }
    });
}

// 渲染項目列表
function renderProjectList(projects) {
    const tbody = $('#project-list');
    $('#project-count').text(projects.length + ' 個');
    
    if (projects.length === 0) {
        tbody.html(`
            <tr>
                <td colspan="7" class="text-center py-4 text-muted">
                    <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                    暫無符合條件的項目
                </td>
            </tr>
        `);
        return;
    }
    
    let html = '';
    projects.forEach(function(p, index) {
        const typeLabel = p.project_type === 'raw' ? '原始數據' : '結果數據';
        html += `
            <tr>
                <td>${index + 1}</td>
                <td><code>${p.project_id}</code></td>
                <td>${p.title || '-'}</td>
                <td><span class="badge bg-info">${typeLabel}</span></td>
                <td>${p.created_at || '-'}</td>
                <td>${p.file_count || 0}</td>
                <td>
                    <button class="btn btn-outline-primary btn-sm" 
                            onclick="showProjectDetail('${p.project_id}', '${p.project_type}')">
                        <i class="bi bi-eye"></i> 查看
                    </button>
                </td>
            </tr>
        `;
    });
    tbody.html(html);
}
```

### 7.3.3 列表排序功能

#### 功能描述

已導入項目表格支持點擊列標題進行升序/降序排序。用戶可以點擊任意支持排序的列標題，切換排序順序。

#### 排序規則

- **默認排序**: 按項目編號（project_id）升序排列
- **切換邏輯**: 點擊同一列時，在 升序 → 降序 → 恢復默認排序 之間循環
- **多列排序**: 僅支持單列排序，點擊新列時會清除之前的排序
- **不支持排序**: 序號列（#）和操作列（操作）不支持排序

#### 排序狀態指示

| 狀態 | 圖標 | 說明 |
|------|------|------|
| 未排序 | 無 | 點擊後未進行排序 |
| 升序 | ↑ 或 bi-arrow-up | 按當前列升序排列 |
| 降序 | ↓ 或 bi-arrow-down | 按當前列降序排列 |

#### 支持排序的列

| 列名 | 排序字段 | 排序類型 |
|------|---------|---------|
| 項目編號 | project_id | 字符串 |
| 項目名稱 | title | 字符串 |
| 項目類型 | project_type | 字符串 |
| 創建時間 | created_at | 日期時間 |
| 文件數量 | file_count | 數字 |

#### 前端交互

```
┌─────────────────────────────────────────────────────────────────────┐
│ 已導入項目                                            (共 X 個項目)  │
├─────────────────────────────────────────────────────────────────────┤
│ # │ 項目編號 ↑   │ 項目名稱    │ 項目類型 │ 創建時間 │ 文件數量 │ 操作 │
│   │ (點擊切換)   │ (點擊切換)  │          │          │          │      │
├────┼─────────────┼─────────────┼──────────┼──────────┼──────────┼──────┤
│ 1 │ RAW_AAA     │ 項目A      │ 原始數據 │ 2026-01  │ 10      │[詳情]│
│ 2 │ RAW_BBB     │ 項目B      │ 原始數據 │ 2026-01  │ 5       │[詳情]│
└────┴─────────────┴─────────────┴──────────┴──────────┴──────────┴──────┘

點擊"項目編號"列標題:
  第一次點擊 → 升序排序 (RAW_AAA → RAW_BBB → RAW_CCC)
  第二次點擊 → 降序排序 (RAW_CCC → RAW_BBB → RAW_AAA)
  第三次點擊 → 恢復默認排序
```

#### 前端代碼示例

```javascript
// 排序狀態管理
let sortState = {
    column: 'project_id',  // 當前排序列
    direction: 'asc'       // 排序方向: 'asc' | 'desc'
};

// 初始化排序
function initSortableHeaders() {
    $('#project-list thead th[data-sortable="true"]').click(function() {
        const column = $(this).data('sort-column');
        toggleSort(column);
    });
    // 初始化排序圖標
    updateSortIcons();
}

// 切換排序
function toggleSort(column) {
    if (sortState.column === column) {
        // 切換排序方向
        if (sortState.direction === 'asc') {
            sortState.direction = 'desc';
        } else {
            // 恢復默認排序
            sortState.column = 'project_id';
            sortState.direction = 'asc';
        }
    } else {
        // 新列，設置為升序
        sortState.column = column;
        sortState.direction = 'asc';
    }
    
    // 更新排序圖標
    updateSortIcons();
    
    // 重新渲染列表
    loadAndRenderProjects();
}

// 更新排序圖標
function updateSortIcons() {
    $('#project-list thead th').each(function() {
        const column = $(this).data('sort-column');
        const icon = $(this).find('.sort-icon');
        
        icon.removeClass('bi-arrow-up bi-arrow-down bi-dash');
        
        if (column === sortState.column) {
            if (sortState.direction === 'asc') {
                icon.addClass('bi-arrow-up');
            } else {
                icon.addClass('bi-arrow-down');
            }
        } else {
            icon.addClass('bi-dash');  // 未排序狀態
        }
    });
}

// 排序函數
function sortProjects(projects) {
    return projects.sort((a, b) => {
        let valueA = a[sortState.column];
        let valueB = b[sortState.column];
        
        // 處理空值
        if (valueA === null || valueA === undefined) valueA = '';
        if (valueB === null || valueB === undefined) valueB = '';
        
        // 數字排序
        if (typeof valueA === 'number' && typeof valueB === 'number') {
            return sortState.direction === 'asc' ? valueA - valueB : valueB - valueA;
        }
        
        // 日期排序
        if (sortState.column === 'created_at') {
            const dateA = new Date(valueA);
            const dateB = new Date(valueB);
            return sortState.direction === 'asc' 
                ? dateA.getTime() - dateB.getTime() 
                : dateB.getTime() - dateA.getTime();
        }
        
        // 字符串排序
        const strA = String(valueA).toLowerCase();
        const strB = String(valueB).toLowerCase();
        
        if (strA < strB) return sortState.direction === 'asc' ? -1 : 1;
        if (strA > strB) return sortState.direction === 'asc' ? 1 : -1;
        return 0;
    });
}
```

#### HTML 表格頭部示例

```html
<table class="table table-hover">
    <thead class="table-light">
        <tr>
            <th data-sortable="false">#</th>
            <th data-sortable="true" data-sort-column="project_id">
                項目編號 <i class="bi bi-dash sort-icon"></i>
            </th>
            <th data-sortable="true" data-sort-column="title">
                項目名稱 <i class="bi bi-dash sort-icon"></i>
            </th>
            <th data-sortable="true" data-sort-column="project_type">
                項目類型 <i class="bi bi-dash sort-icon"></i>
            </th>
            <th data-sortable="true" data-sort-column="created_at">
                創建時間 <i class="bi bi-dash sort-icon"></i>
            </th>
            <th data-sortable="true" data-sort-column="file_count">
                文件數量 <i class="bi bi-dash sort-icon"></i>
            </th>
            <th data-sortable="false">操作</th>
        </tr>
    </thead>
    <tbody id="project-list">
        <!-- 項目列表內容 -->
    </tbody>
</table>
```

#### CSS 樣式

```css
/* 排序圖標樣式 */
.sort-icon {
    margin-left: 4px;
    opacity: 0.5;
}

/* 可排序列的鼠標樣式 */
thead th[data-sortable="true"] {
    cursor: pointer;
    user-select: none;
}

thead th[data-sortable="true"]:hover {
    background-color: #e9ecef;
}

/* 排序圖標激活狀態 */
.sort-icon.bi-arrow-up,
.sort-icon.bi-arrow-down {
    opacity: 1;
    color: #0d6efd;
}
```

---

## 7.5 項目詳情模態框

### 功能描述

點擊"查看詳情"按鈕後彈出模態框，展示該項目的文件信息。

### 模態框布局

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  項目詳情 - RAW_XXX                                             [關閉] [X]  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  項目名稱: 測試項目                                      創建時間: 2026-01-01│
│  項目類型: 原始數據                                    文件數量: 10         │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ ☐ │ 文件名              │ 文件大小 │ 文件類型 │ 導入時間            │   │
│  ├────┼────────────────────┼──────────┼──────────┼─────────────────────┤   │
│  │ ☑ │ sample1.fastq.gz   │ 1.5 GB   │ FASTQ    │ 2026-01-01 10:30:00 │   │
│  │ ☑ │ sample2.fastq.gz   │ 1.4 GB   │ FASTQ    │ 2026-01-01 10:32:00 │   │
│  │ ☐ │ sample3.fastq.gz   │ 1.3 GB   │ FASTQ    │ 2026-01-01 10:34:00 │   │
│  └────┴────────────────────┴──────────┴──────────┴─────────────────────┘   │
│                                                                             │
│  [刪除] [下載]                                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 模態框字段說明

| 字段 | 數據庫來源 | COMMENT 描述 | 說明 | 支持排序 |
|------|-----------|-------------|------|---------|
| ☐ | - | - | 複選框（用於選擇要操作的文件） | 否 |
| 文件名 | file_record.file_name | 文件名 | 完整文件名（含擴展名） | 是 |
| 文件大小 | file_record.file_size | 文件大小(字節) | 文件大小，字節為單位 | 是 |
| 文件類型 | file_record.file_type | 文件類型擴展名 | 文件類型擴展名（小寫） | 是 |
| 導入時間 | file_record.imported_at | 導入時間 | 記錄導入時間 | 是 |

### 項目基本信息區域

| 字段 | 數據庫來源 | 說明 |
|------|-----------|------|
| 項目名稱 | raw_project.raw_title / result_project.results_title | 項目標題 |
| 項目類型 | file_record.file_project_type | raw / result |
| 創建時間 | raw_project.created_at / result_project.created_at | 項目創建時間 |
| 文件數量 | COUNT(file_record.id) | 關聯文件數量 |

### 空項目狀態

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  項目詳情 - RAW_XXX                                             [關閉] [X]  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  項目名稱: 測試項目                                      創建時間: 2026-01-01│
│  項目類型: 原始數據                                    文件數量: 0         │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │              該項目暫無文件                                          │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  [刪除] [下載]  (按鈕禁用狀態)                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

- 顯示文字："該項目暫無文件"
- 禁用"刪除"和"下載"按鈕

### 7.5.1 文件列表排序功能

#### 功能描述

項目詳情模態框內的文件列表支持點擊列標題進行升序/降序排序。用戶可以點擊任意支持排序的列標題，切換排序順序。

#### 排序規則

- **默認排序**: 按導入時間（imported_at）降序排列（最新的文件在前面）
- **切換邏輯**: 點擊同一列時，在 升序 → 降序 → 恢復默認排序 之間循環
- **多列排序**: 僅支持單列排序，點擊新列時會清除之前的排序
- **不支持排序**: 複選框列（☐）不支持排序

#### 排序狀態指示

| 狀態 | 圖標 | 說明 |
|------|------|------|
| 未排序 | - | 點擊後未進行排序 |
| 升序 | ↑️ 或 bi-arrow-up | 按當前列升序排列 |
| 降序 | ↓ 或 bi-arrow-down | 按當前列降序排列 |

#### 支持排序的列

| 列名 | 排序字段 | 排序類型 |
|------|---------|---------|
| 文件名 | file_name | 字符串 |
| 文件大小 | file_size | 數字 |
| 文件類型 | file_type | 字符串 |
| 導入時間 | imported_at | 日期時間 |

#### 前端交互

```
┌─────────────────────────────────────────────────────────────────────┐
│ 項目詳情 - RAW_XXX                                     [關閉] [X]  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│ 項目名稱: 測試項目                              創建時間: 2026-01-01│
│ 項目類型: 原始數據                              文件數量: 10         │
│                                                                     │
│ ┌───────────────────────────────────────────────────────────────┐  │
│ │ ☐ │ 文件名 ↑      │ 文件大小 │ 文件類型 │ 導入時間            │  │
│ │   │ (點擊切換)    │ (點擊切換)│          │ (點擊切換)          │  │
│ ├────┼───────────────┼──────────┼──────────┼─────────────────────┤  │
│ │ ☑ │ sample1.fastq │ 1.5 GB   │ FASTQ    │ 2026-01-01 10:30:00 │  │
│ │ ☑ │ sample2.fastq │ 1.4 GB   │ FASTQ    │ 2026-01-01 10:32:00 │  │
│ │ ☐ │ sample3.fastq │ 1.3 GB   │ FASTQ    │ 2026-01-01 10:34:00 │  │
│ └────┴───────────────┴──────────┴──────────┴─────────────────────┘  │
│                                                                     │
│ [刪除] [下載]                                                         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

點擊"文件名"列標題:
  第一次點擊 → 升序排序 (sample1 → sample2 → sample3)
  第二次點擊 → 降序排序 (sample3 → sample2 → sample1)
  第三次點擊 → 恢復默認排序

點擊"文件大小"列標題:
  第一次點擊 → 升序排序 (小的在前)
  第二次點擊 → 降序排序 (大的在前)
  第三次點擊 → 恢復默認排序
```

#### 前端代碼示例

```javascript
// 項目詳情模態框排序狀態管理
let detailSortState = {
    column: 'imported_at',  // 當前排序列
    direction: 'desc'       // 排序方向: 'asc' | 'desc'
};

// 初始化詳情模態框排序
function initDetailSortableHeaders() {
    $('#detail-content thead th[data-sortable="true"]').click(function() {
        const column = $(this).data('sort-column');
        toggleDetailSort(column);
    });
    updateDetailSortIcons();
}

// 切換詳情模態框排序
function toggleDetailSort(column) {
    if (detailSortState.column === column) {
        if (detailSortState.direction === 'asc') {
            detailSortState.direction = 'desc';
        } else {
            // 恢復默認排序
            detailSortState.column = 'imported_at';
            detailSortState.direction = 'desc';
        }
    } else {
        detailSortState.column = column;
        detailSortState.direction = 'asc';
    }
    
    updateDetailSortIcons();
    // 重新渲染文件列表
    const projectId = $('#detail-modal').data('project-id');
    const projectType = $('#detail-modal').data('project-type');
    showProjectDetail(projectId, projectType);
}

// 更新詳情模態框排序圖標
function updateDetailSortIcons() {
    $('#detail-content thead th').each(function() {
        const column = $(this).data('sort-column');
        const icon = $(this).find('.sort-icon');
        
        icon.removeClass('bi-arrow-up bi-arrow-down bi-dash');
        
        if (column === detailSortState.column) {
            if (detailSortState.direction === 'asc') {
                icon.addClass('bi-arrow-up');
            } else {
                icon.addClass('bi-arrow-down');
            }
        } else {
            icon.addClass('bi-dash');
        }
    });
}

// 詳情模態框排序函數
function sortFiles(files) {
    return files.sort((a, b) => {
        let valueA = a[detailSortState.column];
        let valueB = b[detailSortState.column];
        
        // 處理空值
        if (valueA === null || valueA === undefined) valueA = '';
        if (valueB === null || valueB === undefined) valueB = '';
        
        // 文件大小排序（數字）
        if (detailSortState.column === 'file_size') {
            return detailSortState.direction === 'asc' 
                ? valueA - valueB 
                : valueB - valueA;
        }
        
        // 日期排序
        if (detailSortState.column === 'imported_at') {
            const dateA = new Date(valueA);
            const dateB = new Date(valueB);
            return detailSortState.direction === 'asc' 
                ? dateA.getTime() - dateB.getTime() 
                : dateB.getTime() - dateA.getTime();
        }
        
        // 字符串排序
        const strA = String(valueA).toLowerCase();
        const strB = String(valueB).toLowerCase();
        
        if (strA < strB) return detailSortState.direction === 'asc' ? -1 : 1;
        if (strA > strB) return detailSortState.direction === 'asc' ? 1 : -1;
        return 0;
    });
}

// 渲染詳情模態框（更新版本，包含排序）
function renderDetailModal(projectId, projectType, files) {
    const modal = $('#detail-modal');
    const content = $('#detail-content');
    
    // 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
        if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
    }
    
    // 排序文件列表
    const sortedFiles = sortFiles([...files]);
    
    // 生成表格內容
    let tableHtml = '';
    if (sortedFiles.length === 0) {
        tableHtml = `
            <tr>
                <td colspan="5" class="text-center py-4 text-muted">
                    該項目暫無文件
                </td>
            </tr>
        `;
        $('#detail-modal .btn-danger').prop('disabled', true);
        $('#detail-modal .btn-primary').prop('disabled', true);
    } else {
        sortedFiles.forEach(function(f) {
            tableHtml += `
                <tr>
                    <td><input type="checkbox" class="file-checkbox" value="${f.id}"></td>
                    <td>${f.file_name}</td>
                    <td>${formatFileSize(f.file_size)}</td>
                    <td>${f.file_type}</td>
                    <td>${f.imported_at}</td>
                </tr>
            `;
        });
        $('#detail-modal .btn-danger').prop('disabled', false);
        $('#detail-modal .btn-primary').prop('disabled', false);
    }
    
    const typeLabel = projectType === 'raw' ? '原始數據' : '結果數據';
    
    content.html(`
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>項目名稱:</strong> ${files[0]?.project_title || '-'}
            </div>
            <div class="col-md-6">
                <strong>創建時間:</strong> ${files[0]?.created_at || '-'}
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>項目類型:</strong> ${typeLabel}
            </div>
            <div class="col-md-6">
                <strong>文件數量:</strong> ${sortedFiles.length}
            </div>
        </div>
        <hr>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th data-sortable="false">
                            <input type="checkbox" id="select-all-files">
                        </th>
                        <th data-sortable="true" data-sort-column="file_name">
                            文件名 <i class="bi bi-dash sort-icon"></i>
                        </th>
                        <th data-sortable="true" data-sort-column="file_size">
                            文件大小 <i class="bi bi-dash sort-icon"></i>
                        </th>
                        <th data-sortable="true" data-sort-column="file_type">
                            文件類型 <i class="bi bi-dash sort-icon"></i>
                        </th>
                        <th data-sortable="true" data-sort-column="imported_at">
                            導入時間 <i class="bi bi-dash sort-icon"></i>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    ${tableHtml}
                </tbody>
            </table>
        </div>
    `);
    
    // 綁定排序事件
    initDetailSortableHeaders();
    
    // 全選/取消全選
    $('#select-all-files').change(function() {
        $('.file-checkbox').prop('checked', this.checked);
    });
    
    // 保存項目信息
    modal.data('project-id', projectId);
    modal.data('project-type', projectType);
    
    modal.modal('show');
}
```

#### HTML 文件列表表頭示例

```html
<table class="table table-hover">
    <thead class="table-light">
        <tr>
            <th data-sortable="false" style="width: 40px;">
                <input type="checkbox" id="select-all-files">
            </th>
            <th data-sortable="true" data-sort-column="file_name">
                文件名 <i class="bi bi-dash sort-icon"></i>
            </th>
            <th data-sortable="true" data-sort-column="file_size">
                文件大小 <i class="bi bi-dash sort-icon"></i>
            </th>
            <th data-sortable="true" data-sort-column="file_type">
                文件類型 <i class="bi bi-dash sort-icon"></i>
            </th>
            <th data-sortable="true" data-sort-column="imported_at">
                導入時間 <i class="bi bi-dash sort-icon"></i>
            </th>
        </tr>
    </thead>
    <tbody id="file-list-body">
        <!-- 文件列表內容 -->
    </tbody>
</table>
```

#### 排序行為說明

| 用戶操作 | 系統響應 |
|---------|---------|
| 點擊"文件名"列標題 | 按文件名升序排列，再次點擊切換為降序 |
| 點擊"文件大小"列標題 | 按文件大小升序排列（小文件在前），再次點擊切換為降序 |
| 點擊"導入時間"列標題 | 按導入時間降序排列（最新文件在前），這是默認排序 |
| 點擊不同列 | 切換到新列的升序排序，原有排序狀態被清除 |
| 第三次點擊同一列 | 恢復到該列的默認排序狀態 |

#### 特殊排序邏輯

1. **文件大小排序**:
   - 按字節數值進行數字排序
   - 升序：小文件在前，大文件在後
   - 降序：大文件在前，小文件在後

2. **導入時間排序**:
   - 默認為降序排列（最新的文件在最前面）
   - 升序：最早的導入文件在前
   - 降序：最新的導入文件在前

3. **空值處理**:
   - 如果某字段為空（null/undefined/空字符串），排序時視為最小值
   - 升序時空值排在前面
   - 降序時空值排在後面

### 前端代碼示例

```javascript
// 顯示項目詳情
function showProjectDetail(projectId, projectType) {
    apiGet('/api/files', { project_id: projectId }).then(function(res) {
        if (res.success) {
            renderDetailModal(projectId, projectType, res.files || []);
        }
    });
}

// 渲染詳情模態框
function renderDetailModal(projectId, projectType, files) {
    const modal = $('#detail-modal');
    const content = $('#detail-content');
    
    // 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
        if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
    }
    
    // 生成表格內容
    let tableHtml = '';
    if (files.length === 0) {
        tableHtml = `
            <tr>
                <td colspan="5" class="text-center py-4 text-muted">
                    該項目暫無文件
                </td>
            </tr>
        `;
        // 禁用按鈕
        $('#detail-modal .btn-danger').prop('disabled', true);
        $('#detail-modal .btn-primary').prop('disabled', true);
    } else {
        files.forEach(function(f) {
            tableHtml += `
                <tr>
                    <td><input type="checkbox" class="file-checkbox" value="${f.id}"></td>
                    <td>${f.file_name}</td>
                    <td>${formatFileSize(f.file_size)}</td>
                    <td>${f.file_type}</td>
                    <td>${f.imported_at}</td>
                </tr>
            `;
        });
        // 啟用按鈕
        $('#detail-modal .btn-danger').prop('disabled', false);
        $('#detail-modal .btn-primary').prop('disabled', false);
    }
    
    // 項目類型標籤
    const typeLabel = projectType === 'raw' ? '原始數據' : '結果數據';
    
    content.html(`
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>項目名稱:</strong> ${files[0]?.project_title || '-'}
            </div>
            <div class="col-md-6">
                <strong>創建時間:</strong> ${files[0]?.created_at || '-'}
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>項目類型:</strong> ${typeLabel}
            </div>
            <div class="col-md-6">
                <strong>文件數量:</strong> ${files.length}
            </div>
        </div>
        <hr>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th><input type="checkbox" id="select-all-files"></th>
                        <th>文件名</th>
                        <th>文件大小</th>
                        <th>文件類型</th>
                        <th>導入時間</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableHtml}
                </tbody>
            </table>
        </div>
    `);
    
    // 全選/取消全選
    $('#select-all-files').change(function() {
        $('.file-checkbox').prop('checked', this.checked);
    });
    
    // 顯示模態框
    modal.modal('show');
}
```

---

## 7.6 文件操作功能

### 7.6.1 刪除功能

#### 前端交互

```
用戶點擊 [刪除] 按鈕
        │
        ▼
彈出確認對話框
┌─────────────────────────────────────────┐
│  確認刪除                                │
│                                         │
│  請輸入 "我已知曉，確認刪除" 以確認操作:   │
│  _____________________________________  │
│                                         │
│  [取消]                        [確認刪除] │
└─────────────────────────────────────────┘
        │
        ▼
用戶輸入正確文字並點擊確認
        │
        ▼
前端發送請求: DELETE /api/files
    參數: { file_ids: [id1, id2, ...] }
        │
        ▼
後台執行:
    1. 查詢 file_record 獲取 file_path 和 file_name
    2. 拼接完整路徑: /bio/{file_path}/{file_name}
    3. 複製文件到 /bio/recycle/{file_path}/ (維持目錄結構)
    4. 刪除源文件
    5. 刪除 file_record 表中的記錄
        │
        ▼
返回: { success: true, message: "刪除成功" }
        │
        ▼
前端刷新模態框內的文件表格
```

#### 確認對話框示例

```javascript
// 刪除文件
function deleteSelectedFiles() {
    const selectedIds = [];
    $('.file-checkbox:checked').each(function() {
        selectedIds.push(parseInt($(this).val()));
    });
    
    if (selectedIds.length === 0) {
        showToast('請選擇要刪除的文件', 'warning');
        return;
    }
    
    // 顯示確認對話框
    $('#delete-confirm-modal').modal('show');
}

// 執行刪除確認
function confirmDelete() {
    const confirmText = $('#delete-confirm-input').val();
    if (confirmText !== '我已知曉，確認刪除') {
        showToast('請輸入正確的確認文字', 'error');
        return;
    }
    
    const selectedIds = [];
    $('.file-checkbox:checked').each(function() {
        selectedIds.push(parseInt($(this).val()));
    });
    
    apiDelete('/api/files', { file_ids: selectedIds }).then(function(res) {
        if (res.success) {
            showToast('刪除成功', 'success');
            $('#delete-confirm-modal').modal('hide');
            $('#delete-confirm-input').val('');
            // 刷新文件列表
            const projectId = $('#detail-modal').data('project-id');
            showProjectDetail(projectId);
        } else {
            showToast(res.message || '刪除失敗', 'error');
        }
    });
}
```

#### 確認對話框 HTML

```html
<!-- 刪除確認模態框 -->
<div class="modal fade" id="delete-confirm-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>確認刪除
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">確定要刪除選中的文件嗎？此操作不可恢復。</p>
                <p class="mb-2 fw-bold">請輸入 <span class="text-danger">"我已知曉，確認刪除"</span> 以確認操作:</p>
                <input type="text" class="form-control" id="delete-confirm-input" 
                       placeholder="我已知曉，確認刪除">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="bi bi-trash me-1"></i>確認刪除
                </button>
            </div>
        </div>
    </div>
</div>
```

#### 目錄結構維持示例

```
原路徑: /bio/rawdata/mRseq/Hs/Li/RAW_XXX/sample.fastq
目標:  /bio/recycle/rawdata/mRseq/Hs/Li/RAW_XXX/sample.fastq
```

### 7.6.2 下載功能

#### 前端交互

```
用戶選擇文件（勾選複選框）
        │
        ▼
用戶點擊 [下載] 按鈕
        │
        ▼
前端發送請求: POST /api/files/download
    參數: { file_ids: [id1, id2, ...] }
        │
        ▼
後台執行:
    1. 查詢 file_record 獲取 file_path 和 file_name
    2. 拼接完整路徑: /bio/{file_path}/{file_name}
    3. 讀取各個文件內容
    4. 打包為 ZIP 文件 (download.zip)
    5. 返回 ZIP 文件流
        │
        ▼
瀏覽器觸發下載
```

#### 前端代碼示例

```javascript
// 下載選中文件
function downloadSelectedFiles() {
    const selectedIds = [];
    $('.file-checkbox:checked').each(function() {
        selectedIds.push(parseInt($(this).val()));
    });
    
    if (selectedIds.length === 0) {
        showToast('請選擇要下載的文件', 'warning');
        return;
    }
    
    // 創建表單提交
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/api/files/download';
    form.style.display = 'none';
    
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'file_ids';
    input.value = JSON.stringify(selectedIds);
    form.appendChild(input);
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
    
    showToast('開始下載...', 'info');
}
```

#### ZIP 包結構

```
download.zip
├── sample1.fastq
├── sample2.fastq
└── sample3.fastq
```

---

## 7.7 API 接口設計

### 7.7.1 獲取已導入項目列表

```
GET /api/files/imported-projects

說明: 獲取已導入項目的列表，支持按項目類型和項目編號篩選

參數:
- file_project_type: string (可選, raw | result)
- file_project_ids: string (可選, 逗號分隔的項目編號)

請求示例:
GET /api/files/imported-projects
GET /api/files/imported-projects?file_project_type=raw
GET /api/files/imported-projects?file_project_ids=RAW_XXX,RAW_YYY
GET /api/files/imported-projects?file_project_type=raw&file_project_ids=RAW_XXX,RAW_YYY

響應成功 (200):
{
    "success": true,
    "data": [
        {
            "project_id": "RAW_XXX",
            "project_type": "raw",
            "title": "項目名稱",
            "created_at": "2026-01-01 10:00:00",
            "file_count": 10
        },
        {
            "project_id": "RAW_YYY",
            "project_type": "raw",
            "title": "另一個項目",
            "created_at": "2026-01-02 11:00:00",
            "file_count": 5
        }
    ],
    "total": 2
}

響應失敗 (400/500):
{
    "success": false,
    "message": "錯誤信息"
}
```

### 7.7.2 獲取項目文件列表

```
GET /api/files

說明: 獲取指定項目的文件列表

參數:
- project_id: string (必填, 項目編號)

請求示例:
GET /api/files?project_id=RAW_XXX

響應成功 (200):
{
    "success": true,
    "project_id": "RAW_XXX",
    "project_type": "raw",
    "project_title": "項目名稱",
    "created_at": "2026-01-01 10:00:00",
    "files": [
        {
            "id": 1,
            "file_name": "sample1.fastq.gz",
            "file_size": 1612345678,
            "file_type": "fastq.gz",
            "imported_at": "2026-01-01 10:30:00"
        },
        {
            "id": 2,
            "file_name": "sample2.fastq.gz",
            "file_size": 1523456789,
            "file_type": "fastq.gz",
            "imported_at": "2026-01-01 10:32:00"
        }
    ],
    "total": 2
}

響應失敗 (400/500):
{
    "success": false,
    "message": "錯誤信息"
}
```

### 7.7.3 刪除文件

```
DELETE /api/files

說明: 刪除指定的文件記錄，並將源文件移動到回收站

請求體 (Content-Type: application/json):
{
    "file_ids": [1, 2, 3]
}

請求示例:
DELETE /api/files
Content-Type: application/json

{
    "file_ids": [1, 2, 3]
}

響應成功 (200):
{
    "success": true,
    "message": "刪除成功",
    "deleted_count": 3
}

響應失敗 (400/500):
{
    "success": false,
    "message": "錯誤信息"
}
```

### 7.7.4 下載文件

```
POST /api/files/download

說明: 下載指定的文件，支持單文件和多文件打包下載

請求體 (Content-Type: application/json):
{
    "file_ids": [1, 2, 3]
}

請求示例:
POST /api/files/download
Content-Type: application/json

{
    "file_ids": [1, 2, 3]
}

響應成功 (200):
- Content-Type: application/zip
- Content-Disposition: attachment; filename="download.zip"
- Body: ZIP 文件流

響應失敗 (400/500):
{
    "success": false,
    "message": "錯誤信息"
}
```

### 7.7.5 錯誤響應格式

所有 API 的錯誤響應統一格式：

```json
{
    "success": false,
    "message": "錯誤描述信息",
    "code": "ERROR_CODE"  // 可選的錯誤碼
}
```

常見錯誤碼：

| 錯誤碼 | 說明 |
|--------|------|
| INVALID_PARAMS | 參數錯誤 |
| PROJECT_NOT_FOUND | 項目不存在 |
| FILE_NOT_FOUND | 文件不存在 |
| FILE_DELETE_FAILED | 文件刪除失敗 |
| FILE_DOWNLOAD_FAILED | 文件下載失敗 |
| INTERNAL_ERROR | 服務器內部錯誤 |

---

## 7.8 file_record 表字段規範更新

### 字段規範說明

file_record 表用於記錄導入的文件信息，設計上與 abbr_mapping 表配合使用，實現靈活的目錄結構管理。

### file_path 字段說明

| 屬性 | 值 |
|------|-----|
| 字段名 | file_path |
| 存儲內容 | 相對於 /bio 的路徑，不包含文件名 |
| 數據類型 | VARCHAR(500) |
| 示例 | `rawdata/Rs/Hu/Rt` |
| 完整路徑計算 | `/bio/{file_path}/{file_name}` |

### file_name 字段說明

| 屬性 | 值 |
|------|-----|
| 字段名 | file_name |
| 存儲內容 | 完整文件名，包含擴展名 |
| 數據類型 | VARCHAR(500) |
| 示例 | `GSE33048_tumor.fastq.tar.gz` |

### file_type 字段說明

| 屬性 | 值 |
|------|-----|
| 字段名 | file_type |
| 存儲內容 | 文件擴展名（小寫） |
| 數據類型 | VARCHAR(50) |
| 示例 | `tar.gz`, `fastq`, `csv` |

### 存儲示例

| 完整路徑 | file_path | file_name | file_type |
|---------|-----------|-----------|-----------|
| /bio/rawdata/Rs/Hu/Rt/GSE33048_tumor.fastq.tar.gz | rawdata/Rs/Hu/Rt | GSE33048_tumor.fastq.tar.gz | tar.gz |
| /bio/rawdata/mRseq/Hs/Li/RAW_XXX/sample1.fastq | rawdata/mRseq/Hs/Li | sample1.fastq | fastq |
| /bio/results/dea/RES_YYY/heatmap.png | results/dea/RES_YYY | heatmap.png | png |

### 與 abbr_mapping 的配合使用

file_path 的值來源於 abbr_mapping 表的字段組合：

| abbr_mapping 字段 | 示例值 | 說明 |
|------------------|-------|------|
| d_a | rawdata | 數據類型縮寫 |
| o_a | Rs | 物種縮寫 |
| s_a | Hu | 組織縮寫 |
| t_a | Rt | 組織部位縮寫 |

完整 file_path 計算邏輯：
```
file_path = {d_a}/{o_a}/{s_a}/{t_a}
           = rawdata/Rs/Hu/Rt
```

### 字段更新 SQL

```sql
-- 更新 file_record 表的字段注釋
ALTER TABLE file_record 
    MODIFY COLUMN file_path VARCHAR(500) COMMENT '相對於 /bio 的路徑，不包含文件名',
    MODIFY COLUMN file_name VARCHAR(500) COMMENT '完整文件名，包含擴展名',
    MODIFY COLUMN file_type VARCHAR(50) COMMENT '文件擴展名（小寫）';
```

---

## 7.9 後台實現邏輯

### 7.9.1 獲取已導入項目列表

```python
@bp.route('/api/files/imported-projects', methods=['GET'])
def get_imported_projects():
    """獲取已導入項目列表
    
     Args:
        file_project_type: 項目類型篩選 (raw/result/None)
        file_project_ids: 逗號分隔的項目編號列表
    
    Returns:
        JSON: 項目信息列表
    """
    file_project_type = request.args.get('file_project_type')
    file_project_ids = request.args.get('file_project_ids')
    
    # 解析項目編號列表
    project_id_list = []
    if file_project_ids:
        # 支持中英文逗號分隔
        project_id_list = [pid.strip() for pid in file_project_ids.replace('，', ',').split(',')]
        project_id_list = [pid for pid in project_id_list if pid]  # 過濾空字符串
    
    # 查詢 file_record 獲取符合條件的 project_id 和 project_type
    base_query = """
        SELECT DISTINCT file_project_id, file_project_type 
        FROM file_record 
        WHERE 1=1
    """
    params = []
    
    if file_project_type:
        base_query += " AND file_project_type = %s"
        params.append(file_project_type)
    
    if project_id_list:
        placeholders = ','.join(['%s'] * len(project_id_list))
        base_query += f" AND file_project_id IN ({placeholders})"
        params.extend(project_id_list)
    
    records = db.query(base_query, params)
    
    # 根據 project_type 查詢對應項目表
    projects = []
    for record in records:
        proj_id = record['file_project_id']
        proj_type = record['file_project_type']
        
        if proj_type == 'raw':
            row = db.query_one("""
                SELECT raw_id, raw_title, created_at, raw_file_count 
                FROM raw_project WHERE raw_id = %s
            """, (proj_id,))
            if row:
                projects.append({
                    'project_id': row['raw_id'],
                    'project_type': 'raw',
                    'title': row['raw_title'],
                    'created_at': row['created_at'].strftime('%Y-%m-%d %H:%M:%S') if row['created_at'] else None,
                    'file_count': row['raw_file_count'] or 0
                })
        else:  # result
            row = db.query_one("""
                SELECT results_id, results_title, created_at, results_file_count 
                FROM result_project WHERE results_id = %s
            """, (proj_id,))
            if row:
                projects.append({
                    'project_id': row['results_id'],
                    'project_type': 'result',
                    'title': row['results_title'],
                    'created_at': row['created_at'].strftime('%Y-%m-%d %H:%M:%S') if row['created_at'] else None,
                    'file_count': row['results_file_count'] or 0
                })
    
    return jsonify({
        'success': True,
        'data': projects,
        'total': len(projects)
    })
```

### 7.9.2 獲取項目文件列表

```python
@bp.route('/api/files', methods=['GET'])
def get_project_files():
    """獲取指定項目的文件列表
    
    Args:
        project_id: 項目編號 (必填)
    
    Returns:
        JSON: 文件信息列表
    """
    project_id = request.args.get('project_id')
    
    if not project_id:
        return jsonify({
            'success': False,
            'message': '缺少項目編號'
        }), 400
    
    # 查詢 file_record 獲取文件列表
    files = db.query("""
        SELECT id, file_name, file_size, file_type, imported_at
        FROM file_record 
        WHERE file_project_id = %s
        ORDER BY imported_at DESC
    """, (project_id,))
    
    # 格式化文件大小和時間
    for f in files:
        f['imported_at'] = f['imported_at'].strftime('%Y-%m-%d %H:%M:%S') if f['imported_at'] else None
    
    return jsonify({
        'success': True,
        'project_id': project_id,
        'files': files,
        'total': len(files)
    })
```

### 7.9.3 刪除文件

```python
@bp.route('/api/files', methods=['DELETE'])
def delete_files():
    """刪除指定的文件
    
    請求體:
        file_ids: 文件ID列表
    
    Returns:
        JSON: 刪除結果
    """
    data = request.get_json()
    file_ids = data.get('file_ids', [])
    
    if not file_ids:
        return jsonify({
            'success': False,
            'message': '缺少文件ID'
        }), 400
    
    # 查詢要刪除的文件信息
    placeholders = ','.join(['%s'] * len(file_ids))
    files = db.query(f"""
        SELECT id, file_path, file_name 
        FROM file_record 
        WHERE id IN ({placeholders})
    """, file_ids)
    
    if not files:
        return jsonify({
            'success': False,
            'message': '未找到要刪除的文件'
        }), 404
    
    # 移動文件到回收站
    recycle_base = Path('/bio/recycle')
    for f in files:
        src_path = Path('/bio') / f['file_path'] / f['file_name']
        dst_dir = recycle_base / f['file_path']
        dst_path = dst_dir / f['file_name']
        
        # 創建目標目錄
        dst_dir.mkdir(parents=True, exist_ok=True)
        
        # 移動文件
        if src_path.exists():
            shutil.move(str(src_path), str(dst_path))
    
    # 刪除數據庫記錄
    db.execute(f"""
        DELETE FROM file_record 
        WHERE id IN ({placeholders})
    """, file_ids)
    
    return jsonify({
        'success': True,
        'message': '刪除成功',
        'deleted_count': len(files)
    })
```

### 7.9.4 下載文件

```python
@bp.route('/api/files/download', methods=['POST'])
def download_files():
    """下載指定的文件
    
    請求體:
        file_ids: 文件ID列表
    
    Returns:
        ZIP 文件流
    """
    data = request.get_json()
    file_ids = data.get('file_ids', [])
    
    if not file_ids:
        return jsonify({
            'success': False,
            'message': '缺少文件ID'
        }), 400
    
    # 查詢要下載的文件信息
    placeholders = ','.join(['%s'] * len(file_ids))
    files = db.query(f"""
        SELECT id, file_path, file_name 
        FROM file_record 
        WHERE id IN ({placeholders})
    """, file_ids)
    
    if not files:
        return jsonify({
            'success': False,
            'message': '未找到要下載的文件'
        }), 404
    
    # 創建 ZIP 文件
    memory_file = io.BytesIO()
    with zipfile.ZipFile(memory_file, 'w', zipfile.ZIP_DEFLATED) as zf:
        for f in files:
            file_path = Path('/bio') / f['file_path'] / f['file_name']
            if file_path.exists():
                zf.write(str(file_path), f['file_name'])
    
    memory_file.seek(0)
    
    # 返回 ZIP 文件
    return send_file(
        memory_file,
        mimetype='application/zip',
        as_attachment=True,
        download_name='download.zip'
    )
```

---

## 附錄

### 附錄A: 文件大小格式化函數

```javascript
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    const k = 1024;
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + units[i];
}
```

### 附錄B: 項目編號解析函數

```javascript
function parseProjectIds(input) {
    if (!input || !input.trim()) {
        return [];
    }
    // 支持中文逗號和英文逗號
    return input
        .split(/[,，]/)
        .map(id => id.trim())
        .filter(id => id.length > 0);
}
```

### 附錄C: 日期格式化函數

```python
def format_datetime(dt):
    """格式化日期時間為字符串"""
    if dt is None:
        return None
    return dt.strftime('%Y-%m-%d %H:%M:%S')
```

### 附錄D: 文件類型識別

```python
import os

def get_file_type(filename):
    """根據文件名獲取文件類型擴展名"""
    _, ext = os.path.splitext(filename)
    return ext[1:].lower() if ext else ''  # 移除前導點並轉為小寫

def get_file_name_with_ext(filepath):
    """從完整路徑中獲取包含擴展名的文件名"""
    return os.path.basename(filepath)
```

---

## 版本歷史

| 版本 | 日期 | 修改內容 |
|------|------|---------|
| 1.0 | 2026-01-21 | 初始版本，完整描述文件管理模塊設計 |
