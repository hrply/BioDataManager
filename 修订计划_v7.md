# BioData Manager 综合修订计划 v7

## 修订日期: 2026-01-23

## 当前状态评估

### 已发现问题（需修复）
1. **一次导入生成多个文件夹** - 同一个项目ID在多个路径出现
2. **UNK文件夹问题** - 旧数据使用UNK路径
3. **file_property格式错误** - 使用中文完整名称而非label
4. **file_path路径错误** - 未使用正确的缩写路径
5. **元数据追加逻辑问题** - 字段值追加不符合设计规范

---

## 第一阶段：问题诊断与根因分析

### 1.1 检查文件导入的模态框可编辑字段
**目标**: 确认前端导入模态框中可编辑的元数据字段

**执行步骤**:
1. 检查 `files.html` 中 `loadMetadataFields()` 函数
2. 检查 `renderMetadataFields()` 和 `renderEditableMetadataFields()` 函数
3. 记录可编辑字段列表
4. 确认字段是否与 `field_config` 表一致

**预期结果**: 
- 新建项目时可编辑字段: raw_type, raw_species, raw_tissue, raw_keywords
- 导入至已有项目时可编辑字段: 同上（除raw_id, raw_title外）

### 1.2 检查导入至已有项目的元数据追加逻辑
**目标**: 确认元数据字段是否按设计规范正确追加

**执行步骤**:
1. 检查前端 `getFormData()` 函数（新建项目）
2. 检查前端导入至已有项目的 `metadata_override` 逻辑
3. 检查后端 `_import_raw_files()` 和 `_import_result_files()` 函数
4. 验证多值字段（raw_tissue, results_raw）的追加逻辑

**设计规范要求**:
- 多值字段使用逗号分隔（支持中英文）
- 追加时去重
- 新值与已有值合并

**预期结果**:
- `raw_tissue` 正确追加新值（如 "Heart muscle,Pancreas"）
- `results_raw` 正确追加新值并排序

### 1.3 检查一次导入生成多个文件夹的问题
**目标**: 找出重复生成文件夹的根因

**执行步骤**:
1. 检查后端 `_import_raw_files()` 的路径生成逻辑
2. 检查是否存在循环调用或重复调用
3. 检查项目创建与文件导入的时序问题
4. 检查 `import_download_files()` 函数的调用逻辑

**预期结果**: 每次导入只生成一个文件夹路径

### 1.4 检查 UNK 文件夹生成原因
**目标**: 确认 UNK 文件夹的生成条件

**执行步骤**:
1. 检查 `get_abbr()` 函数的默认逻辑
2. 检查 `abbr_mapping` 表中是否缺少某些字段的映射
3. 检查 `results_type` 字段的缩写映射

**预期结果**: 所有字段都能正确获取缩写，不生成 UNK 文件夹

### 1.5 检查 file_record 表数据正确性
**目标**: 确认 file_path 和 file_property 字段值正确

**执行步骤**:
1. 检查后端写入 file_record 的逻辑
2. 验证 `file_path` 使用缩写路径
3. 验证 `file_property` 使用 label 格式

**预期结果**:
- `file_path`: `rawdata/mRseq/Hs/Hea/RAW_xxx`
- `file_property`: `转录组-人类-Esophagus (食管)`

---

## 第二阶段：代码修复

### 2.1 属性生成函数实现
**文件**: `app/backend.py`

**新增函数**:
```python
def generate_file_property(self, field_values: Dict, field_options: Dict) -> str:
    """
    生成 file_property 属性值
    
    原始数据格式: 数据类型-物种-[组织来源]
    结果数据格式: 分析类型-[关联项目编号]
    """
    # 实现逻辑...
```

**修改位置**:
- `_import_raw_files()` - 生成原始数据 file_property
- `_import_result_files()` - 生成结果数据 file_property

### 2.2 字段 options 配置
**文件**: `app/init_db.py`

**添加配置**:
```python
FIELD_OPTIONS_LABELS = {
    'raw_type': [
        {'label': '转录组', 'value': 'mRNAseq'},
        {'label': '表观转录组', 'value': 'epitRNAseq'},
        {'label': '蛋白组', 'value': '蛋白组'},
        {'label': '泛素化组', 'value': '泛素化组'},
        # ... 其他选项
    ],
    'raw_species': [
        {'label': '人类', 'value': 'Homo sapiens'},
        {'label': '小鼠', 'value': 'Mus musculus'},
        # ... 其他选项
    ],
    'raw_tissue': [
        {'label': 'Esophagus (食管)', 'value': 'Esophagus'},
        {'label': 'Liver (肝脏)', 'value': 'Liver'},
        # ... 其他选项
    ],
    'results_type': [
        {'label': 'Marker', 'value': 'Marker'},
        {'label': 'Co-IP MS', 'value': 'Co-IP MS'},
        # ... 其他选项
    ]
}
```

### 2.3 多值字段处理函数
**新增函数**:
```python
def parse_multi_value(self, value: str) -> List[str]:
    """解析多值字段，支持中英文逗号分隔"""

def sort_project_ids(self, ids: List[str]) -> List[str]:
    """对项目编号进行文本排序"""
```

---

## 第三阶段：页面样式调整

### 3.1 项目详情页面宽度
**文件**: `app/templates/raw_data.html`, `app/templates/results.html`

**修改**: 将项目详情容器宽度调整为75%
```html
<div class="container-fluid" style="max-width: 75%;">
```

---

## 第四阶段：设计文档更新

### 4.1 更新文件
- `docs/数据库设计规范.md` - 添加 file_property 说明
- `docs/应用功能设计.md` - 更新属性生成逻辑

### 4.2 新增内容
```
file_property 字段规范:
- 原始数据格式: {数据类型label}-{物种label}-[{组织来源label}]
- 结果数据格式: {分析类型label}-[{关联项目编号排序拼接}]
- 使用元数据字段的 label 值而非 value 值
- 关联项目编号按文本排序后直接拼接（无分隔符）
```

---

## 第五阶段：测试验证

### 5.1 文件夹生成测试
- [ ] 新建原始数据项目导入 → 检查单一路径
- [ ] 新建结果数据项目导入 → 检查单一路径
- [ ] 导入至已有项目 → 不生成新文件夹
- [ ] 验证不生成 UNK 文件夹
- [ ] 验证不生成重复文件夹

### 5.2 file_property 格式测试
- [ ] 原始数据: `转录组-人类-Esophagus (食管)`
- [ ] 原始数据（无组织）: `转录组-人类`
- [ ] 结果数据: `Marker-RAW_2BRAW_a8RAW_A1`
- [ ] 多关联项目排序: `RAW_a8,RAW_A1,RAW_2B` → `RAW_2BRAW_a8RAW_A1`

### 5.3 元数据追加测试
- [ ] raw_tissue 正确追加
- [ ] results_raw 正确追加并排序
- [ ] 导入后数据库字段值验证

### 5.4 页面样式测试
- [ ] 项目详情页面宽度为75%
- [ ] 页面布局正常显示

---

## 执行顺序

| 顺序 | 任务 | 状态 |
|-----|------|------|
| 1 | 问题诊断：检查导入模态框可编辑字段 | 待执行 |
| 2 | 问题诊断：检查元数据追加逻辑 | 待执行 |
| 3 | 问题诊断：检查重复文件夹根因 | 待执行 |
| 4 | 问题诊断：检查 UNK 文件夹原因 | 待执行 |
| 5 | 问题诊断：检查 file_record 数据 | 待执行 |
| 6 | 修复：实现属性生成函数 | 待执行 |
| 7 | 修复：添加字段 options 配置 | 待执行 |
| 8 | 修复：多值字段处理函数 | 待执行 |
| 9 | 样式：调整页面宽度为75% | 待执行 |
| 10 | 文档：更新设计文档 | 待执行 |
| 11 | 测试：全面验证 | 待执行 |

---

## 检查项清单

### 诊断阶段检查项
- [ ] 检查前端导入模态可编辑字段列表
- [ ] 检查元数据追加逻辑是否符合设计规范
- [ ] 检查一次导入是否生成多个文件夹
- [ ] 检查是否生成 UNK 开头的文件夹
- [ ] 检查 file_path 路径格式是否正确
- [ ] 检查 file_property 格式是否正确
- [ ] 检查 file_property 是否使用 label 而非 value
- [ ] 检查多值字段（raw_tissue, results_raw）处理
- [ ] 检查关联项目编号排序逻辑

### 验证阶段检查项
- [ ] 验证路径使用缩写（mRseq, Hs, Hea）
- [ ] 验证属性使用完整 label（转录组, 人类）
- [ ] 验证不生成 UNK 文件夹
- [ ] 验证不生成重复文件夹
- [ ] 验证关联项目编号按文本排序

---

## 修订历史

| 版本 | 日期 | 内容 |
|-----|------|------|
| v6 | 2026-01-23 | 初始计划 |
| v7 | 2026-01-23 | 补充问题诊断阶段，完善检查项清单 |
