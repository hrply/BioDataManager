# BioData Manager 修订计划 v6

## 修订日期: 2026-01-23

---

## 一、页面样式调整

### 1.1 项目详情页面宽度调整
- **文件**: `app/templates/raw_data.html`, `app/templates/results.html`
- **修改**: 将项目详情页面容器宽度从默认调整为页面宽度的75%
- **目标**: 提升大屏幕下的显示效果

---

## 二、file_property 属性生成逻辑重构

### 2.1 原始数据文件属性格式
**格式**: `数据类型-物种-[组织来源]`

**示例**:
- `转录组-人类-Esophagus (食管)`
- `转录组-人类`
- `泛素化组-小鼠`

**说明**:
- 使用字段的 **label** 而非 **value**
- 组织来源是可选的
- 多个组织来源时用逗号分隔

### 2.2 结果数据文件属性格式
**格式**: `分析类型-[关联项目编号]`

**示例**:
- `Marker-RAW_2BRAW_a8RAW_A1`
- `Marker`

**说明**:
- 使用字段的 **label** 而非 **value**
- 关联项目编号是可选的
- 多个项目编号按**文本排序**后直接拼接（无分隔符）
- 支持中英文逗号分隔

### 2.3 需修改的后端逻辑
- **文件**: `app/backend.py`
- **新增函数**: `generate_file_property(field_id, field_value, field_options) -> str`
- **修改函数**: `_import_raw_files()`, `_import_result_files()`

---

## 三、数据库初始化代码更新

### 3.1 字段配置补充
- **文件**: `app/init_db.py`
- **说明**: 添加字段 options 的 label-value 映射配置
- **影响字段**:
  - `raw_type` - 数据类型
  - `raw_species` - 物种
  - `raw_tissue` - 组织来源
  - `results_type` - 分析类型
  - `results_raw` - 关联项目编号

### 3.2 需添加的配置
```python
# raw_type 字段选项 (label -> value)
'raw_type': [
    {'label': '转录组', 'value': 'mRNAseq'},
    {'label': '长读长转录组', 'value': 'Long-Read RNAseq'},
    {'label': '表观转录组', 'value': 'epitRNAseq'},
    {'label': '蛋白组', 'value': '蛋白组'},
    {'label': '泛素化组', 'value': '泛素化组'},
    # ... 其他选项
]

# raw_species 字段选项
'raw_species': [
    {'label': '人类', 'value': 'Homo sapiens'},
    {'label': '小鼠', 'value': 'Mus musculus'},
    {'label': '大鼠', 'value': 'Rattus norvegicus'},
    # ... 其他选项
]

# results_type 字段选项
'results_type': [
    {'label': 'Marker', 'value': 'Marker'},
    {'label': 'Co-IP MS', 'value': 'Co-IP MS'},
    # ... 其他选项
]
```

---

## 四、设计文档更新

### 4.1 更新文件
- `docs/数据库设计规范.md` - 添加 file_property 字段说明
- `docs/应用功能设计.md` - 更新属性生成逻辑说明

### 4.2 新增说明内容
```
file_property 字段说明:
- 用于文件属性展示，支持排序和筛选
- 原始数据格式: 数据类型-物种-[组织来源]
- 结果数据格式: 分析类型-[关联项目编号]
- 使用元数据字段的 label 值而非 value 值
```

---

## 五、测试计划

### 5.1 内测场景
1. **新建项目导入原始数据**
   - 验证路径生成: `/bio/rawdata/{abbr}/{abbr}/{abbr}/{project_id}`
   - 验证 file_property 格式正确

2. **新建项目导入结果数据**
   - 验证路径生成: `/bio/results/{abbr}/{project_id}`
   - 验证 file_property 格式正确

3. **导入至已有项目**
   - 验证元数据字段正确追加
   - 验证 file_property 正确更新

4. **多值字段处理**
   - 多个组织来源: `Esophagus,Colon`
   - 多个关联项目: `RAW_a8,RAW_A1,RAW_2B` -> 排序后拼接

### 5.2 验证要点
- [ ] 文件夹路径使用缩写 (如 `mRseq`, `Hs`)
- [ ] file_property 使用完整 label (如 `转录组-人类`)
- [ ] 不生成 UNK 开头的文件夹
- [ ] 不生成重复文件夹
- [ ] 关联项目编号按文本排序后拼接

---

## 六、待确认事项

- [ ] 页面宽度调整为 75% 是否合适？
- [ ] file_property 中是否需要保留括号等特殊字符？
- [ ] 是否需要为现有数据提供迁移脚本？

---

## 七、执行顺序

1. 创建计划文件并确认 ← **当前步骤**
2. 更新 `init_db.py` - 添加字段 options 配置
3. 更新 `backend.py` - 实现属性生成逻辑
4. 更新页面模板 - 调整宽度
5. 更新设计文档
6. 重新初始化数据库
7. 内测验证

---

## 修订历史

| 版本 | 日期 | 内容 |
|-----|------|------|
| v5 | 2026-01-22 | 初始版本，修复前端字段获取问题 |
| v6 | 2026-01-23 | file_property 逻辑重构，页面样式调整 |
